# Read Master - Development Progress

Started: 2026-01-17

## Iteration 1

[2026-01-17] infra-001: Created pnpm monorepo structure with workspace configuration
- Created pnpm-workspace.yaml defining apps/* and packages/* workspaces
- Updated root package.json with workspace scripts (dev, build, lint, typecheck, test)
- Created .npmrc with appropriate pnpm settings
- Created directory structure: apps/web, apps/api, packages/database, packages/shared, packages/ai, packages/config
- Created placeholder package.json files for all 6 workspace packages
- pnpm install runs successfully (3 dependencies installed: husky, prettier, typescript)
- All 7 workspace projects recognized by pnpm
- Feedback loops pass (typecheck, lint, test - placeholders)
- Files: pnpm-workspace.yaml, package.json, .npmrc, apps/*/package.json, packages/*/package.json

## Iteration 2

[2026-01-17] infra-002: Set up TypeScript configuration with strict mode for monorepo
- Created root tsconfig.json with strict mode and project references
- Created packages/config/tsconfig/ with shared TypeScript configurations:
  - base.json: Core strict TypeScript settings (strict: true, noUnusedLocals, noUncheckedIndexedAccess, etc.)
  - react.json: Extends base with React JSX support
  - node.json: Extends base for Node.js/serverless packages
  - library.json: Extends base for shared library packages
- Created tsconfig.json for all 6 workspace packages extending shared configs
- Configured path aliases (@/* -> ./src/*) for apps/web and apps/api
- Added typescript as devDependency to all packages
- Added @read-master/config workspace dependency to packages needing shared configs
- Created placeholder TypeScript source files (src/index.ts) for all packages
- Updated typecheck scripts to use real `tsc --noEmit` instead of placeholders
- pnpm typecheck passes with no errors across all 6 packages
- All feedback loops pass (typecheck, lint, test)
- Files: tsconfig.json, packages/config/tsconfig/*.json, */tsconfig.json, */src/index.ts

## Iteration 3

[2026-01-17] infra-003: Configure ESLint and Prettier with shared configs
- Installed ESLint dependencies in root package.json (@eslint/js, eslint, globals, typescript-eslint)
- Created packages/config/eslint/ with shared ESLint configurations:
  - base.js: Core TypeScript rules with strict settings (no-console, consistent-type-imports, no-unused-vars, etc.)
  - react.js: Extends base with React/JSX support and browser globals
  - node.js: Extends base with Node.js globals for backend packages
  - library.js: Extends base for shared packages (browser + node globals)
  - index.js: Re-exports all configurations
- Created packages/config/prettier/ with shared Prettier configuration:
  - index.js: Consistent formatting (semi, double quotes, 2-space indent, trailing commas, etc.)
- Updated packages/config/package.json with exports for eslint/* and prettier
- Updated root eslint.config.js to use shared config from @read-master/config
- Updated root prettier.config.js to use shared config from @read-master/config
- Created eslint.config.js for all workspace packages (web: react, api: node, database: node, shared: library, ai: library)
- Updated lint scripts in all packages from placeholders to `eslint .`
- Added `type: module` to root package.json to fix ESM module warning
- Added @read-master/config as workspace dependency to root package.json
- Ran pnpm format to fix formatting issues in markdown files
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test
- Files: packages/config/eslint/*.js, packages/config/prettier/index.js, */eslint.config.js, */package.json

## Iteration 4

[2026-01-17] infra-004: Configure Vitest testing framework for monorepo
- Created Ralph Wiggum workflow documentation (docs/RALPH_WIGGUM.md)
- Created PRD task registry (docs/prd.json) with infrastructure sprint tasks
- Installed Vitest ^3.0.0 as dev dependency in root package.json
- Created packages/config/vitest/ with shared Vitest configurations:
  - base.js: Core test settings (globals, node environment, passWithNoTests)
  - react.js: React test settings (jsdom environment, tsx support)
  - index.js: Re-exports createVitestConfig and createReactVitestConfig
- Updated packages/config/package.json with exports for vitest/*
- Created vitest.config.ts for all 5 testable packages:
  - apps/web: Uses createReactVitestConfig (jsdom)
  - apps/api: Uses createVitestConfig (node)
  - packages/shared: Uses createVitestConfig (node)
  - packages/database: Uses createVitestConfig (node)
  - packages/ai: Uses createVitestConfig (node)
- Updated test scripts in all packages from placeholders to `vitest run`
- Added vitest as devDependency to all testable packages
- Created first real utility functions in packages/shared/src/utils/string.ts:
  - truncate: String truncation with ellipsis
  - toTitleCase: Convert string to title case
  - slugify: Generate URL-friendly slugs
  - stripHtml: Remove HTML tags from string
- Created comprehensive tests in packages/shared/src/utils/string.test.ts (19 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test
- Files: docs/RALPH_WIGGUM.md, docs/prd.json, packages/config/vitest/*.js, */vitest.config.ts, packages/shared/src/utils/*

## Iteration 5

[2026-01-17] infra-005: Configure Husky pre-commit hooks
- Husky was already installed (v9.1.7) and initialized with .husky directory
- Installed lint-staged v16.2.7 as dev dependency at workspace root
- Configured lint-staged in package.json:
  - *.{ts,tsx,js,jsx}: eslint --fix, prettier --write
  - *.{json,md}: prettier --write
- Updated .husky/pre-commit hook with comprehensive checks:
  - Console.log detection in staged TypeScript/JavaScript files
  - lint-staged for efficient linting/formatting of staged files only
  - Full TypeScript type check (required for cross-file type safety)
  - Test execution to prevent committing breaking changes
- Hook prevents commits when any check fails (non-zero exit codes)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test
- Files: package.json, .husky/pre-commit

## Iteration 6

[2026-01-17] infra-006: Create environment configuration and .env.example
- Created comprehensive .env.example with all required environment variables:
  - Application settings (NODE_ENV, APP_URL, API_URL)
  - Database configuration (Vercel Postgres with connection pooling)
  - Cache configuration (Upstash Redis)
  - Authentication (Clerk publishable and secret keys)
  - AI providers (Anthropic Claude, OpenAI for TTS, ElevenLabs for premium TTS)
  - File storage (Cloudflare R2)
  - External APIs (Google Books)
  - Rate limiting and feature flags
  - Monitoring (Sentry, log levels)
- Created packages/shared/src/env/ module for environment validation:
  - schema.ts: Zod schemas for all environment variable groups
    - Modular schemas: database, redis, clerk, anthropic, openai, elevenlabs, r2, etc.
    - Complete serverEnvSchema and clientEnvSchema for app-specific validation
    - Type exports for all schemas
  - validate.ts: Validation utilities
    - validateEnv: Returns typed result with success/errors
    - validateEnvOrThrow: Fail-fast validation for app initialization
    - createEnvLoader: Lazy validation with caching
  - index.ts: Re-exports all schemas and utilities
- Added zod ^3.24.0 as dependency to packages/shared
- Added "./env" export to packages/shared/package.json
- Created comprehensive test suite (15 tests) in validate.test.ts:
  - Tests for validateEnv success and error cases
  - Tests for validateEnvOrThrow behavior
  - Tests for createEnvLoader caching
  - Tests for common validation patterns (URLs, prefixes, booleans, numbers)
- .env already in .gitignore (verified existing configuration)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (34 tests total)
- Files: .env.example, packages/shared/src/env/*.ts, packages/shared/package.json

## Iteration 7

[2026-01-17] infra-005: Create apps/web React + Vite + TypeScript app with dependencies
- Updated prd.json to mark infra-004 (Husky pre-commit hooks) as passes: true
- Transformed apps/web from placeholder to full React + Vite + TypeScript application
- Added production dependencies:
  - react ^18.3.1, react-dom ^18.3.1 (core React)
  - @mui/material ^6.4.0 (component library)
  - @emotion/react, @emotion/styled ^11.14.0 (MUI styling engine)
  - @tanstack/react-query ^5.64.0 (server state management)
  - zustand ^5.0.3 (client state management)
- Added dev dependencies:
  - vite ^6.0.7, @vitejs/plugin-react ^4.3.4 (build tooling)
  - @types/react, @types/react-dom ^18.3.x (type definitions)
- Created vite.config.ts with:
  - React plugin configured
  - Path alias (@/ -> ./src)
  - Dev server on port 3000
  - Production sourcemaps enabled
- Created tsconfig.node.json for Vite/Vitest config files
- Created index.html entry point with proper meta tags
- Created src/main.tsx with:
  - React 18 createRoot API
  - QueryClientProvider for React Query
  - ThemeProvider with basic MUI theme
  - CssBaseline for CSS normalization
- Created src/App.tsx with basic landing page using MUI components
- Verified: pnpm --filter web dev starts server at http://localhost:3000
- Verified: pnpm --filter web build produces dist/ (268KB gzipped: 88KB)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (34 tests)
- Files: apps/web/package.json, vite.config.ts, tsconfig.node.json, index.html, src/main.tsx, src/App.tsx

## Sprint 1 Summary

### Tasks Completed: 6/6
1. infra-001: pnpm monorepo structure
2. infra-002: TypeScript configuration with strict mode
3. infra-003: ESLint and Prettier shared configs
4. infra-004: Vitest testing framework
5. infra-005: Husky pre-commit hooks
6. infra-006: Environment configuration

### Discoveries Added: 0
No discoveries added during this sprint (foundational infrastructure work)

### Recommended Next Sprint Priorities
1. Database schema setup with Prisma ORM
2. Authentication setup with Clerk
3. API route scaffolding for apps/api
4. React + Vite setup for apps/web
5. Core shared types and Zod schemas

## Iteration 8

[2026-01-17] infra-006: Create apps/api Vercel serverless functions structure
- Transformed apps/api from placeholder to full Vercel serverless API structure
- Updated package.json with required dependencies:
  - zod ^3.24.0 (runtime validation)
  - winston ^3.17.0 (structured logging)
  - @vercel/node ^5.0.0 (Vercel function types)
  - @types/node ^22.10.0 (Node.js types)
- Created api/ directory for Vercel serverless functions:
  - api/health.ts: Health check endpoint returning service status, timestamp, version
- Created src/utils/ directory for shared API utilities:
  - src/utils/logger.ts: Winston-based structured logging with request/error/AI usage helpers
  - src/utils/response.ts: Standardized API response utilities (sendSuccess, sendPaginated, sendError)
  - src/utils/index.ts: Clean re-exports of all utilities
- Updated src/index.ts to export all utilities
- Updated vitest.config.ts to include api/**/*.test.ts files
- Created comprehensive test suites:
  - api/health.test.ts: 6 tests for health endpoint
  - src/utils/response.test.ts: 15 tests for response utilities
  - src/utils/logger.test.ts: 8 tests for logging utilities
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (63 tests total: 29 api + 34 shared)
- Files: apps/api/package.json, api/health.ts, src/utils/*.ts, vitest.config.ts

## Iteration 9

[2026-01-17] infra-007: Set up i18next with initial locale files for 6 languages
- Marked infra-009 (.env.example) as passes: true (work was already completed in Iteration 6)
- Installed i18next dependencies in apps/web:
  - i18next (core library)
  - react-i18next (React bindings)
  - i18next-browser-languagedetector (automatic language detection)
  - i18next-http-backend (translation file loading)
  - @mui/icons-material ^6.4.0 (for LanguageSwitcher icons)
- Created apps/web/src/locales/ directory with 6 translation files:
  - en.json: English (base language)
  - ar.json: Arabic (RTL language)
  - es.json: Spanish
  - ja.json: Japanese
  - zh.json: Chinese (Simplified)
  - tl.json: Tagalog
- Each locale file contains comprehensive translations for:
  - Common UI elements (buttons, loading states, errors)
  - Navigation and main menu
  - Home page and features
  - Library and book management
  - Reader interface and toolbar
  - Flashcards and SRS
  - Assessments
  - Forum
  - Settings (appearance, reading, language, privacy, notifications)
  - Language names in native scripts
  - Error messages
  - Accessibility labels
- Created apps/web/src/i18n/index.ts with:
  - Language configuration (supportedLanguages, rtlLanguages, languageNames)
  - RTL detection utilities (isRtlLanguage, getDocumentDirection)
  - Document direction management (updateDocumentDirection)
  - i18next initialization with language detection
  - Automatic RTL/LTR switching on language change
- Created apps/web/src/components/common/LanguageSwitcher.tsx:
  - MUI-based dropdown menu for language selection
  - Shows current language in native script
  - Displays both native and translated language names
  - Respects RTL direction for Arabic option
  - Accessible with proper ARIA attributes
- Updated apps/web/src/main.tsx to import i18n configuration
- Updated apps/web/src/App.tsx to use translations and include LanguageSwitcher
- Updated apps/web/tsconfig.json to include JSON files in compilation
- Created comprehensive test suite (12 tests) in apps/web/src/i18n/index.test.ts:
  - Tests for supportedLanguages array
  - Tests for rtlLanguages configuration
  - Tests for languageNames mapping
  - Tests for isRtlLanguage utility
  - Tests for getDocumentDirection utility
  - Tests for locale file key consistency across all 6 languages
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (75 tests total: 29 api + 34 shared + 12 web)
- Files: apps/web/package.json, apps/web/src/locales/*.json, apps/web/src/i18n/index.ts, apps/web/src/components/common/LanguageSwitcher.tsx, apps/web/src/App.tsx, apps/web/src/main.tsx, apps/web/tsconfig.json

## Iteration 10

[2026-01-17] infra-008: Create vercel.json with deployment and cron job configuration
- Created vercel.json in root with comprehensive Vercel deployment configuration:
  - Schema reference for IDE support
  - Version 2 configuration
  - pnpm install command for dependencies
  - Build configuration for apps/web (Vite static build) and apps/api (Vercel Node functions)
  - Route rewrites: /api/* -> apps/api/api/*, /* -> apps/web/dist/*
  - Cron jobs configured:
    - srs-reminders: Daily at 8:00 AM UTC (0 8 * * *)
    - streak-check: Daily at midnight UTC (0 0 * * *)
    - cleanup-expired: Weekly on Sundays at 3:00 AM UTC (0 3 * * 0)
  - Function configuration: 1024MB memory, 30s max duration
  - Region: iad1 (US East)
- Created apps/api/api/cron/ directory with three cron job endpoints:
  - srs-reminders.ts: Sends email reminders to users with due flashcards
  - streak-check.ts: Checks and updates user streaks, awards achievements
  - cleanup-expired.ts: Cleans up expired downloads, old audit logs, orphaned data
- All cron endpoints include:
  - CRON_SECRET authentication for security
  - Method validation (GET only for Vercel Cron)
  - Structured logging with Winston
  - Duration tracking
  - Comprehensive error handling
  - TODO placeholders for actual implementation when database is ready
- Created comprehensive test suites for each cron endpoint (18 new tests):
  - srs-reminders.test.ts: 6 tests
  - streak-check.test.ts: 6 tests
  - cleanup-expired.test.ts: 6 tests
- Added CRON_SECRET to .env.example with generation instructions
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (93 tests total: 47 api + 34 shared + 12 web)
- Files: vercel.json, apps/api/api/cron/srs-reminders.ts, apps/api/api/cron/streak-check.ts, apps/api/api/cron/cleanup-expired.ts, apps/api/api/cron/*.test.ts, .env.example

## Iteration 11

[2026-01-17] db-001: Set up Prisma in packages/database with initial configuration
- Transformed packages/database from placeholder to full Prisma ORM package
- Updated package.json with Prisma dependencies:
  - @prisma/client ^6.2.0 (runtime client)
  - prisma ^6.2.0 (development CLI)
  - tsx ^4.19.2 (for running seed scripts)
- Added database scripts to package.json:
  - db:generate: prisma generate
  - db:push: prisma db push
  - db:migrate: prisma migrate dev
  - db:migrate:deploy: prisma migrate deploy
  - db:studio: prisma studio
  - db:seed: tsx prisma/seed.ts
  - postinstall: prisma generate (auto-generate on install)
- Created prisma/ directory structure:
  - prisma/schema.prisma: Initial Prisma schema with PostgreSQL datasource
- Created initial schema with:
  - User model with all specified fields from spec
  - clerkId as unique identifier for Clerk auth
  - email and username unique constraints
  - UserTier enum (FREE, PRO, SCHOLAR)
  - Preferences as JSON field for flexibility
  - Privacy settings (profilePublic, showStats, showActivity)
  - AI preferences (aiEnabled)
  - Soft delete support (deletedAt)
  - Proper indexes on clerkId, email, username, deletedAt
- Created src/client.ts: Prisma client singleton
  - Prevents multiple instances during hot reloading
  - Configurable logging (verbose in development)
  - Exports connect/disconnect utilities
- Created src/index.ts: Clean exports
  - Re-exports prisma client and utilities
  - Re-exports all Prisma generated types
- Verified Prisma client generates successfully (prisma generate runs on postinstall)
- Created comprehensive test suite (8 tests) in src/client.test.ts:
  - Tests for prisma client export
  - Tests for common Prisma methods ($connect, $disconnect, $transaction)
  - Tests for user model accessor (findMany, findUnique, create, etc.)
  - Tests for utility functions (connect, disconnect)
  - Tests for singleton behavior
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (101 tests total: 47 api + 34 shared + 12 web + 8 database)
- Files: packages/database/package.json, packages/database/prisma/schema.prisma, packages/database/src/client.ts, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 12

[2026-01-17] db-002: Create User and authentication models in Prisma schema
- Enhanced User model with additional fields from specification:
  - Added displayName (String?) for public display name
  - Added bio (String? @db.Text) for user profile bio
  - Added timezone (String @default("UTC")) for user timezone for notifications/reminders
  - Added index on tier for tier-based queries
- Verified existing fields already match specification:
  - clerkId with @unique constraint for Clerk auth integration
  - email and username with @unique constraints
  - firstName, lastName, avatarUrl for profile data
  - UserTier enum (FREE, PRO, SCHOLAR) for subscription management
  - preferences as Json field for flexible user preferences
  - readingLevel (String?) for Lexile score tracking
  - preferredLang with @default("en") for language preference
  - Privacy settings: profilePublic, showStats, showActivity
  - AI preferences: aiEnabled @default(true)
  - Soft delete support via deletedAt (DateTime?)
  - Proper indexes on clerkId, email, username, deletedAt
  - stripeCustomerId for payment integration
  - tierExpiresAt for subscription expiry tracking
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (101 tests total: 47 api + 34 shared + 12 web + 8 database)
- Files: packages/database/prisma/schema.prisma

## Iteration 13

[2026-01-17] db-003: Create Book, Chapter, and content models in Prisma schema
- Created Book model with all fields from specification:
  - id (cuid), userId with relation to User
  - Metadata: title, author, description, coverImage
  - Source information: source (BookSource enum), sourceId, sourceUrl
  - File storage: filePath (R2 path), fileType (FileType enum)
  - Content metadata: language, wordCount, estimatedReadTime, lexileScore
  - Organization: genre, tags (String array)
  - Status: status (ReadingStatus enum), isPublic
  - Timestamps: createdAt, updatedAt, deletedAt (soft delete)
  - Relation to chapters
  - Indexes on userId, userId+status, userId+deletedAt, deletedAt, source, tags
- Created Chapter model with all fields from specification:
  - id (cuid), bookId with relation to Book
  - title, orderIndex (for ordering)
  - startPosition, endPosition (character offsets)
  - wordCount
  - createdAt timestamp
  - Indexes on bookId, bookId+orderIndex
- Created BookSource enum: UPLOAD, URL, PASTE, GOOGLE_BOOKS, OPEN_LIBRARY
- Created FileType enum: PDF, EPUB, DOC, DOCX, TXT, HTML
- Created ReadingStatus enum: WANT_TO_READ, READING, COMPLETED, ABANDONED
- Added User.books relation for User -> Book one-to-many relationship
- Added onDelete: Cascade to Book.user and Chapter.book relations
- Updated packages/database/src/index.ts with improved examples showing Book and Chapter usage
- Added 4 new tests for Book and Chapter model accessors
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (105 tests total: 47 api + 34 shared + 12 web + 12 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 14

[2026-01-17] db-004: Create ReadingProgress and Annotation models
- Created ReadingProgress model with all fields from specification:
  - id (cuid), userId and bookId with relations to User and Book
  - Position tracking: currentPosition (character offset), percentage (0-100)
  - Time tracking: totalReadTime (seconds), lastReadAt, startedAt, completedAt
  - Speed tracking: averageWpm (words per minute)
  - Timestamps: createdAt, updatedAt
  - @@unique([userId, bookId]) constraint for one progress record per user per book
  - Indexes on userId, bookId, userId+lastReadAt
- Created Annotation model with all fields from specification:
  - id (cuid), userId and bookId with relations to User and Book
  - type (AnnotationType enum: HIGHLIGHT, NOTE, BOOKMARK)
  - Position in text: startOffset, endOffset (character offsets)
  - Content: selectedText (Text), note (Text, max 5000 chars at app level), color (VarChar(7) for hex)
  - Visibility: isPublic (default false)
  - Timestamps: createdAt, updatedAt, deletedAt (soft delete)
  - Indexes on userId, bookId, userId+bookId, userId+type, deletedAt, bookId+startOffset
- Created AnnotationType enum: HIGHLIGHT, NOTE, BOOKMARK
- Added User relations: readingProgress[], annotations[]
- Added Book relations: readingProgress[], annotations[]
- Added onDelete: Cascade to all relations
- Updated packages/database/src/index.ts with examples for ReadingProgress upsert and Annotation create
- Added 4 new tests for ReadingProgress and Annotation model accessors
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (109 tests total: 47 api + 34 shared + 12 web + 16 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 15

[2026-01-17] db-005: Create PreReadingGuide and Assessment models
- Created PreReadingGuide model with all fields from specification:
  - id (cuid), bookId with @unique constraint (one guide per book)
  - Relation to Book with onDelete: Cascade
  - JSON fields for structured data:
    - vocabulary: Array of { term, definition, examples }
    - keyArguments: Array of { argument, explanation }
    - chapterSummaries: Array of { chapterIndex, summary }
    - keyThemes: Array of theme strings
    - readingTips: Array of tips for reading this book
    - discussionTopics: Suggested discussion questions
  - Text fields for contextual information:
    - historicalContext: Historical background
    - authorContext: About the author
    - intellectualContext: Intellectual/philosophical context
  - AI generation metadata: generatedAt, generatedBy, tokensUsed
  - Timestamps: createdAt, updatedAt
  - Index on bookId
- Created Assessment model with all fields from specification:
  - id (cuid), userId and bookId with relations to User and Book
  - type (AssessmentType enum: CHAPTER_CHECK, BOOK_ASSESSMENT, CUSTOM)
  - chapterIds: String[] for scoping assessment to specific chapters
  - JSON fields for questions and answers:
    - questions: Array of { id, type, question, options?, correctAnswer, bloomsLevel }
    - answers: Array of { questionId, userAnswer, isCorrect, feedback }
  - Scoring fields: score (0-100), totalQuestions, correctAnswers
  - bloomsBreakdown: JSON for Bloom's taxonomy distribution { remember, understand, apply, analyze, evaluate, create }
  - Timing fields: startedAt, completedAt, timeSpent
  - AI generation metadata: generatedBy, tokensUsed
  - Timestamps: createdAt, updatedAt
  - Indexes on userId, bookId, userId+bookId, userId+type, completedAt
- Created AssessmentType enum: CHAPTER_CHECK, BOOK_ASSESSMENT, CUSTOM
- Added User relation: assessments[]
- Added Book relations: preReadingGuide? (one-to-one), assessments[]
- Added onDelete: Cascade to all new relations
- Updated packages/database/src/index.ts with examples for PreReadingGuide upsert and Assessment create
- Added 4 new tests for PreReadingGuide and Assessment model accessors
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (113 tests total: 47 api + 34 shared + 12 web + 20 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 16

[2026-01-17] db-006: Create Flashcard and FlashcardReview models with SRS fields
- Created FlashcardType enum: VOCABULARY, CONCEPT, COMPREHENSION, QUOTE, CUSTOM
  - Covers all card types for vocabulary, concepts, reading comprehension, quotes, and user-created cards
- Created FlashcardStatus enum: NEW, LEARNING, REVIEW, SUSPENDED
  - Tracks card state through the SRS lifecycle
- Created Flashcard model with all SM-2 algorithm fields:
  - id (cuid), userId and bookId (optional) with relations to User and Book
  - Card content: front (VarChar 1000), back (Text for up to 5000 chars)
  - Card metadata: type (FlashcardType), status (FlashcardStatus), tags (String[])
  - Source reference: sourceChapterId, sourceOffset (for auto-generated cards)
  - SM-2 Algorithm fields:
    - easeFactor (Float, default 2.5, minimum 1.3 enforced at app level)
    - interval (Int, current interval in days)
    - repetitions (Int, number of successful repetitions)
    - dueDate (DateTime, next review date)
  - Statistics: totalReviews, correctReviews
  - Soft delete support via deletedAt
  - Relation to FlashcardReview[]
  - Indexes on userId, userId+status, userId+dueDate, userId+bookId, bookId, status, dueDate, deletedAt, tags
- Created FlashcardReview model for tracking each review:
  - id (cuid), flashcardId with relation to Flashcard
  - Review data: rating (1-4), responseTimeMs
  - SM-2 state before review: previousEaseFactor, previousInterval, previousRepetitions
  - SM-2 state after review: newEaseFactor, newInterval, newRepetitions
  - Timestamp: reviewedAt
  - Indexes on flashcardId, flashcardId+reviewedAt, reviewedAt
- Added User.flashcards relation for User -> Flashcard one-to-many
- Added Book.flashcards relation for Book -> Flashcard one-to-many (optional, with SetNull on delete)
- Updated packages/database/src/index.ts with:
  - Import examples for Flashcard, FlashcardReview, FlashcardType, FlashcardStatus types
  - Example for creating flashcard with SM-2 defaults
  - Example for fetching due flashcards for review
  - Example for recording a flashcard review
- Added 4 new tests for Flashcard and FlashcardReview model accessors
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (117 tests total: 47 api + 34 shared + 12 web + 24 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 17

[2026-01-17] db-007: Create UserStats, Achievement, and UserAchievement models
- Created UserStats model with all gamification fields from specification:
  - id (cuid), userId with @unique constraint (one stats record per user)
  - Relation to User with onDelete: Cascade
  - XP and Level: totalXP (Int), level (Int, default 1)
  - Streak tracking: currentStreak, longestStreak, lastActivityDate
  - Reading statistics: booksCompleted, totalReadingTime, totalWordsRead, averageWpm
  - Flashcard statistics: totalCardsReviewed, totalCardsCreated, averageRetention
  - Assessment statistics: assessmentsCompleted, averageScore
  - Social statistics: followersCount, followingCount
  - Timestamps: createdAt, updatedAt
  - Leaderboard indexes: totalXP, booksCompleted, currentStreak, longestStreak, totalReadingTime
- Created AchievementCategory enum: READING, LEARNING, SOCIAL, STREAK, MILESTONE, SPECIAL
- Created AchievementTier enum: COMMON, UNCOMMON, RARE, EPIC, LEGENDARY
- Created Achievement model with all fields from specification:
  - id (cuid), code with @unique constraint for identifying achievements
  - Metadata: name, description (Text), category (AchievementCategory)
  - Requirements: criteria (JSON) for flexible achievement conditions
  - Rewards: xpReward (Int), badgeIcon (String?), badgeColor (VarChar(7))
  - Rarity: tier (AchievementTier), sortOrder (Int)
  - Status: isActive (Boolean, default true)
  - Timestamps: createdAt, updatedAt
  - Relation to UserAchievement[]
  - Indexes on category, tier, isActive, sortOrder
- Created UserAchievement junction table:
  - id (cuid), userId and achievementId with relations to User and Achievement
  - onDelete: Cascade for both relations
  - Earning metadata: earnedAt, notified (Boolean), displayedAt (DateTime?)
  - @@unique([userId, achievementId]) constraint
  - Indexes on userId, achievementId, earnedAt, userId+earnedAt
- Added User relations: stats (UserStats?), achievements (UserAchievement[])
- Updated packages/database/src/index.ts with:
  - Import examples for UserStats, Achievement, UserAchievement types
  - Import examples for AchievementCategory, AchievementTier enums
  - Example for upserting user stats with XP increment
  - Example for fetching XP leaderboard with user privacy filter
  - Example for creating achievement definition
  - Example for awarding achievement to user
  - Example for fetching user's achievements with details
  - Added type exports for UserStats, Achievement, UserAchievement
- Added 6 new tests for UserStats, Achievement, and UserAchievement model accessors
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (123 tests total: 47 api + 34 shared + 12 web + 30 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 18

[2026-01-17] db-008: Create Curriculum, CurriculumItem, and CurriculumFollow models
- Created Visibility enum: PRIVATE, UNLISTED, PUBLIC
  - Controls who can see curriculum content
- Created Curriculum model with all fields from specification:
  - id (cuid), userId with relation to User, onDelete: Cascade
  - Metadata: title (VarChar 200), description (Text), coverImage (String?)
  - Categorization: category (VarChar 100), tags (String[]), difficulty (VarChar 50)
  - Visibility settings: visibility (Visibility enum, default PRIVATE)
  - Statistics (denormalized): totalItems, followersCount
  - Soft delete support via deletedAt
  - Relation to CurriculumItem[] and CurriculumFollow[]
  - Indexes on userId, userId+visibility, visibility, category, deletedAt, followersCount, tags
- Created CurriculumItem model with all fields from specification:
  - id (cuid), curriculumId with relation to Curriculum, onDelete: Cascade
  - orderIndex (Int) for maintaining order within curriculum (0-indexed)
  - bookId (String?) for optional reference to Book in system (onDelete: SetNull)
  - External resource fields: externalTitle, externalAuthor, externalUrl, externalIsbn
  - notes (Text) for curator's notes/instructions
  - estimatedTime (Int?) in minutes
  - isOptional (Boolean) for optional items
  - Timestamps: createdAt, updatedAt
  - Indexes on curriculumId, curriculumId+orderIndex, bookId
- Created CurriculumFollow model (junction table) with all fields from specification:
  - id (cuid), userId and curriculumId with relations to User and Curriculum
  - onDelete: Cascade for both relations
  - Progress tracking: currentItemIndex, completedItems, lastProgressAt
  - Timing: startedAt, completedAt
  - @@unique([userId, curriculumId]) constraint
  - Timestamps: createdAt, updatedAt
  - Indexes on userId, curriculumId, userId+completedAt
- Added User relations: curriculums[], curriculumFollows[]
- Added Book relation: curriculumItems[]
- Updated packages/database/src/index.ts with:
  - Import examples for Curriculum, CurriculumItem, CurriculumFollow, Visibility types
  - Example for creating a curriculum with metadata
  - Example for adding items to curriculum (both internal books and external resources)
  - Example for following a curriculum with progress tracking
  - Example for updating curriculum progress
  - Example for browsing public curriculums with filters
  - Added type exports for Curriculum, CurriculumItem, CurriculumFollow
- Added 6 new tests for Curriculum, CurriculumItem, and CurriculumFollow model accessors
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (129 tests total: 47 api + 34 shared + 12 web + 36 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 19

[2026-01-17] db-009: Create social models (Follow, ReadingGroup, GroupMember, GroupDiscussion)
- Created GroupRole enum: OWNER, ADMIN, MEMBER
  - Supports hierarchical permissions in reading groups
- Created Follow model with all fields from specification:
  - id (cuid), followerId and followingId with relations to User
  - Named relations: "Following" and "Followers" for bidirectional access
  - @@unique([followerId, followingId]) constraint to prevent duplicate follows
  - onDelete: Cascade for both relations
  - Indexes on followerId, followingId, createdAt
- Created ReadingGroup model with all fields from specification:
  - id (cuid), userId with relation to User (group owner)
  - Metadata: name (VarChar 200), description (Text), coverImage
  - Visibility: isPublic (Boolean), maxMembers (Int, default 50)
  - inviteCode: unique String for private group invitations
  - currentBookId: optional reference to Book being read (SetNull on delete)
  - Statistics (denormalized): membersCount, discussionsCount
  - Soft delete support via deletedAt
  - Indexes on userId, isPublic, deletedAt, membersCount, createdAt
- Created ReadingGroupMember junction table with all fields:
  - id (cuid), groupId and userId with relations
  - role (GroupRole enum, default MEMBER)
  - joinedAt timestamp
  - notificationsEnabled setting (Boolean, default true)
  - @@unique([groupId, userId]) constraint
  - onDelete: Cascade for both relations
  - Indexes on groupId, userId, groupId+role
- Created GroupDiscussion model with all fields:
  - id (cuid), groupId and userId with relations
  - Content: title (VarChar 300), content (Text)
  - Optional bookId reference (SetNull on delete)
  - Metadata: isPinned, isLocked flags
  - Statistics (denormalized): repliesCount, lastReplyAt
  - Soft delete support via deletedAt
  - Indexes on groupId, userId, bookId, groupId+isPinned, groupId+lastReplyAt, deletedAt
- Created DiscussionReply model with nested reply support:
  - id (cuid), discussionId and userId with relations
  - content (Text)
  - Nested replies via parentReplyId self-reference ("NestedReplies" relation)
  - childReplies[] relation for accessing nested replies
  - Soft delete support via deletedAt
  - onDelete: Cascade for discussion and parent reply relations
  - Indexes on discussionId, userId, parentReplyId, discussionId+createdAt, deletedAt
- Added User social relations:
  - following[] and followers[] for Follow relationship
  - ownedGroups[] for groups created by user
  - groupMemberships[] for groups user is member of
  - groupDiscussions[] for discussions created by user
  - discussionReplies[] for replies created by user
- Added Book social relations:
  - readingGroups[] for groups currently reading this book
  - groupDiscussions[] for discussions about this book
- Updated packages/database/src/index.ts with:
  - Import examples for Follow, ReadingGroup, ReadingGroupMember, GroupRole types
  - Import examples for GroupDiscussion, DiscussionReply types
  - Example for following/unfollowing users
  - Example for getting followers and following lists
  - Example for creating public and private reading groups
  - Example for managing group membership and roles
  - Example for creating and pinning discussions
  - Example for creating top-level and nested replies
  - Example for fetching replies with nested structure
  - Example for browsing public reading groups
  - Added type exports for all new social models
- Added 10 new tests for social model accessors:
  - Follow model accessor and query methods
  - ReadingGroup model accessor and query methods
  - ReadingGroupMember model accessor and query methods
  - GroupDiscussion model accessor and query methods
  - DiscussionReply model accessor and query methods
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (139 tests total: 47 api + 34 shared + 12 web + 46 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 20

[2026-01-17] db-011: Create system models: AIUsageLog and AuditLog
- Created AIUsageLog model for tracking AI API operations:
  - id (cuid), userId (optional for system-level operations)
  - Operation details: operation, model, provider
  - Token usage: promptTokens, completionTokens, totalTokens
  - Cost tracking: cost (Decimal(10, 6) for precision in USD)
  - Performance metrics: durationMs, success
  - Request context: bookId, requestId
  - Error tracking: errorCode, errorMessage (Text)
  - Metadata (JSON) for additional operation-specific data
  - Timestamp: createdAt
  - Indexes on userId, createdAt, userId+createdAt, operation, provider, success, bookId
- Created AuditLog model for security and compliance tracking:
  - id (cuid), userId (optional for system actions)
  - Action details: action (CREATE, UPDATE, DELETE, LOGIN, EXPORT, etc.)
  - Entity tracking: entityType, entityId
  - Change details: previousValue (JSON), newValue (JSON)
  - Request context: ipAddress, userAgent (Text), requestId, sessionId
  - Metadata (JSON) for additional context
  - Timestamp: createdAt
  - Indexes on userId, createdAt, userId+createdAt, entityType, entityType+entityId, action, entityType+action
- Updated packages/database/src/index.ts with:
  - Import examples for AIUsageLog, AuditLog types
  - Example for logging successful AI API calls with cost tracking
  - Example for logging failed AI calls with error details
  - Example for counting user's AI usage today (for rate limiting)
  - Example for aggregating monthly AI costs
  - Example for creating audit log entries for updates
  - Example for logging delete actions with previous state
  - Example for querying entity history
  - Example for querying recent user actions (security review)
  - Example for compliance auditing (all DELETE actions)
  - Added type exports for AIUsageLog, AuditLog
- Added 4 new tests for system model accessors:
  - AIUsageLog model accessor and query methods
  - AuditLog model accessor and query methods
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (143 tests total: 47 api + 34 shared + 12 web + 50 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 21

[2026-01-17] db-010: Create forum models: ForumCategory, ForumPost, ForumReply, ForumVote
- Created ForumCategory model for organizing forum posts:
  - id (cuid), slug with @unique constraint for URL-friendly identifiers
  - Metadata: name (VarChar 100), description (Text), icon, color (VarChar 7 for hex)
  - Settings: sortOrder, isActive, isLocked, minTierToPost (UserTier)
  - Statistics (denormalized): postsCount, lastPostAt, lastPostId, lastPostAuthorId
  - Timestamps: createdAt, updatedAt
  - Relation to ForumPost[]
  - Indexes on slug, sortOrder, isActive, lastPostAt
- Created ForumPost model with voting and view tracking:
  - id (cuid), categoryId and userId with relations to ForumCategory and User
  - Content: title (VarChar 200), content (Text)
  - Optional bookId reference for book-specific discussions
  - Post metadata: isPinned, isLocked, isFeatured, isAnswered (for Q&A posts)
  - Voting fields: upvotes, downvotes, voteScore (denormalized for sorting)
  - Statistics: viewCount, repliesCount, lastReplyAt, lastReplyId
  - Soft delete support via deletedAt
  - Relation to ForumReply[] and ForumVote[]
  - Indexes on categoryId, userId, bookId, categoryId+isPinned, categoryId+voteScore, categoryId+createdAt, categoryId+lastReplyAt, voteScore, viewCount, deletedAt, createdAt
- Created ForumReply model with nested replies and voting support:
  - id (cuid), postId and userId with relations to ForumPost and User
  - Content: content (Text)
  - Nested reply support via parentReplyId self-reference ("NestedForumReplies" relation)
  - childReplies[] relation for accessing nested replies
  - Reply metadata: isBestAnswer, isEdited
  - Voting fields: upvotes, downvotes, voteScore
  - Soft delete support via deletedAt
  - onDelete: Cascade for post and parent reply relations
  - Relation to ForumVote[]
  - Indexes on postId, userId, parentReplyId, postId+createdAt, postId+voteScore, voteScore, isBestAnswer, deletedAt
- Created ForumVote model for upvote/downvote system:
  - id (cuid), userId with relation to User
  - Vote target: postId (optional) and replyId (optional) - one must be set
  - Relations to ForumPost and ForumReply with named relations "PostVotes" and "ReplyVotes"
  - value field: 1 for upvote, -1 for downvote
  - @@unique([userId, postId]) constraint for one vote per user per post
  - @@unique([userId, replyId]) constraint for one vote per user per reply
  - onDelete: Cascade for all relations
  - Timestamps: createdAt, updatedAt
  - Indexes on userId, postId, replyId, value
- Added User relations: forumPosts[], forumReplies[], forumVotes[]
- Added Book relation: forumPosts[] for book-specific forum discussions
- Updated packages/database/src/index.ts with:
  - Import examples for ForumCategory, ForumPost, ForumReply, ForumVote types
  - Example for creating a forum category
  - Example for listing active forum categories
  - Example for creating a forum post with optional book reference
  - Example for listing posts in a category with sorting options
  - Example for incrementing view count
  - Example for getting a post with nested replies
  - Example for creating top-level and nested replies
  - Example for marking a reply as best answer
  - Example for upvoting a post and updating vote counts
  - Example for downvoting a reply
  - Example for changing a vote
  - Example for removing a vote
  - Example for getting popular posts sorted by vote score
  - Example for getting unanswered posts
  - Example for searching posts by title or content
  - Example for soft deleting a post
  - Added type exports for ForumCategory, ForumPost, ForumReply, ForumVote
- Added 8 new tests for forum model accessors:
  - ForumCategory model accessor and query methods
  - ForumPost model accessor and query methods
  - ForumReply model accessor and query methods
  - ForumVote model accessor and query methods
- Ran prisma format to validate schema (succeeded)
- Ran prisma generate to verify client generation (succeeded)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (151 tests total: 47 api + 34 shared + 12 web + 58 database)
- Files: packages/database/prisma/schema.prisma, packages/database/src/index.ts, packages/database/src/client.test.ts

## Iteration 22

[2026-01-17] db-012: Create and run initial Prisma migration
- Created initial Prisma migration using `prisma migrate diff` command
- Created prisma/migrations/00000000000000_initial_schema/migration.sql (37KB)
- Migration creates all 26 database tables:
  - User, Book, Chapter, ReadingProgress, Annotation
  - PreReadingGuide, Assessment, Flashcard, FlashcardReview
  - UserStats, Achievement, UserAchievement
  - Curriculum, CurriculumItem, CurriculumFollow
  - Follow, ReadingGroup, ReadingGroupMember
  - GroupDiscussion, DiscussionReply
  - ForumCategory, ForumPost, ForumReply, ForumVote
  - AIUsageLog, AuditLog
- Migration creates all 12 enums:
  - UserTier (FREE, PRO, SCHOLAR)
  - BookSource (UPLOAD, URL, PASTE, GOOGLE_BOOKS, OPEN_LIBRARY)
  - FileType (PDF, EPUB, DOC, DOCX, TXT, HTML)
  - ReadingStatus (WANT_TO_READ, READING, COMPLETED, ABANDONED)
  - AnnotationType (HIGHLIGHT, NOTE, BOOKMARK)
  - AssessmentType (CHAPTER_CHECK, BOOK_ASSESSMENT, CUSTOM)
  - FlashcardType (VOCABULARY, CONCEPT, COMPREHENSION, QUOTE, CUSTOM)
  - FlashcardStatus (NEW, LEARNING, REVIEW, SUSPENDED)
  - AchievementCategory (READING, LEARNING, SOCIAL, STREAK, MILESTONE, SPECIAL)
  - AchievementTier (COMMON, UNCOMMON, RARE, EPIC, LEGENDARY)
  - Visibility (PRIVATE, UNLISTED, PUBLIC)
  - GroupRole (OWNER, ADMIN, MEMBER)
- Migration creates 140+ indexes for optimal query performance
- Migration creates 15+ unique constraints for data integrity
- Migration creates 45+ foreign key constraints with appropriate ON DELETE actions
- Created comprehensive test suite for migration validation (68 tests):
  - Tests for migration directory structure
  - Tests for all 12 enum creation statements
  - Tests for all 26 table creation statements
  - Tests for unique constraints
  - Tests for indexes on frequently queried fields
  - Tests for foreign key relationships
- Updated vitest.config.ts to include prisma/**/*.test.ts
- Ran prisma format to validate schema
- Ran prisma generate to verify client generation
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (219 tests total: 47 api + 34 shared + 12 web + 126 database)
- Files: packages/database/prisma/migrations/00000000000000_initial_schema/migration.sql, packages/database/prisma/migrations.test.ts, packages/database/vitest.config.ts

## Iteration 23

[2026-01-17] db-013: Create seed script with sample data
- Created comprehensive prisma/seed.ts file with all sample data
- Implemented 30 achievement definitions matching SPECIFICATIONS.md:
  - Reading Achievements (8): first_book, bookworm, bibliophile, scholar, speed_reader, marathon, night_owl, early_bird
  - Streak Achievements (4): streak_7, streak_30, streak_100, streak_365
  - SRS/Learning Achievements (7): first_review, cards_100, cards_1000, mastered_50, mastered_500, retention_90, perfect_day
  - Social Achievements (7): first_highlight, annotator, social_butterfly, influencer, group_founder, curriculum_creator, helpful
  - Comprehension Achievements (4): first_assessment, ace, consistent, blooms_master
- Each achievement includes: code, name, description, category, criteria (JSON), xpReward, tier, sortOrder, badgeIcon, badgeColor
- Created 8 forum categories:
  - general-discussion, book-recommendations, reading-strategies, flashcard-tips
  - study-groups, feature-requests, help-support, pro-scholar-lounge (PRO tier minimum)
- Created 5 sample users across all tiers:
  - Free tier: freereader (en, public profile)
  - Pro tier: proreader (en), arabicreader (ar, RTL)
  - Scholar tier: masterreader (en)
  - Free tier: lectorespa (es, private profile)
- Created 5 sample books with various sources and statuses:
  - OPEN_LIBRARY: The Great Gatsby (COMPLETED), Don Quixote (READING)
  - GOOGLE_BOOKS: 1984 (READING)
  - UPLOAD: Sapiens (WANT_TO_READ) with EPUB file type
  - PASTE: Atomic Habits (COMPLETED)
- Seed script is fully idempotent:
  - Uses upsert pattern for achievements (by code)
  - Uses upsert pattern for forum categories (by slug)
  - Uses upsert pattern for users (by clerkId)
  - Uses upsert pattern for user stats (by userId)
  - Uses findFirst-then-create pattern for books
- Configured Prisma seed in package.json: "prisma": { "seed": "tsx prisma/seed.ts" }
- Created comprehensive test suite (46 tests) in prisma/seed.test.ts:
  - Achievement structure tests (all 30 achievements from spec)
  - Forum category tests (8 categories, URL-friendly slugs)
  - User tier tests (FREE, PRO, SCHOLAR)
  - Book source tests (5 sources)
  - File type tests (6 file types)
  - Reading status tests (4 statuses)
  - Seed script structure tests
  - Idempotency pattern tests
  - Sample data completeness tests
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (265 tests total: 47 api + 34 shared + 12 web + 172 database)
- Files: packages/database/prisma/seed.ts, packages/database/prisma/seed.test.ts, packages/database/package.json

## Iteration 24

[2026-01-17] shared-001: Set up packages/shared structure and export Prisma types
- Created packages/shared/src/types/ directory structure for shared types
- Created src/types/database.ts: Re-exports all Prisma types from @read-master/database
  - 26 model types: User, Book, Chapter, ReadingProgress, Annotation, PreReadingGuide, Assessment,
    Flashcard, FlashcardReview, UserStats, Achievement, UserAchievement, Curriculum, CurriculumItem,
    CurriculumFollow, Follow, ReadingGroup, ReadingGroupMember, GroupDiscussion, DiscussionReply,
    ForumCategory, ForumPost, ForumReply, ForumVote, AIUsageLog, AuditLog
  - 12 enum types: UserTier, BookSource, FileType, ReadingStatus, AnnotationType, AssessmentType,
    FlashcardType, FlashcardStatus, AchievementCategory, AchievementTier, Visibility, GroupRole
- Created src/types/api.ts: Comprehensive API request/response type definitions
  - Common API types: ApiResponse, ApiError, PaginatedResponse, PaginationMeta, PaginationParams, SortParams
  - User API types: UserProfileResponse, UserStatsResponse, UserAchievementResponse, UserActivityItem, UpdateUserPreferencesRequest
  - Book API types: BookListParams, BookSummaryResponse, BookDetailResponse, ChapterResponse, ReadingProgressResponse,
    PreReadingGuideResponse, VocabularyItem, KeyArgumentItem, ChapterSummaryItem, BookUploadRequest, BookImportUrlRequest,
    BookPasteRequest, BookUpdateRequest
  - Annotation API types: AnnotationResponse, CreateAnnotationRequest, UpdateAnnotationRequest
  - Flashcard API types: FlashcardResponse, CreateFlashcardRequest, UpdateFlashcardRequest, ReviewFlashcardRequest,
    ReviewFlashcardResponse, FlashcardStatsResponse
  - Assessment API types: AssessmentQuestion, AssessmentAnswer, AssessmentResponse, BloomsBreakdown,
    GenerateAssessmentRequest, SubmitAssessmentRequest
  - AI API types: AiExplainRequest, AiAskRequest, AiComprehensionCheckRequest, AiGenerateFlashcardsRequest,
    AiGradeAnswerRequest, AiGradeAnswerResponse
  - Social API types: FollowUserRequest, UserFollowResponse, ActivityFeedItem, ReadingGroupResponse,
    CreateReadingGroupRequest, GroupDiscussionResponse
  - Forum API types: ForumCategoryResponse, ForumPostResponse, ForumReplyResponse, CreateForumPostRequest,
    CreateForumReplyRequest, ForumVoteRequest
  - Curriculum API types: CurriculumResponse, CurriculumItemResponse, CurriculumProgressResponse,
    CreateCurriculumRequest, AddCurriculumItemRequest
  - Leaderboard API types: LeaderboardEntry, LeaderboardResponse, LeaderboardParams
  - TTS API types: TtsSpeakRequest, TtsVoicesResponse, TtsVoice, TtsDownloadRequest, TtsDownloadStatusResponse
- Created src/types/index.ts: Clean re-exports of all database and API types
- Updated packages/shared/package.json:
  - Added @read-master/database as workspace dependency
  - Added "./types" export pointing to src/types/index.ts
- Updated packages/shared/src/index.ts with improved documentation
- Created comprehensive test suite (67 tests) in src/types/index.test.ts:
  - Database model type tests (26 model types verified)
  - Database enum type tests (12 enum types verified)
  - API common type tests (ApiResponse, ApiError, PaginatedResponse, etc.)
  - User API type tests
  - Book API type tests
  - Flashcard API type tests
  - Assessment API type tests
  - AI API type tests
  - Social API type tests
  - TTS API type tests
  - Leaderboard API type tests
  - Index re-export verification
- Types can now be imported from '@read-master/shared/types' in apps/web and apps/api
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (332 tests total: 47 api + 101 shared + 12 web + 172 database)
- Files: packages/shared/package.json, packages/shared/src/types/database.ts, packages/shared/src/types/api.ts, packages/shared/src/types/index.ts, packages/shared/src/types/index.test.ts, packages/shared/src/index.ts

## Iteration 25

[2026-01-17] shared-002 & shared-008: Create Zod schemas for Book operations and profanity filter utility
- Created packages/shared/src/schemas/ directory structure for Zod validation schemas
- Created packages/shared/src/utils/moderation.ts: Comprehensive profanity filter utility
  - containsProfanity: Checks if text contains profanity with whole-word matching
  - getProfaneWords: Returns array of profane words found in text
  - validateNoProfanity: Returns validation result for single field
  - validateFieldsNoProfanity: Batch validation for multiple fields
  - cleanProfanity: Replaces profanity with asterisks (use cautiously)
  - Handles homoglyphs (f@ck, fvck, etc.) via character replacement
  - Handles repeated character evasion (fuuuuck -> fuck)
  - Uses whole-word matching to avoid false positives (class, assistant, cocktail)
  - Separate word list and compound profanity list for accurate detection
- Created packages/shared/src/schemas/books.ts: Complete Zod schemas for book operations
  - Enum schemas: bookSourceSchema, fileTypeSchema, readingStatusSchema
  - Field schemas: bookTitleSchema (1-500 chars), bookAuthorSchema (1-200 chars), bookDescriptionSchema (max 50k chars)
  - bookTitlePublicSchema and bookDescriptionPublicSchema with integrated profanity filter
  - Tag validation: alphanumeric with hyphens/underscores, max 50 chars each, max 20 tags
  - Genre schema: max 100 characters
  - Language code schema: ISO 639-1 (2 chars), defaults to 'en'
  - URL schema for imports with 2000 char max
  - Cover image URL schema with 2000 char max
  - Create schemas with discriminated union for 5 book sources:
    - createBookUploadSchema: File upload with fileType
    - createBookUrlSchema: URL import with sourceUrl
    - createBookPasteSchema: Pasted text with content (10-5M chars)
    - createBookGoogleBooksSchema: Google Books with sourceId
    - createBookOpenLibrarySchema: Open Library with sourceId
  - updateBookSchema and updateBookPublicSchema with "at least one field" validation
  - bookQuerySchema: Pagination (page, limit max 100), sorting (7 sort fields), filtering (status, source, genre, language, tags), search, includeDeleted
  - Book ID validation: CUID format (/^c[a-z0-9]+$/)
  - External book search schema: query, maxResults (max 40), startIndex
  - Add from library schema with optional metadata overrides
  - Reading progress update schema with position and percentage tracking
  - bookSchemas object with all schemas for convenient importing
- Created packages/shared/src/schemas/index.ts: Re-exports all book schemas
- Updated packages/shared/package.json: Added "./schemas" export path
- Updated packages/shared/src/utils/index.ts: Added moderation export
- Created comprehensive test suites:
  - src/utils/moderation.test.ts: 26 tests covering all profanity detection scenarios
    - Clean text detection, profanity detection, case-insensitivity
    - Compound profanity (bullshit, motherfucker)
    - Repeated character evasion (fuuuuck, shiiiit)
    - False positive prevention (class, assistant, cocktail, scunthorpe)
    - Slurs detection (retarded, faggot)
    - Empty/invalid input handling
    - validateNoProfanity and validateFieldsNoProfanity batch validation
    - cleanProfanity replacement
  - src/schemas/books.test.ts: 68 tests covering all book schemas
    - Enum validation tests
    - Field schema validation with boundary cases
    - Create schema validation for all 5 sources
    - Update schema validation
    - Query schema validation with defaults
    - Book ID format validation
    - External search schema validation
    - Reading progress schema validation
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (195 tests in shared)
- Files: packages/shared/src/utils/moderation.ts, packages/shared/src/utils/moderation.test.ts, packages/shared/src/utils/index.ts, packages/shared/src/schemas/books.ts, packages/shared/src/schemas/books.test.ts, packages/shared/src/schemas/index.ts, packages/shared/package.json

## Iteration 26

[2026-01-17] shared-003: Create Zod schemas for Annotations
- Created packages/shared/src/schemas/annotations.ts with comprehensive annotation validation
- Implemented AnnotationType enum: HIGHLIGHT, NOTE, BOOKMARK (matching Prisma schema)
- Created field schemas with proper validation:
  - annotationIdSchema: CUID format validation
  - startOffsetSchema/endOffsetSchema: Non-negative integers for character positions
  - selectedTextSchema: Optional text with min 1 char when provided
  - annotationNoteSchema: Max 5,000 characters, trimmed, optional/nullable
  - annotationNotePublicSchema: Same as above with profanity filter for public annotations
  - colorSchema: 7-character hex code (e.g., #FFFF00), normalized to uppercase
  - isPublicSchema: Boolean with default false
- Created type-specific creation schemas:
  - createHighlightSchema: Requires selectedText, optional color and note
  - createNoteSchema: Requires note content, optional selectedText
  - createBookmarkSchema: Minimal - just position, optional note
  - Public variants with profanity filtering for all types
- Created discriminated union schemas:
  - createAnnotationSchema: Validates any annotation type with offset consistency
  - createAnnotationPublicSchema: Same with profanity filtering
- Created update schemas:
  - updateAnnotationSchema: Partial updates with "at least one field" validation
  - updateAnnotationPublicSchema: Same with profanity filtering
  - Validates offset consistency when both start and end are provided
- Created query schema:
  - annotationQuerySchema: Pagination (page, limit max 100), sorting (4 fields), filtering (type, isPublic, hasNote), search in notes
  - Default sort: by startOffset ascending (document order)
- Created ID params schemas:
  - annotationIdParamsSchema: For single annotation routes
  - bookAnnotationIdParamsSchema: For nested routes (/books/:bookId/annotations/:annotationId)
- Created bulk operations schemas:
  - bulkDeleteAnnotationsSchema: Array of IDs (1-100)
  - exportAnnotationsSchema: Format (json, markdown, csv), type filter, includeSelectedText option
- Exported annotationSchemas object with all schemas for convenient importing
- Updated packages/shared/src/schemas/index.ts to export annotation schemas
- Created comprehensive test suite with 80 tests in annotations.test.ts:
  - Enum validation tests
  - ID schema tests (CUID format)
  - Offset validation tests (non-negative integers)
  - Text field validation (selectedText, note with 5000 char max)
  - Profanity filter integration tests
  - Color validation (hex format, uppercase normalization)
  - Type-specific create schema tests (highlight, note, bookmark)
  - Public schema profanity rejection tests
  - Update schema validation (partial updates, offset consistency)
  - Query schema with defaults and coercion
  - Bulk operation schema tests (1-100 IDs)
  - Export schema tests (format options)
  - Edge cases (boundary lengths, unicode, whitespace)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (506 tests total: 47 api + 172 database + 12 web + 275 shared)
- Files: packages/shared/src/schemas/annotations.ts, packages/shared/src/schemas/annotations.test.ts, packages/shared/src/schemas/index.ts

## Iteration 27

[2026-01-17] shared-004: Create Zod schemas for Flashcards and SRS
- Created packages/shared/src/schemas/flashcards.ts with comprehensive flashcard validation
- Implemented FlashcardType enum: VOCABULARY, CONCEPT, COMPREHENSION, QUOTE, CUSTOM
- Implemented FlashcardStatus enum: NEW, LEARNING, REVIEW, SUSPENDED
- Created SRS rating validation (1-4): Again, Hard, Good, Easy
- Created field schemas with proper validation:
  - flashcardIdSchema: CUID format validation
  - flashcardFrontSchema: 1-1,000 characters, trimmed, required
  - flashcardBackSchema: 1-5,000 characters, trimmed, required
  - flashcardTagSchema: Max 50 chars, alphanumeric with hyphens/underscores
  - flashcardTagsArraySchema: Max 20 tags per flashcard
- Created SM-2 algorithm field schemas:
  - easeFactorSchema: Minimum 1.3, default 2.5
  - intervalSchema: Non-negative integer, default 0
  - repetitionsSchema: Non-negative integer, default 0
  - responseTimeMsSchema: Positive integer, optional (for analytics)
- Created creation schemas:
  - createFlashcardSchema: Single flashcard with front, back, type, bookId, tags, source reference
  - createFlashcardsSchema: Batch creation (1-50 flashcards)
- Created updateFlashcardSchema: Partial updates with "at least one field" validation
- Created review schemas:
  - reviewFlashcardSchema: Rating (1-4), optional responseTimeMs
  - reviewFlashcardResponseSchema: Returns previous and new SM-2 state, XP awarded
- Created query schemas:
  - flashcardQuerySchema: Pagination, sorting (6 fields), filters (bookId, status, type, tags, dueOnly)
  - dueFlashcardsQuerySchema: Simplified query for due cards with prioritizeOverdue option
  - flashcardSortFieldSchema: createdAt, updatedAt, dueDate, easeFactor, interval, front
- Created ID params schemas:
  - flashcardIdParamsSchema: For single flashcard routes
  - bookFlashcardIdParamsSchema: For nested routes (/books/:bookId/flashcards/:flashcardId)
- Created bulk operation schemas:
  - bulkUpdateFlashcardStatusSchema: Update status for 1-100 flashcards
  - bulkDeleteFlashcardsSchema: Delete 1-100 flashcards
- Created statistics schemas:
  - flashcardStatsSchema: Card counts, review stats, retention rate, streak info
  - flashcardStatsQuerySchema: Optional bookId and date range filters
- Created AI generation schema:
  - generateFlashcardsSchema: bookId, optional chapterId/text (min 50 chars), types, count (1-20)
- Exported flashcardSchemas object with all schemas for convenient importing
- Updated packages/shared/src/schemas/index.ts to export flashcard schemas
- Created comprehensive test suite with 101 tests in flashcards.test.ts:
  - Enum validation tests (flashcardType, flashcardStatus, srsRating)
  - ID schema tests (CUID format, optional book ID)
  - Content field validation (front 1-1000, back 1-5000, trimming)
  - Tag validation (max 50 chars, array max 20)
  - SM-2 field validation (easeFactor min 1.3, intervals, repetitions)
  - Create schema tests (single and batch creation)
  - Update schema tests (partial updates)
  - Review schema tests (all ratings 1-4, response time)
  - Query schema tests with defaults and coercion
  - ID params schema tests
  - Bulk operation schema tests (1-100 IDs)
  - Statistics schema tests
  - AI generation schema tests
  - Schema index export verification
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (607 tests total: 47 api + 172 database + 12 web + 376 shared)
- Files: packages/shared/src/schemas/flashcards.ts, packages/shared/src/schemas/flashcards.test.ts, packages/shared/src/schemas/index.ts

## Iteration 28

[2026-01-17] shared-007: Implement SM-2 spaced repetition algorithm
- Created packages/shared/src/utils/srs.ts with complete SM-2 algorithm implementation
- Implemented core types and constants:
  - SrsRating type (1-4): Again, Hard, Good, Easy
  - SrsCardState interface: easeFactor, interval, repetitions
  - SrsReviewResult interface: newEaseFactor, newInterval, newRepetitions, nextDueDate, isLapse
  - SM2_CONSTANTS: MIN_EASE_FACTOR (1.3), DEFAULT_EASE_FACTOR (2.5), MAX_EASE_FACTOR (3.0), intervals, modifiers
  - SRS_RATING_LABELS for UI display
- Implemented validation functions:
  - isValidRating: Validates rating is integer 1-4
  - clampEaseFactor: Clamps ease factor to valid range [1.3, 3.0]
- Implemented SM-2 core algorithm functions:
  - calculateNewEaseFactor: SM-2 formula with rating-to-quality mapping
    - Maps 1-4 ratings to SM-2's 0-5 quality scale
    - Applies EF' = EF + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02))
    - Adds Easy bonus (+0.15) for accelerated learning
  - calculateNewInterval: Interval calculation based on rating and repetitions
    - Rating 1 (Again): Reset to 1 day
    - Rating 2 (Hard): 60% of normal interval or 1 day for early reviews
    - Rating 3 (Good): 1  6  interval  EF progression
    - Rating 4 (Easy): Same as Good with 130% bonus
  - calculateNewRepetitions: Resets to 0 for ratings 1-2, increments for 3-4
  - calculateNextDueDate: Adds interval days, sets to UTC start of day
- Implemented main function calculateNextReview:
  - Validates rating input
  - Orchestrates all calculations
  - Detects lapses (rating < 3 resets graduated card)
  - Returns complete new state with next due date
- Implemented utility functions:
  - createDefaultSrsState: Returns fresh card state (EF=2.5, interval=0, reps=0)
  - isCardDue: Checks if card is due for review
  - daysUntilDue: Calculates days until due (negative if overdue)
  - calculateRetentionRate: Calculates percentage of successful reviews (rating >= 3)
  - predictNextIntervals: Predicts intervals for all four ratings
  - formatInterval: Human-readable interval formatting (1 day, 2 weeks, 3 months, 1 year)
- Updated packages/shared/src/utils/index.ts to export SRS module
- Created comprehensive test suite with 85 tests in srs.test.ts:
  - Constants validation tests (6 tests)
  - isValidRating tests for all edge cases (4 tests)
  - clampEaseFactor tests (4 tests)
  - calculateNewEaseFactor tests with all ratings (7 tests)
  - calculateNewInterval tests for all ratings and scenarios (10 tests)
  - calculateNewRepetitions tests (4 tests)
  - calculateNextDueDate tests including leap year handling (6 tests)
  - calculateNextReview integration tests (10 tests)
  - createDefaultSrsState tests (2 tests)
  - isCardDue tests (4 tests)
  - daysUntilDue tests (4 tests)
  - calculateRetentionRate tests (5 tests)
  - predictNextIntervals tests (3 tests)
  - formatInterval tests (6 tests)
  - Real-world integration scenarios (4 tests)
  - Type safety tests (3 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (692 tests total: 47 api + 172 database + 12 web + 461 shared)
- Files: packages/shared/src/utils/srs.ts, packages/shared/src/utils/srs.test.ts, packages/shared/src/utils/index.ts

## Iteration 29

[2026-01-17] shared-005: Create Zod schemas for Forum operations
- Created packages/shared/src/schemas/forum.ts with comprehensive forum validation
- Implemented all enum schemas matching Prisma schema:
  - userTierSchema (FREE, PRO, SCHOLAR) - for category access control
  - voteValueSchema (1 or -1) - upvote/downvote validation
  - reportTypeSchema (SPAM, HARASSMENT, INAPPROPRIATE, OFF_TOPIC, MISINFORMATION, OTHER)
- Created ID schemas with CUID format validation:
  - forumPostIdSchema, forumReplyIdSchema, forumCategoryIdSchema
  - forumCategorySlugSchema (URL-friendly: lowercase, numbers, hyphens)
  - forumBookIdSchema (optional/nullable for book-specific discussions)
- Created content field schemas with profanity filtering:
  - forumPostTitleSchema (3-200 chars) and forumPostTitlePublicSchema (with profanity filter)
  - forumContentSchema (10-50,000 chars) and forumContentPublicSchema
  - forumReplyContentSchema (1-50,000 chars) and forumReplyContentPublicSchema
- Created forum post schemas:
  - createForumPostSchema/createForumPostBaseSchema (with/without profanity filter)
  - updateForumPostSchema with "at least one field" validation
  - forumPostQuerySchema with pagination (max 100), sorting (6 fields), filtering, search
  - forumPostSortFieldSchema: createdAt, updatedAt, voteScore, viewCount, repliesCount, lastReplyAt
  - postIdParamsSchema, categoryPostIdParamsSchema for route parameters
- Created forum reply schemas:
  - createForumReplySchema with nested reply support (parentReplyId)
  - updateForumReplySchema
  - forumReplyQuerySchema with maxDepth for nested replies (default 5, max 10)
  - forumReplySortFieldSchema: createdAt, updatedAt, voteScore
- Created vote schemas:
  - voteOnPostSchema, voteOnReplySchema
  - removePostVoteSchema, removeReplyVoteSchema
  - forumVoteSchema (unified) with XOR validation for postId/replyId
- Created moderation schemas:
  - markBestAnswerSchema, togglePinPostSchema, toggleLockPostSchema
  - reportContentSchema with XOR validation and reason (max 1000 chars)
- Created bulk operation schemas:
  - bulkDeletePostsSchema (1-100 IDs)
  - bulkDeleteRepliesSchema (1-100 IDs)
- Created forumSearchSchema with searchIn filter (posts, replies, all)
- Created forumCategoryResponseSchema for API responses
- Exported forumSchemas collection object for convenient importing
- Updated packages/shared/src/schemas/index.ts to export forum schemas
- Created comprehensive test suite with 121 tests in forum.test.ts:
  - Enum validation tests (userTier, voteValue, reportType)
  - ID schema tests (CUID format, slug format)
  - Content field validation with profanity filter integration
  - Create/update schema tests for posts and replies
  - Vote schema tests (upvote, downvote, unified vote with XOR)
  - Moderation schema tests (best answer, pin, lock, report)
  - Query schema tests with defaults and coercion
  - Bulk operation schema tests (1-100 IDs)
  - Search schema tests
  - Edge cases: unicode, RTL content, boundary conditions, whitespace
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (814 tests total: 47 api + 172 database + 12 web + 582 shared)
- Files: packages/shared/src/schemas/forum.ts, packages/shared/src/schemas/forum.test.ts, packages/shared/src/schemas/index.ts

## Iteration 30

[2026-01-17] shared-006: Create Zod schemas for Assessments, Curriculums, Social features, and Users
- Created packages/shared/src/schemas/assessments.ts with comprehensive assessment validation:
  - AssessmentType enum: CHAPTER_CHECK, BOOK_ASSESSMENT, CUSTOM
  - BloomsLevel enum: REMEMBER, UNDERSTAND, APPLY, ANALYZE, EVALUATE, CREATE
  - QuestionType enum: MULTIPLE_CHOICE, TRUE_FALSE, SHORT_ANSWER, ESSAY, FILL_IN_BLANK
  - Question and answer schemas with proper validation
  - Bloom's taxonomy distribution schemas for balanced assessments
  - Generate assessment schema with question configuration
  - Submit assessment and grade answer schemas
  - Query schema with pagination, sorting, and filtering
  - Comprehension check schemas for during-reading checks
  - Statistics schema for assessment analytics
  - Exported assessmentSchemas collection object
- Created packages/shared/src/schemas/curriculums.ts with curriculum validation:
  - Visibility enum: PRIVATE, UNLISTED, PUBLIC
  - Difficulty levels: beginner, intermediate, advanced, expert
  - Create/update curriculum schemas with profanity filtering for public content
  - Curriculum item schemas for both internal books and external resources
  - Follow and progress tracking schemas
  - Query schema with pagination, sorting, and filtering
  - Browse schema for public curriculum discovery
  - Exported curriculumSchemas collection object
- Created packages/shared/src/schemas/social.ts with social feature validation:
  - GroupRole enum: OWNER, ADMIN, MEMBER
  - ActivityType enum: COMPLETED_BOOK, EARNED_ACHIEVEMENT, JOINED_GROUP, etc.
  - Follow/unfollow schemas
  - Reading group create/update schemas with profanity filtering
  - Group membership management schemas
  - Discussion and reply schemas with nested reply support
  - Activity feed schemas
  - Recursive discussionReplyResponseSchema for nested replies (with proper Zod typing)
  - Exported socialSchemas collection object
- Created packages/shared/src/schemas/users.ts with user validation:
  - UserTier enum: FREE, PRO, SCHOLAR
  - User profile schemas with profanity filtering for public content
  - Preferences schema (theme, font, notifications, reading settings)
  - Privacy settings schema (profilePublic, showStats, showActivity)
  - GDPR-compliant data export and deletion request schemas
  - Clerk webhook schemas (user.created, user.updated, user.deleted)
  - Query and ID params schemas
  - Exported userSchemas collection object
- Updated packages/shared/src/schemas/index.ts:
  - Fixed export conflicts with forum.ts by using explicit named exports with aliasing
  - Social schemas exported with prefixes (e.g., socialUserIdSchema, socialReplyIdSchema)
  - Users schemas exported with prefixes (e.g., userUserTierSchema)
  - All new schemas properly re-exported
- Created comprehensive test suites:
  - assessments.test.ts: Tests for enums, IDs, questions, answers, Bloom's taxonomy, generate/submit, queries, statistics
  - curriculums.test.ts: Tests for visibility, difficulty, create/update with profanity filtering, items, progress
  - social.test.ts: Tests for following, groups, discussions, replies, activity types, profanity filtering
  - users.test.ts: Tests for profiles, preferences, privacy, GDPR, Clerk webhooks
- Fixed recursive schema type issue in social.ts by defining base schema first, then explicit type with optional childReplies
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (997 tests total: 47 api + 172 database + 12 web + 766 shared)
- Files: packages/shared/src/schemas/assessments.ts, packages/shared/src/schemas/assessments.test.ts, packages/shared/src/schemas/curriculums.ts, packages/shared/src/schemas/curriculums.test.ts, packages/shared/src/schemas/social.ts, packages/shared/src/schemas/social.test.ts, packages/shared/src/schemas/users.ts, packages/shared/src/schemas/users.test.ts, packages/shared/src/schemas/index.ts

## Iteration 31

[2026-01-17] shared-009: Create date and timezone utilities
- Created packages/shared/src/utils/dates.ts with comprehensive date/time handling
- Implemented validation functions:
  - isValidDate: Check if value is a valid Date object
  - isValidTimezone: Check if string is a valid IANA timezone identifier
  - parseDate: Parse date from various input formats (Date, string, number, null)
- Implemented UTC functions for database storage:
  - nowUTC: Get current date/time in UTC
  - toUTC: Convert a local date to UTC
  - startOfDayUTC, endOfDayUTC: Get start/end of day in UTC
  - startOfWeekUTC, startOfMonthUTC: Get start of week/month in UTC
  - addDays, addHours, addMinutes, addMonths, addYears: Date arithmetic
- Implemented timezone conversion functions:
  - getLocalTimezone: Get user's local timezone
  - getTimezoneOffset: Get timezone offset in minutes
  - convertTimezone: Convert date between timezones
  - nowInTimezone: Get current time in specific timezone
- Implemented date formatting functions:
  - formatDate: Format with Intl.DateTimeFormat and custom options
  - formatISO: Format as ISO string for database storage
  - formatShortDate, formatTime, formatDateTime: Common format helpers
- Implemented relative time formatting:
  - getTimeDifference: Calculate time difference with appropriate unit
  - formatRelativeTime: Format as relative time (e.g., "2 hours ago")
  - timeAgo, timeUntil: Convenience functions for past/future dates
- Implemented date comparison functions:
  - isSameDay, isToday, isYesterday, isTomorrow: Day comparisons
  - isPast, isFuture: Time comparisons
  - isThisWeek, isThisMonth, isThisYear: Period comparisons
- Implemented duration functions:
  - formatDuration: Format seconds as "1h 30m 45s"
  - formatDurationLong: Format with full unit names
  - parseDuration: Parse duration strings (HH:MM:SS, "1h 30m", etc.)
- Implemented reading time estimation:
  - calculateReadingTime: Calculate reading time in seconds
  - formatReadingTime: Format as "5 min read" or "2h 30m read"
- Implemented streak calculation functions:
  - areConsecutiveDays: Check if two dates are consecutive
  - calculateStreak: Calculate streak from activity dates
- Exported dateUtils object with all functions and constants
- Defined COMMON_TIMEZONES array with 12 major timezones
- Defined time unit constants (MS_PER_SECOND, MS_PER_MINUTE, etc.)
- Updated packages/shared/src/utils/index.ts to export dates module
- Created comprehensive test suite with 127 tests in dates.test.ts:
  - Constants tests
  - Validation function tests
  - UTC function tests
  - Timezone conversion tests
  - Formatting tests (date, time, relative)
  - Comparison function tests
  - Duration formatting and parsing tests
  - Reading time calculation tests
  - Streak calculation tests with mocked time
  - Edge case tests (leap years, DST, old/future dates)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1355 tests total: 47 api + 172 database + 12 web + 1124 shared)
- Files: packages/shared/src/utils/dates.ts, packages/shared/src/utils/dates.test.ts, packages/shared/src/utils/index.ts

## Iteration 32

[2026-01-17] shared-010: Create Bloom's Taxonomy utilities
- Created packages/shared/src/utils/blooms.ts with comprehensive Bloom's taxonomy implementation
- Defined all six Bloom's taxonomy levels (REMEMBER through CREATE):
  - Each level includes: name, description, cognitive level (1-6), keywords, question stems, color
  - REMEMBER (1): Recall facts, define, list, identify, name, state
  - UNDERSTAND (2): Explain ideas, summarize, paraphrase, compare, interpret
  - APPLY (3): Use knowledge, demonstrate, solve, implement, calculate
  - ANALYZE (4): Break down information, examine, differentiate, categorize
  - EVALUATE (5): Make judgments, critique, assess, justify, recommend
  - CREATE (6): Produce new work, design, develop, formulate, invent
- Implemented validation functions:
  - isValidBloomsLevel: Check if value is a valid Bloom's level
  - isHigherOrderLevel: Check if level is ANALYZE, EVALUATE, or CREATE
  - isLowerOrderLevel: Check if level is REMEMBER, UNDERSTAND, or APPLY
- Implemented level info functions:
  - getBloomsLevelInfo: Get complete info for a level
  - getCognitiveLevel: Get numeric level (1-6)
  - getBloomsLevelName, getBloomsLevelDescription, getBloomsLevelColor
  - getBloomsKeywords, getBloomsQuestionStems: Get keywords/stems for a level
- Implemented comparison functions:
  - compareBloomsLevels: Compare two levels by cognitive complexity
  - getNextHigherLevel, getNextLowerLevel: Navigate the hierarchy
  - getLevelsAtOrAbove, getLevelsAtOrBelow: Get level ranges
- Implemented question categorization:
  - categorizeQuestion: Analyze question text to determine Bloom's level
  - categorizeQuestions: Batch categorization
  - Uses keyword and question stem matching with weighted scoring
  - Prefers higher-order levels on tie (promotes deeper thinking)
  - suggestKeywordsForLevel, getExampleStemsForLevel: Helpers for question creation
- Implemented breakdown calculation functions:
  - createEmptyBreakdown: Create zeroed breakdown object
  - calculateBloomsBreakdown: Calculate percentages from question list
  - calculateCountsFromBreakdown: Convert percentages to counts
  - getRecommendedDistribution: Get balanced question distribution
  - calculateAverageCognitiveLevel: Weighted average of cognitive levels
  - calculateHigherOrderPercentage: Percentage of higher-order questions
  - isBalancedBreakdown, getBalanceSuggestions: Check/improve balance
- Defined constants:
  - BLOOMS_LEVELS: Array of all six levels in order
  - BLOOMS_LEVEL_INFO: Complete info record for each level
  - DEFAULT_BLOOMS_DISTRIBUTION: Recommended percentages (15/20/20/20/15/10)
  - HIGHER_ORDER_LEVELS, LOWER_ORDER_LEVELS: Level groupings
- Exported bloomsUtils object with all functions for convenient importing
- Updated packages/shared/src/utils/index.ts to export blooms module
- Created comprehensive test suite with 96 tests in blooms.test.ts:
  - Constants tests (BLOOMS_LEVELS, BLOOMS_LEVEL_INFO, DEFAULT_DISTRIBUTION)
  - Validation function tests
  - Level info function tests
  - Comparison function tests
  - Question categorization tests (all six levels, edge cases)
  - Breakdown calculation tests
  - bloomsUtils object export verification
  - Edge cases (unicode, special characters, long questions)
  - Full assessment flow integration test
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1451 tests total: 47 api + 172 database + 12 web + 1220 shared)
- Files: packages/shared/src/utils/blooms.ts, packages/shared/src/utils/blooms.test.ts, packages/shared/src/utils/index.ts

## Iteration 33

[2026-01-17] shared-011: Create reading level (Lexile) utilities
- Created packages/shared/src/utils/lexile.ts with comprehensive reading level analysis
- Implemented types and interfaces:
  - ReadingLevelCategory: BEGINNING_READER through ADVANCED (7 categories)
  - TextDifficultyResult: Complete analysis result with lexile, grade, label, category, confidence, metrics
  - TextMetrics: Word count, sentence count, syllable count, averages, complexity percentage
  - GradeLevelInfo: Grade level to Lexile mapping with descriptions
  - ReadingLevelRecommendation: Min/max Lexile range with grade range and description
- Defined grade level constants:
  - GRADE_LEVEL_LEXILE_MAP: 16 grade levels (1-16) with Lexile ranges based on MetaMetrics research
  - READING_LEVEL_CATEGORIES: 7 categories with names, descriptions, and Lexile ranges
  - COMMON_WORDS: Dale-Chall inspired common words list for frequency analysis
- Implemented text analysis helpers:
  - countSyllables: Heuristic syllable counting with silent-e and suffix handling
  - isComplexWord: Identifies words with 3+ syllables that aren't common
  - isCommonWord: Checks against Dale-Chall common words list
  - extractWords: Parse words from text handling punctuation and contractions
  - extractSentences: Split text into sentences
  - calculateTextMetrics: Full text analysis with all metrics
- Implemented readability formulas:
  - calculateFleschKincaidGradeLevel: FK grade level formula
  - calculateFleschReadingEase: FK reading ease (0-100 scale)
  - calculateGunningFog: Gunning Fog Index
  - calculateSmogIndex: Simple Measure of Gobbledygook
  - calculateColemanLiauIndex: Coleman-Liau Index
  - calculateAri: Automated Readability Index
- Implemented Lexile estimation:
  - gradeLevelToLexile: Convert grade to Lexile score
  - lexileToGradeLevel: Convert Lexile to grade level
  - estimateLexileFromMetrics: Weighted average of multiple formulas
  - getLexileCategory: Get reading level category from Lexile
  - getReadingLevelLabel: Human-readable label for Lexile
  - formatLexileScore: Format as "850L" or "BR"
  - estimateTextDifficulty: Full analysis with confidence scoring
  - quickLexileEstimate: Fast Lexile-only estimation
- Implemented comparison and recommendation functions:
  - isTextAppropriate: Check if text is within reader's range
  - compareLexileScores: Compare two Lexile values
  - calculateLexileDifference: Calculate difference with direction
  - getReadingLevelRecommendation: Get recommended reading range with stretch option
  - getGradeLevelInfo: Get grade level details
  - getGradeLevelsInRange: Get all grades within a Lexile range
  - isValidLexile: Validate Lexile score (0-2000)
  - parseLexileString: Parse "850L" format strings
- Exported lexileUtils object with all functions for convenient importing
- Updated packages/shared/src/utils/index.ts to export lexile module
- Created comprehensive test suite with 118 tests in lexile.test.ts:
  - Constants tests (GRADE_LEVEL_LEXILE_MAP, READING_LEVEL_CATEGORIES)
  - Text analysis helper tests (syllables, complex words, extraction)
  - Readability formula tests (all 6 formulas)
  - Lexile estimation tests (conversion, categorization, formatting)
  - Main estimation function tests with confidence
  - Comparison and recommendation tests
  - Real-world text analysis tests (children's book, academic, newspaper)
  - Edge cases (short text, no sentences, unicode, long text, empty)
  - Type safety tests
  - lexileUtils export verification
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1569 tests total: 47 api + 172 database + 12 web + 1338 shared)
- Files: packages/shared/src/utils/lexile.ts, packages/shared/src/utils/lexile.test.ts, packages/shared/src/utils/index.ts

## Iteration 34

[2026-01-17] shared-012: Define tier limits and achievement constants
- Created packages/shared/src/constants/ directory structure
- Created src/constants/limits.ts with comprehensive tier limit definitions:
  - TierLimits type with all limit fields (maxBooks, maxAiInteractionsPerDay, maxActiveFlashcards, etc.)
  - TierAction type for checkable actions
  - FREE_TIER_LIMITS: 3 books, 5 AI/day, 50 cards, web_speech TTS, no TTS downloads
  - PRO_TIER_LIMITS: Unlimited books, 100 AI/day, unlimited cards, openai TTS, 5 downloads/month
  - SCHOLAR_TIER_LIMITS: Unlimited everything, elevenlabs TTS, unlimited downloads
  - TIER_LIMITS record indexed by UserTier
  - SUBSCRIPTION_PRICING: PRO $9.99/month, SCHOLAR $19.99/month
  - AI_CREDITS_PRICING: 50 credits $4.99, 150 credits $9.99, 500 credits $24.99
  - Helper functions: getTierLimits, canPerformAction, isWithinLimit, getRemainingQuota
  - Tier comparison: isTierHigherOrEqual, getMinimumTierForAction
  - limitUtils object with all functions for convenient importing
- Created src/constants/achievements.ts with all 30 achievements from spec:
  - AchievementCriteriaType for criteria types (booksCompleted, currentStreak, etc.)
  - AchievementCriterion with operator and value, optional time-based window
  - AchievementDefinition with code, name, description, category, tier, criteria, xpReward
  - READING_ACHIEVEMENTS (8): first_book, bookworm, bibliophile, scholar, speed_reader, marathon, night_owl, early_bird
  - STREAK_ACHIEVEMENTS (4): streak_7, streak_30, streak_100, streak_365
  - LEARNING_ACHIEVEMENTS (7): first_review, cards_100, cards_1000, mastered_50, mastered_500, retention_90, perfect_day
  - SOCIAL_ACHIEVEMENTS (7): first_highlight, annotator, social_butterfly, influencer, group_founder, curriculum_creator, helpful
  - MILESTONE_ACHIEVEMENTS (4): first_assessment, ace, consistent, blooms_master
  - LEVEL_THRESHOLDS: 10 levels with XP requirements (0-10000) and titles (Novice Reader to Master Reader)
  - XP_PER_LEVEL_AFTER_10: 5000 XP per level for levels 11+
  - GRAND_MASTER_TITLE: "Grand Master" for levels 11+
  - XP_REWARDS for actions: BOOK_COMPLETED (100), FLASHCARD_CORRECT (5), ASSESSMENT_COMPLETED (50), etc.
  - Helper functions: getAchievementByCode, getAchievementsByCategory, getAchievementsByTier
  - Level functions: calculateLevel, getXPForLevel, getTitleForLevel
  - Criteria checking: checkAchievementCriteria with all criteria types including time-based (night_owl, early_bird)
  - getUnlockableAchievements: Find achievements user can unlock based on stats
  - calculateTotalXP: Calculate XP from earned achievement codes
  - achievementUtils object with all functions
- Created src/constants/languages.ts with i18n configuration:
  - SupportedLanguageCode type: "en" | "ar" | "es" | "ja" | "zh" | "tl"
  - LanguageInfo type with code, englishName, nativeName, isRtl, isEnabled, sortOrder, primaryRegion, fullLocale
  - TextDirection type: "ltr" | "rtl"
  - Individual language definitions: ENGLISH, ARABIC (RTL), SPANISH, JAPANESE, CHINESE, TAGALOG
  - SUPPORTED_LANGUAGES array, SUPPORTED_LANGUAGE_CODES array
  - LANGUAGES_BY_CODE record, RTL_LANGUAGE_CODES array
  - DEFAULT_LANGUAGE_CODE ("en"), DEFAULT_LOCALE ("en-US")
  - DATE_FORMAT_STYLES and TIME_FORMAT_STYLES per language
  - NUMBER_LOCALES for number formatting per language
  - FONT_STACKS for language-specific fonts (Noto Sans Arabic, Noto Sans JP, etc.)
  - DYSLEXIA_FONT configuration for accessibility
  - Helper functions: isSupportedLanguage, getLanguageInfo, isRtlLanguage, getTextDirection
  - Locale functions: getFullLocale, getEnabledLanguages, getLanguageOptions, parseLanguageCode
  - Font function: getFontStack with dyslexia font support
  - Formatting functions: formatNumber, formatLocalizedDate, formatLocalizedTime
  - languageUtils object with all functions
- Created src/constants/index.ts with organized re-exports:
  - All limits types, constants, and functions
  - All achievements types, constants, and functions
  - All languages types, constants, and functions
- Updated packages/shared/package.json:
  - Added "./constants": "./src/constants/index.ts" export path
- Created comprehensive test suites:
  - src/constants/limits.test.ts: 85 tests for tier limits, pricing, helper functions
  - src/constants/achievements.test.ts: 105 tests for all 30 achievements, level system, criteria checking
  - src/constants/languages.test.ts: 91 tests for language definitions, RTL, formatting functions
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1619 tests total: 47 api + 172 database + 12 web + 1388 shared)
- Files: packages/shared/src/constants/limits.ts, packages/shared/src/constants/limits.test.ts, packages/shared/src/constants/achievements.ts, packages/shared/src/constants/achievements.test.ts, packages/shared/src/constants/languages.ts, packages/shared/src/constants/languages.test.ts, packages/shared/src/constants/index.ts, packages/shared/package.json
## Iteration 35

[2026-01-17] shared-013: Create main index.ts with clean exports
- Rewrote packages/shared/src/index.ts as comprehensive main entry point
- Organized exports into clear sections with documentation:
  - UTILITIES: All utility functions from string, moderation, SRS, dates, blooms, lexile
  - TYPE RE-EXPORTS: Database types (26 models, 12 enums) and API types (request/response)
  - SCHEMA RE-EXPORTS: Key schemas from books, annotations, flashcards, forum, assessments, curriculums
  - CONSTANTS RE-EXPORTS: Tier limits, achievements (30 definitions), language configuration (6 languages)
- Added comprehensive JSDoc documentation with usage examples
- Documented the dual import pattern:
  - Main entry point for common utilities: `import { truncate, containsProfanity } from '@read-master/shared'`
  - Subpath imports for organized access: `import type { User } from '@read-master/shared/types'`
- Re-exports include:
  - String utilities: truncate, toTitleCase, slugify, stripHtml
  - Moderation utilities: containsProfanity, validateNoProfanity, validateFieldsNoProfanity, cleanProfanity
  - SRS utilities: calculateNextReview, createDefaultSrsState, formatInterval, SM2_CONSTANTS, srsUtils
  - Date utilities: formatRelativeTime, timeAgo, formatDuration, nowUTC, dateUtils, and more
  - Bloom's utilities: categorizeQuestion, calculateBloomsBreakdown, BLOOMS_LEVELS, bloomsUtils
  - Lexile utilities: estimateTextDifficulty, getReadingLevelRecommendation, lexileUtils
  - All database model and enum types (User, Book, ReadingStatus, etc.)
  - All API request/response types (ApiResponse, BookDetailResponse, etc.)
  - Key Zod schemas from all modules (createBookUploadSchema, reviewFlashcardSchema, etc.)
  - All constants: TIER_LIMITS, ACHIEVEMENTS, SUPPORTED_LANGUAGES, XP_REWARDS, etc.
  - All helper functions: getTierLimits, calculateLevel, isRtlLanguage, etc.
- Created comprehensive test suite with 51 tests in src/index.test.ts:
  - String utility export verification
  - Moderation utility export verification
  - SRS utility export verification with functional tests
  - Date utility export verification
  - Bloom's taxonomy utility export verification
  - Lexile utility export verification
  - Schema exports verification (books, annotations, flashcards, forum, assessments, curriculums)
  - Constants exports verification (tier limits, achievements, languages)
  - Circular dependency check (verifies no import issues)
  - Export counts validation (100+ exports verified)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1901 tests total: 47 api + 172 database + 12 web + 1670 shared)
- Files: packages/shared/src/index.ts, packages/shared/src/index.test.ts


## Iteration 36

[2026-01-17] api-infra-001: Set up Clerk authentication middleware
- Created apps/api/src/middleware/ directory structure
- Added @clerk/backend ^1.21.0 dependency to apps/api
- Created src/middleware/auth.ts with comprehensive authentication utilities:
  - AuthenticatedUser type: userId, email, firstName, lastName, imageUrl, username, sessionId, orgId, orgRole
  - AuthenticatedRequest type: extends VercelRequest with auth property
  - AuthResult type: success/error discriminated union
  - ClerkWebhookEvent type: for webhook payloads
  - verifyClerkToken function: verifies JWT token using Clerk's verifyToken
    - Returns user info on success
    - Handles expired/invalid tokens with appropriate error codes
    - Returns 500 if CLERK_SECRET_KEY not configured
  - getClerkUser function: fetches full user details from Clerk API
    - Returns userId, email, names, imageUrl, metadata, timestamps
  - authenticateRequest function: extracts Bearer token and verifies
    - Supports case-insensitive Bearer keyword
    - Returns 401 for missing/invalid tokens
  - verifyWebhookSignature function: validates Clerk webhook signatures
    - Uses Svix HMAC-SHA256 signature verification
    - Supports whsec_ prefixed secrets
    - Validates timestamp within 5-minute tolerance
    - Constant-time comparison to prevent timing attacks
    - Handles multiple signature versions
  - withAuth higher-order function: wraps handlers with authentication
    - Attaches authenticated user to request.auth
    - Returns 401 JSON response for unauthenticated requests
  - withWebhook higher-order function: wraps webhook handlers
    - Validates POST method
    - Verifies webhook signature
    - Parses event payload (handles string and object body)
  - optionalAuth function: returns user if authenticated, null otherwise
- Created src/middleware/index.ts with organized re-exports
- Updated src/index.ts to export middleware
- Created comprehensive test suite with 36 tests in src/middleware/auth.test.ts:
  - verifyClerkToken tests: secret not configured, valid token with org, without optional fields, expired/invalid/generic errors
  - authenticateRequest tests: no header, invalid format, missing Bearer, extra parts, valid token, case-insensitive Bearer
  - verifyWebhookSignature tests: missing secret, missing headers, old/future timestamps, invalid signature, non-v1 version, valid signatures with/without whsec_ prefix, multiple signatures
  - withAuth tests: unauthenticated request, invalid token, valid token with user attached, async handlers
  - withWebhook tests: non-POST request, invalid signature, valid signature with parsed event, object body handling
  - optionalAuth tests: no header, invalid token, valid token, invalid bearer format
- Uses Winston logger for error logging (no console statements)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1937 tests total: 83 api + 172 database + 12 web + 1670 shared)
- Files: apps/api/src/middleware/auth.ts, apps/api/src/middleware/auth.test.ts, apps/api/src/middleware/index.ts, apps/api/src/index.ts, apps/api/package.json

## Iteration 37

[2026-01-17] api-infra-002: Create error handling middleware
- Created apps/api/src/middleware/error.ts with comprehensive error handling
- Implemented custom error classes for different error types:
  - AppError: Base class with statusCode, code, details, isOperational properties
  - ValidationError: 400 status for request validation failures
  - UnauthorizedError: 401 status for unauthenticated requests
  - ForbiddenError: 403 status for forbidden access
  - NotFoundError: 404 status for missing resources
  - ConflictError: 409 status for duplicate resources
  - RateLimitError: 429 status with retryAfter support
  - DatabaseError: 500 status for database operation failures
  - ServiceUnavailableError: 503 status for external service failures
- Implemented Zod validation error handling:
  - formatZodErrors: Converts ZodError into readable field-level errors
  - Maps nested paths (user.profile.age) correctly
  - Returns 400 status with details array
- Implemented Prisma error handling:
  - isPrismaError: Type guard for Prisma errors (P2xxx codes)
  - handlePrismaError: Converts Prisma errors to appropriate AppError
    - P2002 (unique constraint)  ConflictError
    - P2025 (record not found)  NotFoundError
    - P2003 (foreign key)  ValidationError
    - P2014 (required relation)  ValidationError
    - P2024 (connection timeout)  ServiceUnavailableError
    - Unknown codes  DatabaseError
- Implemented main error handling utilities:
  - createErrorResponse: Creates standardized error response format
  - handleError: Main function to process any error and send response
    - Handles ZodError, Prisma errors, AppError, and unknown errors
    - Logs errors with context (statusCode, errorCode, custom context)
    - Sets Retry-After header for rate limit errors
- Implemented withErrorHandling higher-order function:
  - Wraps handlers to automatically catch and handle errors
  - Extracts request context (method, url, userId) for logging
  - Eliminates need for try-catch blocks in handlers
- Implemented assertion utilities:
  - assert: Throw error if condition is falsy (accepts string or AppError)
  - assertExists: Type-safe assertion that value is not null/undefined
    - Narrows type from T | null | undefined to T
- Updated src/middleware/index.ts to export all error handling utilities
- Created comprehensive test suite with 56 tests in error.test.ts:
  - AppError tests: default values, custom values, stack trace
  - Specialized error tests: all 8 error classes with defaults and custom messages
  - formatZodErrors tests: single field, nested fields, multiple errors, root-level
  - isPrismaError tests: various Prisma codes, non-Prisma errors, edge cases
  - handlePrismaError tests: P2002, P2025, P2003, P2014, P2024, unknown codes
  - createErrorResponse tests: with and without details
  - handleError tests: AppError, ZodError, Prisma errors, unknown errors, Retry-After header, context logging
  - withErrorHandling tests: normal handler, thrown errors, sync errors, request context
  - assert tests: truthy values, string error, AppError, falsy conditions
  - assertExists tests: existing values, null, undefined, type narrowing
  - Error inheritance tests: all classes extend AppError and Error
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1993 tests total: 139 api + 172 database + 12 web + 1670 shared)
- Files: apps/api/src/middleware/error.ts, apps/api/src/middleware/error.test.ts, apps/api/src/middleware/index.ts

## Iteration 38

[2026-01-17] api-infra-003: Create Zod validation middleware
- Created apps/api/src/middleware/validation.ts with comprehensive validation utilities
- Implemented type-safe validation schema configuration:
  - ValidationSchema<TBody, TQuery, TParams>: Schema configuration type
  - ValidatedData<TSchema>: Inferred validated data types
  - ValidationResult<T>: Success/error discriminated union result type
  - ValidatedRequest<TSchema>: Extended request with validated data attached
- Implemented core validation functions:
  - validateWithSchema: Validate any data against a Zod schema
  - validateBody: Validate request body with source set to "body"
  - validateQuery: Validate query params with source set to "query"
  - validateParams: Validate URL params with source set to "params"
  - validateRequest: Validate all parts of a request (body, query, params)
  - formatValidationErrors: Group errors by source for structured response
- Implemented higher-order middleware:
  - withValidation: Wraps handlers with automatic validation
    - Returns 400 with grouped validation errors on failure
    - Attaches validated data to request.validated on success
    - Fully type-safe with inferred types from schemas
- Implemented utility functions:
  - parseOrThrow: Parse single value or throw ValidationError
  - extractValidated: Extract and validate data or throw with detailed message
- Created CommonSchemas for reusable validation patterns:
  - uuid: UUID validation
  - pagination: { page, limit } with coercion and defaults
  - idParam: { id: uuid } for URL path params
  - sortDirection: "asc" | "desc" with default "desc"
  - queryBoolean: Transform "true"/"false"/"1"/"0" to boolean
  - commaSeparated: Split and trim comma-separated strings
- Created createQuerySchema helper:
  - Build query schemas with optional pagination and sort fields
  - Composable with custom field definitions
- Updated src/middleware/index.ts to export all validation utilities
- Created comprehensive test suite with 43 tests in validation.test.ts:
  - validateWithSchema tests: valid data, invalid data, nested objects
  - validateBody tests: source tracking, multiple errors
  - validateQuery tests: string coercion, optional params, defaults
  - validateParams tests: UUID validation, source tracking
  - validateRequest tests: all parts, error aggregation, partial schemas
  - formatValidationErrors tests: grouping, multiple sources, empty array
  - withValidation tests: success path, 400 errors, async handlers, type preservation
  - parseOrThrow tests: success, ValidationError, field name in message
  - extractValidated tests: success, detailed error messages, source tracking
  - CommonSchemas tests: all schema validations
  - createQuerySchema tests: custom fields, pagination, sort, combined
  - Type inference tests: body type preservation
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2036 tests total: 182 api + 172 database + 12 web + 1670 shared)
- Files: apps/api/src/middleware/validation.ts, apps/api/src/middleware/validation.test.ts, apps/api/src/middleware/index.ts

## Iteration 39

[2026-01-17] api-infra-004: Implement rate limiting by tier
- Added Upstash dependencies to apps/api:
  - @upstash/redis ^1.36.1 (Redis REST client for serverless)
  - @upstash/ratelimit ^2.0.8 (Rate limiting library)
  - @read-master/database workspace dependency (for UserTier type)
- Created apps/api/src/middleware/rateLimit.ts with comprehensive rate limiting:
  - RateLimitOperation type: ai, tts, ttsDownload, upload, api
  - RateLimitConfig type: limit, windowSeconds, isDaily
  - RateLimitResult type: success, remaining, limit, reset, error
  - RateLimitHeaders type for response headers
  - RateLimitedRequest type: extends AuthenticatedRequest with rateLimit
- Implemented tier-based rate limits matching specification:
  - AI operations (daily):
    - FREE: 5/day, PRO: 100/day, SCHOLAR: 10000/day (effectively unlimited)
  - TTS requests (per-minute):
    - FREE: 10/min, PRO: 30/min, SCHOLAR: 60/min
  - TTS downloads (monthly):
    - FREE: 0 (not available), PRO: 5/month, SCHOLAR: 10000/month (unlimited)
  - File uploads (hourly):
    - FREE: 5/hour, PRO: 20/hour, SCHOLAR: 50/hour
  - General API (per-minute):
    - FREE: 60/min, PRO: 300/min, SCHOLAR: 1000/min
- Implemented core functions:
  - getRateLimitConfig: Get limit configuration for operation and tier
  - checkRateLimit: Check and consume rate limit for user
  - getRateLimitStatus: Check rate limit without consuming
  - resetRateLimit: Reset rate limit for user (for testing/tier upgrades)
  - createRateLimitKey: Generate Redis key with daily date for daily limits
- Implemented response helpers:
  - createRateLimitHeaders: Generate X-RateLimit-* headers
  - applyRateLimitHeaders: Apply headers to VercelResponse
  - createRateLimitResponse: Generate 429 response body with retryAfter
- Implemented higher-order middleware:
  - withRateLimit: Wrap handler with rate limiting, requires withAuth
  - createRateLimitChecker: Create operation-specific checker function
- Features:
  - Uses Upstash Redis with sliding window algorithm
  - Fail-open design: if Redis unavailable, requests are allowed
  - Daily limits reset at midnight UTC with date in key
  - Rate limit info attached to request.rateLimit
  - Proper X-RateLimit-* headers on all responses
  - Retry-After header on 429 responses
  - Operation name included in rate limit response
- Exported rateLimitUtils object with all functions
- Updated src/middleware/index.ts to export all rate limit utilities
- Created comprehensive test suite with 75 tests in rateLimit.test.ts:
  - getRateLimitConfig tests for all operations and tiers (27 tests)
  - Tier hierarchy tests (higher tiers have higher/equal limits)
  - createRateLimitHeaders tests (7 tests)
  - createRateLimitResponse tests (10 tests)
  - Type export tests
  - Edge case tests (unknown operations, all tier values)
  - Daily vs non-daily limit behavior tests (5 tests)
  - Window duration validation tests (5 tests)
  - rateLimitUtils export verification (9 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2111 tests total: 257 api + 172 database + 12 web + 1670 shared)
- Files: apps/api/src/middleware/rateLimit.ts, apps/api/src/middleware/rateLimit.test.ts, apps/api/src/middleware/index.ts, apps/api/package.json

## Iteration 40

[2026-01-17] api-infra-005: Set up Winston logging
- Created apps/api/src/middleware/logger.ts with comprehensive logging middleware
- Implemented Winston logger with environment-aware configuration:
  - Production: JSON format for log aggregation tools
  - Development: Colorized, human-readable format with timestamps
  - Configurable log level via LOG_LEVEL environment variable
  - Default: info in production, debug in development
- Created Logger class with request context:
  - RequestContext type: requestId, userId, method, path, userAgent, ip, sessionId
  - child() method for creating child loggers with merged context
  - All log levels: error(), warn(), info(), http(), debug()
  - logError() method for structured error logging with stack traces
  - getContext() method for retrieving current context
- Implemented request utilities:
  - generateRequestId(): Generates unique request IDs (req_{timestamp}_{random})
  - extractRequestContext(): Extracts context from VercelRequest
  - createRequestLogger(): Creates Logger instance from request
- Implemented specialized logging functions:
  - logRequest(): Log incoming API requests
  - logResponse(): Log API responses with status codes and duration
  - logError(): Log errors with context
  - logAIUsage(): Log AI API calls with tokens, cost, duration, success
  - logPerformance(): Log performance metrics
  - logAudit(): Log audit events for compliance tracking
  - logSecurity(): Log security events (auth failures, rate limits)
- Implemented withRequestLogging() higher-order middleware:
  - Automatically generates requestId for each request
  - Attaches requestId and Logger instance to request
  - Sets X-Request-ID response header
  - Logs request start with method, path, query
  - Logs request completion with status code and duration
  - Logs errors if handler throws
  - Works with async handlers
- Created loggerUtils object bundling all utilities
- Updated src/middleware/index.ts to export all logger types and functions
- Updated src/index.ts to resolve export conflicts:
  - Response utilities exported from utils (no conflict)
  - Logger middleware exports take precedence (more comprehensive)
- Created comprehensive test suite with 81 tests in logger.test.ts:
  - Type export tests (5 tests)
  - Logger class tests (7 tests)
  - Global logger tests (2 tests)
  - generateRequestId tests (4 tests)
  - extractRequestContext tests (7 tests)
  - createRequestLogger tests (2 tests)
  - Logging helper function tests (15 tests)
  - withRequestLogging middleware tests (6 tests)
  - loggerUtils export tests (13 tests)
  - Edge case tests (7 tests)
  - Integration tests (2 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2192 tests total: 338 api + 172 database + 12 web + 1670 shared)
- Files: apps/api/src/middleware/logger.ts, apps/api/src/middleware/logger.test.ts, apps/api/src/middleware/index.ts, apps/api/src/index.ts

## Iteration 41

[2026-01-17] api-infra-006: Create Prisma database service
- Created apps/api/src/services/db.ts with comprehensive database service
- Implemented singleton Prisma client pattern:
  - Re-exports prisma client from @read-master/database package
  - db constant for direct Prisma access
  - getDb() function as alias for explicit usage
- Implemented connection management for Vercel serverless:
  - ensureConnection(): Lazy connection with deduplication
  - gracefulShutdown(): Safe disconnection for shutdown handlers
  - isDbConnected(): Check current connection state
  - Internal state tracking to prevent duplicate connections
  - Re-exports connect/disconnect from @read-master/database
- Implemented query helpers for common operations:
  - getUserByClerkId(): Find user by Clerk ID with options
  - getUserById(): Find user by internal ID with options
  - getBookById(): Find book by ID with options
  - getBookWithChapters(): Convenience function for book with chapters
  - getReadingProgress(): Get progress by userId and bookId
  - upsertReadingProgress(): Create or update reading progress
  - GetUserOptions type: includeBooks, includeStats, includeAchievements
  - GetBookOptions type: includeChapters, includePreReadingGuide, includeAnnotations
- Implemented soft delete helpers:
  - withSoftDeleteFilter(): Add deletedAt: null to where clause
  - softDeleteUser(): Soft delete user by setting deletedAt
  - softDeleteBook(): Soft delete book by setting deletedAt
  - SoftDeletableModel type for all soft-deletable models
- Implemented transaction helpers:
  - withTransaction(): Interactive transaction with callback
  - batchTransaction(): Execute multiple operations in batch
  - TransactionClient type for transaction context
- Created dbUtils object bundling all utilities
- Created apps/api/src/services/index.ts for clean exports
- Updated apps/api/src/index.ts to export all services
- Created comprehensive test suite with 46 tests in db.test.ts:
  - Used vi.hoisted() pattern for proper mock hoisting with Vitest
  - Singleton client tests (2 tests)
  - Connection management tests (7 tests)
  - Query helper tests (18 tests)
  - Soft delete helper tests (5 tests)
  - Transaction helper tests (3 tests)
  - dbUtils export tests (4 tests)
  - Type export tests (4 tests)
  - Edge case tests (3 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (384 api tests)
- Files: apps/api/src/services/db.ts, apps/api/src/services/db.test.ts, apps/api/src/services/index.ts, apps/api/src/index.ts

## Iteration 42

[2026-01-17] api-infra-007: Create Redis cache service
- Created apps/api/src/services/redis.ts with comprehensive caching functionality
- Implemented Upstash Redis client singleton with proper initialization:
  - getRedisClient(): Get the Redis client instance (returns null if not configured)
  - isRedisAvailable(): Check if Redis is available
  - resetRedisClient(): Reset client for testing
  - Fail-gracefully pattern: returns null/false when Redis unavailable
- Implemented core cache operations:
  - get<T>(): Get value from cache with optional TTL refresh
  - set<T>(): Set value with TTL, NX, XX options
  - del(): Delete single key
  - delMany(): Delete multiple keys
  - exists(): Check if key exists
  - expire(): Set TTL on existing key
  - ttl(): Get remaining TTL of a key
- Implemented advanced cache operations:
  - getOrSet<T>(): Get from cache or fetch and cache if missing
  - mget<T>(): Get multiple values at once
  - mset<T>(): Set multiple key-value pairs with optional TTL
  - incr(): Increment numeric value
  - decr(): Decrement numeric value
- Implemented cache invalidation helpers:
  - invalidatePattern(): Delete keys matching glob pattern using SCAN
  - invalidateUserCache(): Invalidate all cache for a user
  - invalidateBookCache(): Invalidate all cache for a book
- Implemented cache key builders for organized namespacing:
  - buildKey(): Generic key builder with prefix
  - userKey(): User-specific keys
  - bookKey(): Book-specific keys
  - progressKey(): Reading progress keys
  - guideKey(): Pre-reading guide keys
  - searchKey(): Search result keys with normalization
  - leaderboardKey(): Leaderboard keys with pagination
- Defined cache constants:
  - CacheKeyPrefix: USER, BOOK, PROGRESS, GUIDE, FLASHCARD, ASSESSMENT, SEARCH, API, LEADERBOARD, FORUM, SESSION
  - CacheTTL: VERY_SHORT (60s), SHORT (5m), MEDIUM (15m), LONG (1h), VERY_LONG (6h), DAY, WEEK, MONTH
- Implemented higher-order utility functions:
  - withCache(): Create cached version of async function
  - withInvalidation(): Wrap function with cache invalidation
- Created cache and cacheUtils export objects for clean imports
- Updated apps/api/src/services/index.ts to export all Redis cache exports
- Created comprehensive test suite with 122 tests in redis.test.ts:
  - Type export tests (5 tests)
  - CacheKeyPrefix constant tests (11 tests)
  - CacheTTL constant tests (8 tests)
  - Client management tests (7 tests)
  - Core cache operation tests (get: 6, set: 8, del: 4, delMany: 4, exists: 4, expire: 3, ttl: 4)
  - Advanced operation tests (getOrSet: 3, mget: 3, mset: 3, incr: 3, decr: 3)
  - Cache invalidation tests (7 tests)
  - Cache key builder tests (13 tests)
  - Higher-order utility tests (4 tests)
  - cache/cacheUtils object tests (7 tests)
  - Edge case tests (5 tests)
  - Error handling tests (7 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (506 api tests)
- Files: apps/api/src/services/redis.ts, apps/api/src/services/redis.test.ts, apps/api/src/services/index.ts

## Iteration 43

[2026-01-17] api-infra-010: Create health check endpoint
- Enhanced apps/api/api/health.ts with comprehensive service health checks
- Implemented database health check using Prisma $queryRaw:
  - Executes SELECT 1 to verify database connectivity
  - Captures latency for performance monitoring
  - Handles errors gracefully with descriptive messages
- Implemented Redis health check using Upstash Redis ping:
  - Verifies Redis is available via isRedisAvailable()
  - Executes ping command expecting "PONG" response
  - Handles unconfigured Redis gracefully (not an error)
  - Captures latency for performance monitoring
- Defined health check response types:
  - ServiceCheck: status ("ok" | "error"), latency?, error?
  - HealthResponse: status ("healthy" | "degraded" | "unhealthy"), timestamp, version, environment, checks
- Implemented determineOverallStatus() logic:
  - "healthy": All services OK
  - "degraded": Database OK but Redis has issues (non-critical, caching disabled)
  - "unhealthy": Database down (critical service failure)
- Proper HTTP status codes:
  - 200: healthy or degraded (service is operational)
  - 503: unhealthy (critical service unavailable)
- Health checks run in parallel using Promise.all for efficiency
- Created comprehensive test suite with 29 tests in health.test.ts:
  - Used vi.hoisted() pattern for proper mock hoisting with Vitest
  - Tests for healthy scenario (9 tests): status code, response format, timestamps, versions
  - Tests for database unhealthy (4 tests): 503 status, unhealthy response, error messages
  - Tests for Redis unhealthy (4 tests): 200 status (degraded), error messages
  - Tests for Redis not configured (3 tests): treated as healthy (caching optional)
  - Tests for Redis client null (2 tests): graceful handling
  - Tests for unexpected ping response (2 tests): descriptive error messages
  - Tests for both services unhealthy (3 tests): 503 status, error details
  - Error handling edge cases (2 tests): non-Error exceptions
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (529 api tests, 2383 total)
- Files: apps/api/api/health.ts, apps/api/api/health.test.ts

## Iteration 44

[2026-01-17] api-infra-008: Create response utilities
- Enhanced apps/api/src/utils/response.ts with comprehensive response utilities
- Added new response types:
  - PaginationMeta: Standalone pagination metadata type
  - ApiNoContentResponse: 204 response type
  - ApiAcceptedResponse: 202 async operation response type
- Implemented new response sending functions:
  - sendCreated<T>(): Send 201 responses for resource creation
  - sendNoContent(): Send 204 responses for DELETE operations
  - sendAccepted<T>(): Send 202 responses for async operations
- Implemented response creation functions (for testing/serialization):
  - createSuccessResponse<T>(): Create success response objects
  - createPaginatedResponse<T>(): Create paginated response objects
  - createErrorResponse(): Create error response objects
  - calculatePaginationMeta(): Calculate pagination metadata
- Implemented type guard functions:
  - isSuccessResponse<T>(): Type-safe check for success responses
  - isErrorResponse<T>(): Type-safe check for error responses
- Created namespaced response objects for clean imports:
  - response: Object containing all response sending functions
  - responseUtils: Object containing all response utility functions
- Updated apps/api/src/utils/index.ts to export all new utilities and types
- Created comprehensive test suite with 48 tests in response.test.ts:
  - sendSuccess tests (4 tests)
  - sendPaginated tests (5 tests)
  - sendError tests (4 tests)
  - ErrorCodes tests (2 tests)
  - sendCreated tests (2 tests)
  - sendNoContent tests (1 test)
  - sendAccepted tests (2 tests)
  - createSuccessResponse tests (4 tests)
  - createPaginatedResponse tests (4 tests)
  - createErrorResponse tests (4 tests)
  - calculatePaginationMeta tests (6 tests)
  - isSuccessResponse tests (3 tests)
  - isErrorResponse tests (3 tests)
  - response object tests (2 tests)
  - responseUtils object tests (2 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (562 api tests)
- Files: apps/api/src/utils/response.ts, apps/api/src/utils/response.test.ts, apps/api/src/utils/index.ts


## Iteration 45

[2026-01-17] api-infra-009: Create pagination utilities
- Created comprehensive apps/api/src/utils/pagination.ts with full pagination support
- Implemented PaginationDefaults constants:
  - DEFAULT_PAGE: 1, DEFAULT_LIMIT: 20, MAX_LIMIT: 100
  - MIN_PAGE: 1, MIN_LIMIT: 1
- Defined comprehensive types:
  - PaginationParams: page, limit, offset
  - PrismaPagination: skip, take
  - ParsePaginationOptions: defaultLimit, maxLimit, defaultPage
  - RawPaginationQuery: supports multiple parameter name conventions
  - CursorPaginationParams: cursor, limit, direction
  - CursorPaginationResult<T>: items, nextCursor, previousCursor, hasMore
  - PaginationResult: comprehensive metadata (page, limit, total, totalPages, offset, skip, take, hasNext, hasPrevious, firstPage, lastPage, startItem, endItem)
- Created Zod validation schemas:
  - paginationQuerySchema: page-based pagination with coercion
  - offsetPaginationSchema: offset-based pagination
  - cursorPaginationSchema: cursor-based with direction support
- Implemented core parsing functions:
  - parseQueryNumber(): Parse query param values to numbers
  - parsePaginationParams(): Parse with alternative param names (per_page, perPage, pageSize)
- Implemented Prisma-compatible functions:
  - calculatePrismaPagination(): Convert page/limit to skip/take
  - calculatePrismaPaginationFromOffset(): Convert offset/limit to skip/take
- Implemented calculation functions:
  - calculatePagination(): Full pagination result with all metadata
  - calculatePaginationFromOffset(): Full result from offset-based params
- Implemented cursor-based pagination helpers:
  - encodeCursor(): Base64url encode cursor from string/number/Date
  - decodeCursor(): Decode cursor back to original value
  - parseCursorPaginationParams(): Parse cursor pagination query
  - buildCursorPaginationResult<T>(): Build cursor result with hasMore detection
- Implemented utility functions:
  - isValidPage(): Check if page number is valid for total
  - getLastPage(): Get last valid page number
  - clampPage(): Clamp page to valid range
  - getPageNumbers(): Generate page numbers for pagination UI (with ellipsis support)
  - getItemRange(): Calculate displayed item range (1-indexed)
- Created namespaced exports for clean imports:
  - pagination: Object with all functions
  - paginationSchemas: Object with all Zod schemas
- Updated apps/api/src/utils/index.ts to export all pagination utilities and types
- Created comprehensive test suite with 98 tests in pagination.test.ts:
  - PaginationDefaults tests (2 tests)
  - parseQueryNumber tests (8 tests)
  - parsePaginationParams tests (12 tests)
  - calculatePrismaPagination tests (4 tests)
  - calculatePrismaPaginationFromOffset tests (3 tests)
  - calculatePagination tests (7 tests)
  - calculatePaginationFromOffset tests (3 tests)
  - Cursor pagination tests (encodeCursor: 3, decodeCursor: 3, parseCursorPaginationParams: 5, buildCursorPaginationResult: 3)
  - Utility function tests (isValidPage: 4, getLastPage: 3, clampPage: 4, getPageNumbers: 5, getItemRange: 3)
  - Zod schema tests (paginationQuerySchema: 5, offsetPaginationSchema: 3, cursorPaginationSchema: 3)
  - Namespace export tests (2 tests)
  - Type export tests (7 tests)
  - Integration tests (2 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2502 tests)
- Files: apps/api/src/utils/pagination.ts, apps/api/src/utils/pagination.test.ts, apps/api/src/utils/index.ts


## Iteration 46

[2026-01-17] api-books-001: Create Cloudflare R2 storage service
- Created comprehensive apps/api/src/services/storage.ts with full R2 storage support
- Added AWS S3 SDK dependencies (@aws-sdk/client-s3, @aws-sdk/s3-request-presigner)
- Implemented R2 client singleton with lazy initialization:
  - getStorageClient(): Get or create R2 S3 client
  - isStorageAvailable(): Check if R2 is configured
  - resetStorageClient(): Reset for testing
  - getBucketName(): Get configured bucket name
  - getPublicUrlBase(): Get public CDN URL if configured
- Defined comprehensive types:
  - UploadOptions: contentType, cacheControl, metadata, contentDisposition
  - SignedUrlOptions: expiresIn, contentDisposition, responseContentType
  - ListOptions: maxKeys, continuationToken, delimiter
  - UploadResult: success, key, bucket, publicUrl, error
  - GetFileResult: success, data, contentType, contentLength, metadata, error
  - FileInfo: exists, contentType, contentLength, lastModified, etag, metadata
  - ListResult: success, keys, prefixes, isTruncated, nextContinuationToken, error
- Implemented core storage operations:
  - uploadFile(): Upload file with options (contentType, cacheControl, metadata)
  - getFile(): Download file as Buffer with metadata
  - deleteFile(): Delete single file
  - deleteFiles(): Bulk delete multiple files
  - getFileInfo(): Get file metadata without downloading (HEAD request)
  - fileExists(): Check if file exists
  - listFiles(): List files with prefix and pagination support
  - copyFile(): Copy file within bucket
- Implemented signed URL generation:
  - getSignedDownloadUrl(): Generate presigned download URL
  - getSignedUploadUrl(): Generate presigned upload URL
  - getSignedUrl(): Alias for download URL (convenience)
- Implemented storage key builders for organized namespacing:
  - buildBookKey(): users/{userId}/books/{bookId}/{filename}
  - buildCoverKey(): covers/{bookId}/{filename}
  - buildAudioKey(): users/{userId}/audio/{bookId}/{filename}
  - buildAvatarKey(): users/{userId}/avatars/{filename}
  - buildTempKey(): temp/{uniqueId}/{filename}
  - getFilenameFromKey(): Extract filename from path
  - getExtension(): Get file extension (lowercase)
  - inferContentType(): Auto-detect content type from extension
- Defined constants for namespacing and validation:
  - StorageNamespace: BOOKS, COVERS, AUDIO, AVATARS, TEMP
  - MaxFileSize: BOOK (50MB), COVER (5MB), AUDIO (500MB), AVATAR (2MB)
  - ContentTypes: PDF, EPUB, DOC, DOCX, TXT, HTML, MP3, WAV, OGG, M4A, JPEG, PNG, WEBP, GIF
  - BookExtensions, ImageExtensions, AudioExtensions: Arrays for validation
- Implemented validation helpers:
  - isValidFileSize(): Validate file size against limits
  - hasAllowedExtension(): Check if file extension is allowed
- Created namespaced exports for clean imports:
  - storage: Object with all core operations
  - storageUtils: Object with client management, validation, and constants
- Updated apps/api/src/services/index.ts to export all storage utilities and types
- Created comprehensive test suite with 115 tests in storage.test.ts:
  - Type export tests (8 tests)
  - StorageNamespace tests (5 tests)
  - MaxFileSize tests (4 tests)
  - ContentTypes tests (4 tests)
  - File extensions tests (3 tests)
  - Client management tests (11 tests)
  - uploadFile tests (7 tests)
  - getFile tests (5 tests)
  - deleteFile tests (3 tests)
  - deleteFiles tests (3 tests)
  - getFileInfo tests (4 tests)
  - fileExists tests (2 tests)
  - listFiles tests (7 tests)
  - copyFile tests (3 tests)
  - getSignedDownloadUrl tests (4 tests)
  - getSignedUploadUrl tests (3 tests)
  - getSignedUrl tests (1 test)
  - Key builder tests (buildBookKey: 1, buildCoverKey: 1, buildAudioKey: 1, buildAvatarKey: 1, buildTempKey: 1)
  - getFilenameFromKey tests (3 tests)
  - getExtension tests (4 tests)
  - inferContentType tests (9 tests)
  - isValidFileSize tests (5 tests)
  - hasAllowedExtension tests (4 tests)
  - storage object tests (3 tests)
  - storageUtils object tests (3 tests)
  - Integration tests (2 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2629 tests)
- Files: apps/api/src/services/storage.ts, apps/api/src/services/storage.test.ts, apps/api/src/services/index.ts


## Iteration 47

[2026-01-17] api-books-002: Create book parsing service for EPUB files
- Created comprehensive apps/api/src/services/books.ts with full EPUB parsing support
- Added epub ^1.3.0 dependency for EPUB file parsing
- Implemented core parsing functions:
  - parseEPUB(): Parse EPUB file from path with full extraction
  - parseEPUBFromBuffer(): Parse EPUB from buffer (creates temp file)
  - isValidEPUB(): Validate EPUB file by checking ZIP signature and structure
- Defined comprehensive types:
  - BookMetadata: title, author, language, description, publisher, publicationDate, isbn, subjects, rights, identifier
  - ChapterInfo: id, title, order, level, href, wordCount, content
  - CoverImage: data (Buffer), mimeType, filename
  - ParsedBook: Complete parsed book with metadata, chapters, totalWordCount, coverImage, rawContent, estimatedReadingTimeMinutes, hasDRM
  - ParseOptions: extractCover, extractContent, maxChapters
  - ParseResult<T>: Generic result wrapper with success, data, error
- Implemented metadata extraction:
  - extractMetadata(): Extract all book metadata from EPUB
  - extractISBN(): Extract ISBN-10 or ISBN-13 from identifier
  - extractIdentifier(): Extract unique book identifier
  - Handles subject as string or array
- Implemented chapter extraction:
  - extractChapters(): Extract all chapters with content and word count
  - Uses table of contents or spine flow
  - Strips HTML from content for plain text
  - Limits chapters based on maxChapters option
- Implemented cover image extraction:
  - extractCoverImage(): Find and extract cover image
  - Searches common cover IDs: cover, cover-image, coverimage, etc.
  - Falls back to searching manifest by filename patterns
  - Returns Buffer with mimeType and filename
- Implemented utility functions:
  - countWords(): Count words in text (strips HTML first)
  - stripHtmlTags(): Remove HTML tags, script/style content, decode entities
  - calculateReadingTime(): Calculate reading time in minutes from word count
  - generateContentHash(): Generate SHA-256 hash for deduplication
  - getEPUBExtension(): Returns ".epub" for file extension checks
- Defined constants:
  - AVERAGE_READING_WPM: 250 words per minute
  - EPUB_MIME_TYPES: ["application/epub+zip", "application/epub"]
  - DEFAULT_PARSE_OPTIONS: extractCover: true, extractContent: true, maxChapters: 500
- Created namespaced exports:
  - bookParser: All parsing functions and constants
  - bookUtils: Utility functions for word counting, HTML stripping, etc.
- Updated apps/api/src/services/index.ts to export all book parsing utilities
- Created comprehensive test suite with 83 tests in books.test.ts:
  - Type export tests (6 tests)
  - Constants tests (AVERAGE_READING_WPM: 1, EPUB_MIME_TYPES: 3, DEFAULT_PARSE_OPTIONS: 3)
  - countWords tests (12 tests including empty, whitespace, HTML, unicode)
  - stripHtmlTags tests (11 tests including script/style removal, entities)
  - calculateReadingTime tests (9 tests including edge cases)
  - generateContentHash tests (5 tests)
  - getEPUBExtension tests (1 test)
  - parseEPUB tests (2 tests for error cases)
  - parseEPUBFromBuffer tests (2 tests for invalid input)
  - isValidEPUB tests (3 tests for non-existent, non-zip, empty files)
  - bookParser object tests (10 tests)
  - bookUtils object tests (5 tests)
  - Integration tests (2 tests)
  - Edge cases (8 tests: very long text, unicode, emoji, malformed HTML, etc.)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2712 tests)
- Files: apps/api/src/services/books.ts, apps/api/src/services/books.test.ts, apps/api/src/services/index.ts, apps/api/package.json


## Iteration 48

[2026-01-17] api-books-003: Create book parsing service for PDF files
- Added pdf-parse ^2.4.5 dependency for PDF file parsing (new 2.x API with class-based approach)
- Extended apps/api/src/services/books.ts with comprehensive PDF parsing support
- Defined PDF-specific types:
  - PDFMetadata: title, author, subject, creator, producer, creationDate, modificationDate, pageCount, pdfVersion, isEncrypted
  - PDFSection: id, title, order, level, startOffset, endOffset, wordCount, content
  - ParsedPDF: metadata, sections, totalWordCount, rawContent, estimatedReadingTimeMinutes, pageCount
  - PDFParseOptions: extractContent, detectSections, maxPages
- Implemented core PDF parsing functions:
  - parsePDF(): Parse PDF file from path
  - parsePDFFromBuffer(): Parse PDF from buffer (main implementation)
  - isValidPDF(): Validate PDF file by checking signature and structure
  - getPDFExtension(): Returns ".pdf" for file extension checks
- Implemented metadata extraction from PDFParse InfoResult:
  - Extracts title, author, subject, creator, producer
  - Uses DateNode for proper date handling (CreationDate, ModDate)
  - Detects encryption state and PDF version
- Implemented section/chapter detection for PDFs:
  - detectPDFSections(): Detect sections from text content
  - Pattern matching for chapter headings (Chapter X, Part X, Section X, etc.)
  - Detection of all-caps headers as section markers
  - Falls back to single "Main Content" section if no sections detected
  - Tracks word count and content offsets for each section
- Added constants:
  - PDF_MIME_TYPES: ["application/pdf"]
  - PDF_SIGNATURE: Buffer for %PDF- magic bytes
  - CHAPTER_PATTERNS: Array of regex patterns for chapter detection
  - DEFAULT_PDF_PARSE_OPTIONS: extractContent: true, detectSections: true, maxPages: 5000
- Implemented PDF validation:
  - isPDFBuffer(): Check if buffer starts with PDF signature (%PDF-)
  - Proper resource cleanup with parser.destroy() in finally blocks
- Created namespaced exports:
  - pdfParser: PDF-specific parsing functions and constants
  - Updated bookParser: Added PDF functions alongside EPUB functions
  - Updated bookUtils: Added getPDFExtension function
- Updated apps/api/src/services/index.ts to export all PDF utilities and types
- Added 42 new PDF-specific tests to books.test.ts:
  - PDF Type export tests (4 tests)
  - PDF Constants tests (4 tests for PDF_MIME_TYPES, DEFAULT_PDF_PARSE_OPTIONS)
  - getPDFExtension tests (1 test)
  - parsePDF tests (3 tests for error cases)
  - parsePDFFromBuffer tests (5 tests for empty, invalid, signature-only buffers)
  - isValidPDF tests (4 tests for non-existent, non-PDF, empty, fake signature files)
  - pdfParser object tests (6 tests)
  - bookParser PDF exports tests (6 tests)
  - bookUtils PDF exports tests (1 test)
  - PDF edge cases (4 tests)
  - PDF integration tests (3 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2570 tests)
- Files: apps/api/src/services/books.ts, apps/api/src/services/books.test.ts, apps/api/src/services/index.ts, apps/api/package.json


## Iteration 49

[2026-01-17] api-books-004: Create book parsing service for DOC/DOCX files
- Added mammoth ^1.11.0 dependency for DOCX file parsing
- Extended apps/api/src/services/books.ts with comprehensive DOCX parsing support
- Defined DOCX-specific types:
  - DOCXMetadata: title, author, description, subject, creator, lastModifiedBy, revision, created, modified
  - DOCXSection: id, title, order, level, startOffset, endOffset, wordCount, content
  - ParsedDOCX: metadata, sections, totalWordCount, rawContent, htmlContent, estimatedReadingTimeMinutes, messages
  - DOCXParseMessage: type (warning | error), message
  - DOCXParseOptions: extractContent, detectSections, includeHtml
- Implemented core DOCX parsing functions:
  - parseDOCX(): Parse DOCX file from path
  - parseDOCXFromBuffer(): Parse DOCX from buffer (main implementation)
  - isValidDOCX(): Validate DOCX file by checking ZIP signature and mammoth parsing
  - getDOCXExtension(): Returns ".docx" for file extension checks
- Implemented DOCX content extraction using mammoth:
  - mammoth.convertToHtml(): Extract HTML content with formatting
  - mammoth.extractRawText(): Extract plain text content
  - Captures mammoth warnings and errors in messages array
- Implemented section/chapter detection for DOCX files:
  - detectDOCXSections(): Detect sections from content
  - HTML heading extraction: Uses regex to find h1-h6 tags in HTML output
  - Text-based fallback: Uses CHAPTER_PATTERNS for chapter/section detection
  - All-caps header detection for section markers
  - Falls back to single "Main Content" section if no sections detected
  - Tracks word count, content offsets, and heading levels
- Added constants:
  - DOCX_MIME_TYPES: ["application/vnd.openxmlformats-officedocument.wordprocessingml.document", "application/msword"]
  - DOCX_SIGNATURE: Buffer for PK\x03\x04 ZIP magic bytes
  - DEFAULT_DOCX_PARSE_OPTIONS: extractContent: true, detectSections: true, includeHtml: true
- Implemented DOCX validation:
  - isDOCXBuffer(): Check if buffer starts with ZIP signature (PK\x03\x04)
  - Uses mammoth.extractRawText() to verify valid DOCX structure
- Created namespaced exports:
  - docxParser: DOCX-specific parsing functions and constants
  - Updated bookParser: Added DOCX functions alongside EPUB and PDF functions
  - Updated bookUtils: Added getDOCXExtension function
- Updated apps/api/src/services/index.ts to export all DOCX utilities and types
- Added 45 new DOCX-specific tests to books.test.ts:
  - DOCX Type export tests (5 tests for DOCXMetadata, DOCXSection, ParsedDOCX, DOCXParseOptions, DOCXParseMessage)
  - DOCX Constants tests (5 tests for DOCX_MIME_TYPES, DEFAULT_DOCX_PARSE_OPTIONS)
  - getDOCXExtension tests (1 test)
  - parseDOCX tests (3 tests for error cases)
  - parseDOCXFromBuffer tests (5 tests for empty, null, invalid, signature-only buffers)
  - isValidDOCX tests (4 tests for non-existent, non-DOCX, empty, fake signature files)
  - docxParser object tests (6 tests)
  - bookParser DOCX exports tests (6 tests)
  - bookUtils DOCX exports tests (1 test)
  - DOCX edge cases (4 tests)
  - DOCX integration tests (3 tests)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2798 tests)
- Files: apps/api/src/services/books.ts, apps/api/src/services/books.test.ts, apps/api/src/services/index.ts, apps/api/package.json


## Iteration 50

[2026-01-18] api-books-005: Create Google Books API service
- Created apps/api/src/services/googleBooks.ts with comprehensive Google Books API integration
- Defined Google Books-specific types:
  - GoogleBookMetadata: Normalized book metadata with id, title, subtitle, authors, publisher, publishedDate, description, ISBN-10/13, pageCount, categories, ratings, imageLinks, saleInfo, accessInfo
  - GoogleBooksSearchOptions: maxResults, startIndex, langRestrict, orderBy, printType, filter, inField (title, author, publisher, subject, isbn), useCache
  - GoogleBooksSearchResult: totalItems, items, hasMore, startIndex, query
  - GoogleBooksError: Custom error class with statusCode, code, retryable properties
- Implemented core search functions:
  - searchBooks(): Full-featured search with pagination, filters, caching, rate limiting
  - searchByISBN(): Search by ISBN-10 or ISBN-13 (cleans hyphens/spaces)
  - searchByAuthor(): Search by author name using inauthor: operator
  - searchByTitle(): Search by title using intitle: operator
- Implemented details function:
  - getBookDetails(): Fetch detailed book info by Google Books volume ID
- Implemented API response normalization:
  - Extracts ISBN-10 and ISBN-13 from industryIdentifiers
  - Upgrades HTTP image URLs to HTTPS
  - Normalizes imageLinks with proper optional property handling
  - Extracts sale info (price, saleability, isEbook)
  - Extracts access info (isTextReadable, isPdfAvailable, isEpubAvailable)
- Implemented caching using Redis:
  - Search results cached for 15 minutes (SEARCH_CACHE_TTL)
  - Book details cached for 1 hour (DETAILS_CACHE_TTL)
  - Cache key builders for search and details
  - invalidateSearchCache() and invalidateDetailsCache() helpers
- Implemented rate limiting:
  - Request queue with 1 request per second limit
  - Exponential backoff retry on 429 responses (up to 3 retries)
  - fetchWithRetry() handles transient failures
- Implemented error handling:
  - GoogleBooksError class with statusCode, code, retryable properties
  - Parses API error responses for detailed messages
  - Graceful handling of 404 (returns null instead of throwing)
- Added utility functions:
  - getBestImageUrl(): Get best available image for preferred size (small/medium/large)
  - isGoogleBooksConfigured(): Check if API key is set
- Added constants:
  - GOOGLE_BOOKS_API_BASE: "https://www.googleapis.com/books/v1"
  - DEFAULT_SEARCH_OPTIONS: maxResults: 10, startIndex: 0, orderBy: "relevance", printType: "books", useCache: true
  - MAX_RESULTS_LIMIT: 40 (API limit)
- Created namespaced exports:
  - googleBooks: All functions and utilities
  - googleBooksUtils: Utility functions for external use
- Updated apps/api/src/services/index.ts with all Google Books exports
- Added 64 new Google Books tests to googleBooks.test.ts:
  - Type export tests (3 tests)
  - Constants tests (5 tests)
  - GoogleBooksError tests (4 tests)
  - isGoogleBooksConfigured tests (3 tests)
  - getBestImageUrl tests (7 tests)
  - searchBooks tests (10 tests)
  - getBookDetails tests (5 tests)
  - searchByISBN tests (5 tests)
  - searchByAuthor tests (1 test)
  - searchByTitle tests (1 test)
  - googleBooks object tests (4 tests)
  - googleBooksUtils object tests (2 tests)
  - Index exports tests (6 tests)
  - Volume normalization edge cases (6 tests)
  - Rate limiting tests (1 test)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2862 tests)
- Files: apps/api/src/services/googleBooks.ts, apps/api/src/services/googleBooks.test.ts, apps/api/src/services/index.ts


## Iteration 51

[2026-01-18] api-books-006: Create Open Library API service
- Created apps/api/src/services/openLibrary.ts with comprehensive Open Library API integration
- Defined Open Library-specific types:
  - OpenLibraryBookMetadata: Normalized book metadata with workId, editionId, title, subtitle, authors (with id/name), firstPublishYear, publishYear, publishers, ISBN-10/13, pageCount, subjects, description, coverIds, languages, editionCount, isPublicDomain, hasFullText, iaIds, averageRating, ratingsCount, reading counts
  - OpenLibrarySearchOptions: limit, offset, sort (relevance, new, old, rating, editions), language, fields (title, author, subject, publisher, isbn, firstPublishYear), useCache
  - OpenLibrarySearchResult: totalItems, items, hasMore, offset, query
  - OpenLibraryBookContent: editionId, title, iaId, formats (epub, pdf, text, mobi), textContent, hasTextContent
  - OpenLibraryError: Custom error class with statusCode, code, retryable properties
- Implemented core search functions:
  - searchOpenLibrary(): Full-featured search with pagination, filters, caching, rate limiting
  - searchOpenLibraryByISBN(): Search by ISBN-10 or ISBN-13 (cleans hyphens/spaces)
  - searchOpenLibraryByAuthor(): Search by author name using author: field
  - searchOpenLibraryByTitle(): Search by title using title: field
- Implemented details functions:
  - getOpenLibraryWork(): Fetch detailed work info by Open Library Work ID (e.g., "OL123456W")
  - getOpenLibraryEdition(): Fetch detailed edition info by Edition ID (e.g., "OL123456M")
  - getOpenLibraryBookContent(): Access public domain book content from Internet Archive
- Implemented API response normalization:
  - Extracts and normalizes authors from search results (handles missing author_key)
  - Filters ISBN-10 and ISBN-13 from mixed ISBN arrays
  - Extracts most recent publish year from publish_year arrays
  - Handles description as string or { value: string } object
  - Extracts language codes from language objects
- Implemented caching using Redis:
  - Search results cached for 15 minutes (OL_SEARCH_CACHE_TTL)
  - Work details cached for 1 hour (OL_DETAILS_CACHE_TTL)
  - Edition details cached for 1 hour (OL_DETAILS_CACHE_TTL)
  - Author details cached for 1 hour (OL_AUTHOR_CACHE_TTL)
  - Cache key builders for search, work, edition, author
  - invalidateOpenLibrarySearchCache(), invalidateOpenLibraryWorkCache(), invalidateOpenLibraryEditionCache() helpers
- Implemented rate limiting:
  - Request queue with 1 request per second limit
  - Exponential backoff retry on 429 responses (up to 3 retries)
  - fetchWithRetry() handles transient failures
- Implemented error handling:
  - OpenLibraryError class with statusCode, code, retryable properties
  - Graceful handling of 404 (returns null instead of throwing)
  - Author fetch failures don't crash work/edition retrieval
- Implemented public domain content access:
  - Integrates with Internet Archive API to fetch book files
  - Detects available formats: epub, pdf, text, mobi
  - Generates download URLs for each format
- Added utility functions:
  - getOpenLibraryCoverUrl(): Build cover URL from cover ID and size (S, M, L)
  - getBestOpenLibraryCoverUrl(): Get best cover URL from metadata
  - extractIdFromKey(): Extract ID from full Open Library key paths
  - parseYear(): Parse year from various date formats
- Added constants:
  - OPEN_LIBRARY_API_BASE: "https://openlibrary.org"
  - INTERNET_ARCHIVE_BASE: "https://archive.org"
  - COVER_IMAGE_BASE: "https://covers.openlibrary.org"
  - DEFAULT_OL_SEARCH_OPTIONS: limit: 10, offset: 0, sort: "relevance", useCache: true
  - MAX_OL_RESULTS_LIMIT: 100
- Created namespaced exports:
  - openLibrary: All functions and utilities
  - openLibraryUtils: Utility functions for external use
- Updated apps/api/src/services/index.ts with all Open Library exports
- Added 77 new Open Library tests to openLibrary.test.ts:
  - Type export tests (4 tests)
  - Constants tests (7 tests)
  - OpenLibraryError tests (4 tests)
  - getOpenLibraryCoverUrl tests (3 tests)
  - getBestOpenLibraryCoverUrl tests (4 tests)
  - searchOpenLibrary tests (11 tests)
  - getOpenLibraryWork tests (5 tests)
  - getOpenLibraryEdition tests (4 tests)
  - getOpenLibraryBookContent tests (4 tests)
  - searchOpenLibraryByISBN tests (5 tests)
  - searchOpenLibraryByAuthor tests (1 test)
  - searchOpenLibraryByTitle tests (1 test)
  - openLibrary object tests (4 tests)
  - openLibraryUtils object tests (4 tests)
  - Index exports tests (8 tests)
  - Open Library normalization edge cases (6 tests)
  - Rate limiting tests (1 test)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (2939 tests)
- Files: apps/api/src/services/openLibrary.ts, apps/api/src/services/openLibrary.test.ts, apps/api/src/services/index.ts
## Iteration 52

[2026-01-18] api-books-007: Implement POST /api/books/upload endpoint
- Created apps/api/api/books/upload.ts with comprehensive file upload handling
- Implemented multipart/form-data parsing:
  - Handles file data from various sources (files object, base64 data URI, Buffer)
  - Extracts metadata fields (title, author, description, genre, tags, language, isPublic)
  - Uses parseMultipartForm() to handle Vercel's request body structure
- Added file type detection:
  - ALLOWED_MIME_TYPES maps MIME types to FileType enum (PDF, EPUB, DOCX, DOC, TXT, HTML)
  - EXTENSION_TO_FILE_TYPE provides fallback via file extension
  - getFileType() tries MIME type first, then falls back to extension
- Implemented file validation:
  - Size limit enforced via storageUtils.isValidFileSize() (max 50MB)
  - Type validation against supported file types
  - Zod schema for metadata validation (uploadMetadataSchema)
- Added tier limit checking:
  - Uses getTierLimits() and isWithinLimit() from @read-master/shared
  - Counts existing non-deleted books for user
  - Returns 403 with upgrade message when limit reached
- Implemented file parsing by type:
  - PDF: parsePDFFromBuffer() extracts content, metadata, word count
  - EPUB: parseEPUBFromBuffer() extracts content, metadata, cover image
  - DOCX/DOC: parseDOCXFromBuffer() extracts content, metadata
  - TXT/HTML: Direct string parsing with countWords() and calculateReadingTime()
- Implemented R2 storage:
  - storage.buildBookKey() generates unique storage path
  - storage.uploadFile() uploads to R2 with metadata
  - Cover images uploaded separately with buildCoverKey()
- Created Book record in database:
  - Uses Prisma db.book.create() with all extracted metadata
  - Supports user-provided metadata overrides
  - Includes chapters relation in response
- Added comprehensive error handling:
  - Validation errors with Zod error details
  - Parse failures with descriptive messages
  - Storage upload failures with retry suggestion
  - Proper HTTP status codes (400, 403, 404, 405, 500)
- Added @read-master/shared dependency to apps/api/package.json
- Created comprehensive tests in apps/api/api/books/upload.test.ts:
  - Method validation tests (405 for non-POST)
  - User validation tests (404 for missing user)
  - File validation tests (missing file, invalid type, size limit)
  - Tier limit tests (403 when limit exceeded)
  - Parsing tests (PDF, EPUB, DOCX success and failure cases)
  - Storage tests (upload success, upload failure)
  - Database creation tests (Book record created correctly)
  - Metadata override tests (user metadata takes precedence)
  - Response structure tests (correct fields in response)
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm test (1112 tests in apps/api)
- Files: apps/api/api/books/upload.ts, apps/api/api/books/upload.test.ts, apps/api/package.json

## Iteration 53

[2026-01-18] api-books-008: Implement POST /api/books/import-url endpoint
- Created apps/api/api/books/import-url.ts with comprehensive URL import handling
- Implemented URL validation:
  - Zod schema validation with importUrlSchema
  - Validates URL format with z.url()
  - Rejects non-http(s) protocols for security
  - Accepts optional metadata (title, author, description, genre, tags, language, isPublic)
- Implemented URL fetching:
  - fetchUrl() with configurable timeout (30s) and size limit (10MB)
  - Custom User-Agent for bot identification
  - Follows redirects automatically
  - Validates content-length before and after fetch
  - AbortController for timeout handling
- Implemented HTML article extraction (extractArticleFromHtml):
  - extractMetaContent() for name/property meta tags
  - extractTitle() for <title> tag extraction
  - extractFirstHeading() for <h1> fallback
  - extractMainContent() with priority-based content detection
  - Supports <article>, <main>, and content-class divs
  - Removes scripts, styles, and noscript tags
  - extractJsonLdAuthor() and extractJsonLdDate() for structured data
  - getDomainFromUrl() for fallback title
  - cleanTitle() to remove site name suffixes
  - decodeHtmlEntities() for HTML entity handling
- Implemented content type detection:
  - isHtmlContentType() for text/html, application/xhtml+xml, application/xml
  - isTextContentType() for text/plain, text/markdown
  - Rejects unsupported content types with descriptive error
- Implemented tier limit checking:
  - Uses getTierLimits() and isWithinLimit() from @read-master/shared
  - Counts existing non-deleted books for user
  - Returns 403 with upgrade message when limit reached
- Implemented Book record creation:
  - Uses Prisma db.book.create() with extracted metadata
  - Sets source as "URL" with sourceUrl field
  - Sets fileType as "HTML" for URL imports
  - User-provided metadata takes precedence over extracted
  - Returns book data with extraction metadata
- Added comprehensive error handling:
  - Fetch errors with descriptive messages
  - Timeout handling with AbortController
  - Content validation (minimum 10 characters)
  - Proper HTTP status codes (400, 403, 404, 405, 500)
- Created comprehensive tests in apps/api/api/books/import-url.test.ts (89 tests):
  - Schema validation tests:
    - URL validation (https, http, empty, invalid, protocols)
    - Title validation (valid, trim, max length)
    - Author validation (valid, max length, null)
    - Tags validation (array, max count, max length)
    - Language validation (2-char code)
    - isPublic validation (boolean)
  - HTML extraction tests:
    - extractMetaContent (name, property, content ordering, entities)
    - extractTitle (tag, whitespace, entities)
    - extractFirstHeading (h1, attributes, nested, null)
    - extractMainContent (article, main, content class, scripts, styles)
    - getDomainFromUrl (domain, www, subdomain, invalid)
    - cleanTitle (pipe, dash, en dash separators)
    - decodeHtmlEntities (amp, lt, gt, quot, numeric, hex, nbsp)
    - extractArticleFromHtml (complete data, fallbacks, JSON-LD)
  - Content type detection tests:
    - isHtmlContentType (html, xhtml, xml, charset)
    - isTextContentType (plain, markdown)
  - Constants tests (MAX_CONTENT_SIZE, FETCH_TIMEOUT_MS, USER_AGENT)
  - Edge cases:
    - Empty HTML, scripts only, nested entities, malformed HTML
    - Very long content (10k words)
    - URL with port, auth, localhost, IP address
  - Integration tests:
    - Wikipedia-style article extraction
    - Medium-style article extraction
    - News article with JSON-LD
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm vitest run (89 new tests)
- Files: apps/api/api/books/import-url.ts, apps/api/api/books/import-url.test.ts

## Iteration 54

[2026-01-18] api-books-009: Implement POST /api/books/paste endpoint
- Created apps/api/api/books/paste.ts with comprehensive paste text handling
- Implemented Zod validation schema (pasteTextSchema):
  - text: required, min 10 chars, max 5MB
  - title: required, max 500 chars, trimmed
  - author: optional/nullable, max 200 chars
  - description: optional/nullable, max 50000 chars
  - genre: optional/nullable, max 100 chars
  - tags: optional array, max 20 tags, each max 50 chars
  - language: optional, exactly 2 characters (ISO code)
  - isPublic: optional boolean, defaults to false
- Implemented tier limit checking:
  - Uses getTierLimits() and isWithinLimit() from @read-master/shared
  - Counts existing non-deleted books for user
  - Returns 403 with upgrade message when limit reached
- Implemented word count and reading time calculation:
  - Uses countWords() and calculateReadingTime() from books.ts service
  - Results stored in Book record
- Implemented excerpt generation:
  - generateExcerpt() function with word-boundary truncation
  - Used when description is not provided
  - Default max length of 500 characters
- Created Book record in database:
  - Uses Prisma db.book.create()
  - Sets source as "PASTED"
  - Sets fileType as "TXT"
  - Returns book data with all fields
- Added comprehensive error handling:
  - Method validation (405 for non-POST)
  - Request body validation with Zod error details
  - User not found (404)
  - Tier limit exceeded (403)
  - Internal server error (500)
- Exported constants for testing:
  - MIN_TEXT_LENGTH (10)
  - MAX_TEXT_LENGTH (5MB)
  - MAX_TITLE_LENGTH (500)
  - MAX_AUTHOR_LENGTH (200)
  - MAX_DESCRIPTION_LENGTH (50000)
  - MAX_GENRE_LENGTH (100)
  - MAX_TAGS_COUNT (20)
  - MAX_TAG_LENGTH (50)
- Created comprehensive tests in apps/api/api/books/paste.test.ts (78 tests):
  - Schema validation tests:
    - text validation (min, max, required, empty, newlines, unicode, HTML)
    - title validation (required, trim, max length, whitespace-only)
    - author validation (valid, null, undefined, max length)
    - description validation (valid, null, undefined, max length)
    - genre validation (valid, null, max length)
    - tags validation (array, empty, max count, max tag length)
    - language validation (2-char code, reject 1-char and 3-char)
    - isPublic validation (true, false, undefined, non-boolean)
    - combined validation (complete input, minimal input, missing fields)
  - Helper function tests:
    - generateExcerpt (under max, truncate at word boundary, no boundaries, empty, default max)
  - Constants tests (verify all constants have reasonable values)
  - Edge cases:
    - Text with newlines, tabs, unicode, HTML tags, special characters
    - Title with numbers, punctuation, unicode
    - generateExcerpt with whitespace-only, very long words, boundary text
  - Comprehensive validation scenarios:
    - Realistic book paste request
    - Technical document paste request
    - Poetry paste request
    - JSON-like content as text
    - Code content as text
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm vitest run (78 new tests)
- Files: apps/api/api/books/paste.ts, apps/api/api/books/paste.test.ts

## Iteration 55

[2026-01-18] api-books-010: Implement GET /api/books/search endpoint
- Created apps/api/api/books/search.ts with comprehensive book search functionality
- Implemented combined search across Google Books and Open Library APIs:
  - searchBothSources() executes parallel requests to both APIs
  - Graceful error handling - if one API fails, results from the other are still returned
  - Source tracking shows which APIs returned results and how many
- Implemented result normalization:
  - normalizeGoogleBook() converts Google Books metadata to common format
  - normalizeOpenLibraryBook() converts Open Library metadata to common format
  - Common SearchResultItem type with id, source, title, authors, description, etc.
  - Cover images use best available quality from each source
- Implemented result deduplication:
  - getDeduplicationKey() generates key from ISBN-13, ISBN-10, or title+author
  - deduplicateResults() removes duplicates, keeping items with more complete data
  - scoreItem() calculates completeness score for comparison
  - Prioritizes items with descriptions, covers, ISBNs, etc.
- Implemented result sorting:
  - sortResults() prioritizes items with cover images
  - Secondary sort by completeness score
  - Tertiary sort by ratings count (popularity)
- Implemented Redis caching:
  - buildCombinedSearchCacheKey() creates consistent cache keys
  - Cache TTL of 15 minutes for combined search results
  - Cache keys include query, offset, limit, language, and source
- Added Zod validation for query parameters:
  - q: required search query (1-500 chars)
  - limit: optional, 1-40, default 10
  - offset: optional, min 0, default 0
  - language: optional 2-char ISO code
  - source: optional enum "all" | "google" | "openlib", default "all"
- Created comprehensive tests in apps/api/api/books/search.test.ts (73 tests):
  - Schema validation tests:
    - Query validation (required, min, max, empty)
    - Limit validation (valid, default, min, max)
    - Offset validation (valid, default, negative)
    - Language validation (2-char code)
    - Source validation (enum values)
    - Combined validation scenarios
  - Normalization tests:
    - Google Books basic and complete metadata
    - Open Library basic and complete metadata
    - Year parsing from publish date
    - Empty authors/categories handling
    - Optional field handling
    - First value selection from arrays
  - Deduplication tests:
    - ISBN-13 based deduplication
    - ISBN-10 based deduplication
    - Title+author based deduplication
    - ISBN hyphen stripping
    - Whitespace normalization
    - Empty authors handling
    - Multiple duplicates
  - Scoring tests:
    - Complete vs minimal items
    - Field weight priority (description, cover > ISBN)
    - hasFullText bonus
  - Sorting tests:
    - Cover image prioritization
    - Score-based sorting
    - Ratings count sorting
  - Cache key tests:
    - Consistency, normalization
    - All parameters included
  - Constants tests
  - Edge cases:
    - Special characters in titles
    - Unicode characters
    - Invalid publish dates
    - Long author lists
    - Empty strings in arrays
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm vitest run (73 new tests)
- Files: apps/api/api/books/search.ts, apps/api/api/books/search.test.ts

## Iteration 56

[2026-01-18] api-books-012: Implement GET /api/books endpoint with filtering and pagination
- Created apps/api/api/books/index.ts with comprehensive book listing functionality
- Implemented query parameter validation with Zod schema:
  - status: Filter by ReadingStatus enum (WANT_TO_READ, READING, COMPLETED, ABANDONED)
  - genre: Filter by genre (case-insensitive matching)
  - tags: Filter by tags (comma-separated string, converts to array, uses hasEvery for all must match)
  - search: Full-text search across title, author, and description (case-insensitive)
  - sort: Multiple sort options (createdAt, updatedAt, title, author, recentlyRead, progress, wordCount)
  - order: Sort direction (asc, desc, defaults to desc)
  - page: Page number with validation (min 1, coerced from string)
  - limit: Items per page (min 1, max 100, default 20, coerced from string)
- Implemented buildWhereClause helper for Prisma query construction:
  - Always includes userId filter for user's books only
  - Always excludes soft-deleted books (deletedAt: null)
  - Adds status filter when provided
  - Adds case-insensitive genre filter
  - Adds tags filter with hasEvery for array matching
  - Adds OR conditions for search across title, author, description
- Implemented buildOrderByClause helper for sorting:
  - Standard fields: createdAt, updatedAt, title
  - Author sorting with null handling (nulls last, secondary sort by title)
  - WordCount sorting with null handling (nulls last, secondary sort by createdAt)
  - RecentlyRead sorting by reading progress count
  - Progress sorting falls back to updatedAt
- Implemented formatBookResponse helper for consistent response format:
  - Includes all book metadata fields
  - Includes reading progress with percentage, position, time, dates
  - Includes chapters count
  - Formats all dates as ISO strings
- Uses sendPaginated response helper for proper pagination metadata
- Created comprehensive tests in apps/api/api/books/index.test.ts (105 tests):
  - Schema validation tests:
    - Status validation (all enum values, invalid values, undefined)
    - Genre validation (valid, max length, undefined)
    - Tags validation (comma-separated parsing, trimming, max count, max length, empty)
    - Search validation (valid, max length, special characters, undefined)
    - Sort validation (all options, default value, invalid)
    - Order validation (asc, desc, default)
    - Page validation (coercion, min value, negative, non-integer, large values)
    - Limit validation (coercion, min/max bounds, default)
    - Combined validation scenarios
  - buildWhereClause tests:
    - Base filters (userId, soft delete exclusion)
    - Status filter addition
    - Genre case-insensitive filter
    - Tags hasEvery filter
    - Search OR conditions
    - Combined filters
  - buildOrderByClause tests:
    - All sort options (createdAt, updatedAt, title, author, wordCount, recentlyRead, progress)
    - Both sort directions
    - Null handling for author and wordCount
  - formatBookResponse tests:
    - Complete book with all fields
    - Book with progress
    - Book without progress (empty readingProgress array)
    - Completed book with completedAt
    - Minimal book with null optional fields
    - Progress with null lastReadAt
  - Constants tests (all limits and valid values)
  - Edge cases:
    - Unicode in search and genre
    - Special characters in search
    - String coercion for page and limit
    - Empty string behavior
- All feedback loops pass: pnpm typecheck, pnpm lint, pnpm vitest run (105 new tests)
- Files: apps/api/api/books/index.ts, apps/api/api/books/index.test.ts
