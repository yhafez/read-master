// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

// =============================================================================
// CORE MODELS - User & Authentication
// =============================================================================

/// User model - Core authentication and profile data
/// Uses Clerk for authentication, stores additional profile info
model User {
  id          String  @id @default(cuid())
  clerkId     String  @unique
  email       String  @unique
  username    String? @unique
  firstName   String?
  lastName    String?
  displayName String? // Public display name
  avatarUrl   String?
  bio         String? @db.Text // User bio for profile

  // Subscription & Tier
  tier                 UserTier  @default(FREE)
  tierExpiresAt        DateTime?
  stripeCustomerId     String?   @unique
  stripeSubscriptionId String?   @unique

  // Admin & Moderation
  role UserRole @default(USER)

  // Preferences stored as JSON for flexibility
  preferences Json @default("{}")

  // Reading level tracking
  readingLevel  String? // e.g., "1200L" for Lexile
  preferredLang String  @default("en")
  timezone      String  @default("UTC") // User's timezone for notifications/reminders

  // Privacy settings
  profilePublic Boolean @default(false)
  showStats     Boolean @default(false)
  showActivity  Boolean @default(false)

  // AI preferences
  aiEnabled Boolean @default(true)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  books                   Book[]
  readingProgress         ReadingProgress[]
  annotations             Annotation[]
  annotationLikes         AnnotationLike[] // Likes on annotations
  assessments             Assessment[]
  flashcards              Flashcard[]
  stats                   UserStats?
  achievements            UserAchievement[]
  challengeParticipations ChallengeParticipant[] // Challenges this user is participating in
  curriculums             Curriculum[] // Curriculums created by this user
  readingLists            ReadingList[] // Personal reading lists created by this user
  curriculumFollows       CurriculumFollow[] // Curriculums this user is following
  filterPresets           FilterPreset[] // Saved library filter presets
  ttsDownloads            TTSDownload[] // TTS audio downloads for books

  // Social relations
  following         Follow[]             @relation("Following") // Users this user follows
  followers         Follow[]             @relation("Followers") // Users who follow this user
  ownedGroups       ReadingGroup[]       @relation("OwnedGroups") // Reading groups created by this user
  groupMemberships  ReadingGroupMember[] @relation("GroupMemberships") // Reading groups this user is a member of
  groupDiscussions  GroupDiscussion[]    @relation("GroupDiscussions") // Discussions created by this user
  discussionReplies DiscussionReply[]    @relation("DiscussionReplies") // Replies created by this user

  // Forum relations
  forumPosts   ForumPost[]  @relation("ForumPosts") // Forum posts created by this user
  forumReplies ForumReply[] @relation("ForumReplies") // Forum replies created by this user
  forumVotes   ForumVote[]  @relation("ForumVotes") // Forum votes cast by this user

  // Email relations
  emails           Email[] // Emails sent to this user
  emailPreferences UserEmailPreferences? // Email preferences

  // Live session relations
  hostedSessions        ReadingSession[]     @relation("HostedSessions") // Sessions this user hosts
  sessionParticipations SessionParticipant[] @relation("SessionParticipations") // Sessions this user participates in
  sessionMessages       SessionMessage[]     @relation("SessionMessages") // Messages sent in sessions

  // Indexes for common queries
  @@index([clerkId])
  @@index([email])
  @@index([username])
  @@index([deletedAt])
  @@index([tier]) // For tier-based queries
  @@index([role]) // For admin/moderation queries
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserTier {
  FREE
  PRO
  SCHOLAR
}

enum UserRole {
  USER // Regular user
  MODERATOR // Can moderate content
  ADMIN // Can manage users and settings
  SUPER_ADMIN // Full system access
}

// =============================================================================
// CONTENT MODELS - Books & Chapters
// =============================================================================

/// Book model - Stores user's books/documents
/// Supports multiple sources: uploads, URLs, paste, external APIs
model Book {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Book metadata
  title       String  @db.VarChar(500)
  author      String? @db.VarChar(200)
  description String? @db.Text
  coverImage  String? // URL or R2 path

  // Source information
  source    BookSource
  sourceId  String? // External API ID (Google Books, Open Library)
  sourceUrl String? // Original URL for URL imports

  // File storage
  filePath String? // R2 path for uploaded files
  fileType FileType?

  // Content metadata
  language          String  @default("en")
  wordCount         Int?
  estimatedReadTime Int? // minutes
  lexileScore       Float?
  rawContent        String? @db.Text // Full text content for search (extracted from file)

  // Organization
  genre String?
  tags  String[] @default([])

  // Status
  status   ReadingStatus @default(WANT_TO_READ)
  isPublic Boolean       @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  chapters         Chapter[]
  readingProgress  ReadingProgress[]
  annotations      Annotation[]
  preReadingGuide  PreReadingGuide?
  assessments      Assessment[]
  flashcards       Flashcard[]
  curriculumItems  CurriculumItem[] // Curriculum items that reference this book
  ttsDownloads     TTSDownload[] // TTS audio downloads for this book
  readingListItems ReadingListItem[] // Reading list items that reference this book

  // Social relations
  readingGroups    ReadingGroup[]    @relation("CurrentGroupBook") // Reading groups currently reading this book
  groupDiscussions GroupDiscussion[] @relation("GroupBookDiscussions") // Discussions about this book
  groupBooks       GroupBook[]       @relation("GroupBooks") // Book club scheduled readings

  // Forum relations
  forumPosts ForumPost[] @relation("ForumBookPosts") // Forum posts about this book

  // Live session relations
  readingSessions ReadingSession[] @relation("SessionBook") // Live reading sessions for this book

  // Indexes for common queries
  @@index([userId])
  @@index([userId, status])
  @@index([userId, deletedAt])
  @@index([deletedAt])
  @@index([source])
  @@index([tags])
  @@index([status]) // Standalone index for filtering by status across all users
  @@index([createdAt]) // For sorting by creation date
}

/// FilterPreset model - Stores saved library filter combinations for users
/// Allows users to save and quickly apply complex filter combinations
model FilterPreset {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Preset metadata
  name        String  @db.VarChar(100) // User-defined name for the preset
  description String? @db.VarChar(500) // Optional description
  isDefault   Boolean @default(false) // Whether this is the user's default filter

  // Filter configuration stored as JSON
  // Contains: status, progress ranges, file types, sources, date ranges, genres, tags, author, sort, order
  filters Json

  // Usage tracking
  useCount Int       @default(0) // Number of times this preset has been applied
  lastUsed DateTime? // Last time this preset was used

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Indexes
  @@index([userId])
  @@index([userId, isDefault])
  @@index([userId, deletedAt])
}

/// Chapter model - Stores chapter/section information for books
/// Used for navigation and progress tracking
model Chapter {
  id     String @id @default(cuid())
  bookId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  title         String? @db.VarChar(500)
  orderIndex    Int // Order within the book (0-indexed)
  startPosition Int // Character offset where chapter starts
  endPosition   Int // Character offset where chapter ends
  wordCount     Int?

  createdAt DateTime @default(now())

  // Indexes
  @@index([bookId])
  @@index([bookId, orderIndex])
}

// =============================================================================
// CONTENT ENUMS
// =============================================================================

/// BookSource - How the book was added to the library
enum BookSource {
  UPLOAD // File uploaded by user
  URL // Imported from URL
  PASTE // Text pasted directly
  GOOGLE_BOOKS // Added from Google Books API
  OPEN_LIBRARY // Added from Open Library API
}

/// FileType - Supported file formats
enum FileType {
  PDF
  EPUB
  DOC
  DOCX
  TXT
  HTML
}

/// ReadingStatus - User's reading status for a book
enum ReadingStatus {
  WANT_TO_READ
  READING
  COMPLETED
  ABANDONED
}

/// AnnotationType - Type of annotation a user can create
enum AnnotationType {
  HIGHLIGHT
  NOTE
  BOOKMARK
}

// =============================================================================
// READING PROGRESS & ANNOTATIONS
// =============================================================================

/// ReadingProgress - Tracks user's reading progress for each book
/// Unique per user+book combination
model ReadingProgress {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Position tracking
  currentPosition Int   @default(0) // Character offset in the text
  percentage      Float @default(0) // 0-100 percentage complete

  // Time tracking
  totalReadTime Int       @default(0) // Total reading time in seconds
  lastReadAt    DateTime?
  startedAt     DateTime  @default(now())
  completedAt   DateTime? // Set when percentage reaches 100

  // Speed tracking
  averageWpm Int? // Average words per minute for this book

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: one progress record per user per book
  @@unique([userId, bookId])
  // Indexes for common queries
  @@index([userId])
  @@index([bookId])
  @@index([userId, lastReadAt])
}

/// Annotation - User annotations on books (highlights, notes, bookmarks)
/// Stores position as character offsets for portability across formats
model Annotation {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Annotation type
  type AnnotationType

  // Position in text (character offsets)
  startOffset Int
  endOffset   Int

  // Content
  selectedText String? @db.Text // The text that was highlighted/annotated
  note         String? @db.Text // User's note (max 5000 chars enforced at app level)
  color        String? @db.VarChar(7) // Hex color code for highlights (e.g., "#FFFF00")

  // Visibility
  isPublic Boolean @default(false) // Can be shared with others

  // Social interactions
  likes AnnotationLike[]

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Indexes for common queries
  @@index([userId])
  @@index([bookId])
  @@index([userId, bookId])
  @@index([userId, type])
  @@index([deletedAt])
  @@index([bookId, startOffset]) // For finding annotations by position
}

model AnnotationLike {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  annotationId String
  annotation   Annotation @relation(fields: [annotationId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([userId, annotationId]) // One like per user per annotation
  @@index([userId])
  @@index([annotationId])
}

// =============================================================================
// PRE-READING GUIDES & ASSESSMENTS
// =============================================================================

/// PreReadingGuide - AI-generated pre-reading guide for a book
/// Contains vocabulary, key arguments, summaries, and contextual information
/// One guide per book (unique bookId)
model PreReadingGuide {
  id     String @id @default(cuid())
  bookId String @unique
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Vocabulary and key concepts (stored as JSON arrays)
  vocabulary       Json @default("[]") // Array of { term, definition, examples }
  keyArguments     Json @default("[]") // Array of { argument, explanation }
  chapterSummaries Json @default("[]") // Array of { chapterIndex, summary }

  // Contextual information (text fields for rich content)
  historicalContext   String? @db.Text // Historical background
  authorContext       String? @db.Text // About the author
  intellectualContext String? @db.Text // Intellectual/philosophical context

  // Additional metadata
  keyThemes        Json @default("[]") // Array of theme strings
  readingTips      Json @default("[]") // Array of tips for reading this book
  discussionTopics Json @default("[]") // Suggested discussion questions

  // AI generation metadata
  generatedAt DateTime @default(now())
  generatedBy String? // AI model version used
  tokensUsed  Int? // Tokens consumed for generation

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([bookId])
}

/// Assessment - Post-reading assessments for comprehension checking
/// Supports multiple assessment types with Bloom's taxonomy breakdown
model Assessment {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Assessment type and scope
  type       AssessmentType
  chapterIds String[]       @default([]) // Specific chapters, empty = whole book

  // Questions and answers (stored as JSON for flexibility)
  questions Json @default("[]") // Array of { id, type, question, options?, correctAnswer, bloomsLevel }
  answers   Json @default("[]") // Array of { questionId, userAnswer, isCorrect, feedback }

  // Scoring
  score          Float? // Overall score (0-100)
  totalQuestions Int    @default(0)
  correctAnswers Int    @default(0)

  // Bloom's Taxonomy breakdown
  bloomsBreakdown Json @default("{}") // { remember: %, understand: %, apply: %, analyze: %, evaluate: %, create: % }

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  timeSpent   Int?      @default(0) // Time spent in seconds

  // AI generation metadata
  generatedBy String? // AI model version used
  tokensUsed  Int? // Tokens consumed for generation

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([userId])
  @@index([bookId])
  @@index([userId, bookId])
  @@index([userId, type])
  @@index([completedAt])
}

/// AssessmentType - Types of assessments available
enum AssessmentType {
  CHAPTER_CHECK // Quick check after reading a chapter
  BOOK_ASSESSMENT // Full book comprehension assessment
  CUSTOM // User-created or teacher-created assessment
}

// =============================================================================
// SPACED REPETITION SYSTEM (SRS) - Flashcards
// =============================================================================

/// FlashcardType - Categories of flashcards
enum FlashcardType {
  VOCABULARY // Word definitions and usage
  CONCEPT // Key concepts from the text
  COMPREHENSION // Understanding-based questions
  QUOTE // Important quotes to remember
  CUSTOM // User-created cards
}

/// FlashcardStatus - Current state in the SRS system
enum FlashcardStatus {
  NEW // Never reviewed
  LEARNING // In initial learning phase
  REVIEW // In regular review cycle
  SUSPENDED // Temporarily removed from rotation
}

/// Flashcard - Spaced repetition flashcard for learning
/// Uses SM-2 algorithm fields for scheduling
model Flashcard {
  id     String  @id @default(cuid())
  userId String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookId String?
  book   Book?   @relation(fields: [bookId], references: [id], onDelete: SetNull)

  // Card content
  front String @db.VarChar(1000) // Question/prompt (max 1000 chars)
  back  String @db.Text // Answer/content (max 5000 chars enforced at app level)

  // Card metadata
  type   FlashcardType   @default(CUSTOM)
  status FlashcardStatus @default(NEW)
  tags   String[]        @default([])

  // Source reference (for auto-generated cards)
  sourceChapterId String? // Chapter the card was generated from
  sourceOffset    Int? // Character offset in the text

  // SM-2 Algorithm fields
  easeFactor  Float    @default(2.5) // Ease factor (minimum 1.3)
  interval    Int      @default(0) // Current interval in days
  repetitions Int      @default(0) // Number of successful repetitions
  dueDate     DateTime @default(now()) // Next review date

  // Statistics
  totalReviews   Int @default(0)
  correctReviews Int @default(0)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete (suspended cards use status, this is for permanent removal)

  // Relations
  reviews FlashcardReview[]

  // Indexes for common queries
  @@index([userId])
  @@index([userId, status])
  @@index([userId, dueDate]) // For fetching due cards
  @@index([userId, bookId])
  @@index([bookId])
  @@index([status])
  @@index([dueDate])
  @@index([deletedAt])
  @@index([tags])
}

/// FlashcardReview - Individual review record for a flashcard
/// Tracks each review session for analytics and history
model FlashcardReview {
  id          String    @id @default(cuid())
  flashcardId String
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  // Review data
  rating         Int // User rating: 1 (Again), 2 (Hard), 3 (Good), 4 (Easy)
  responseTimeMs Int? // Time taken to respond in milliseconds

  // SM-2 state before review (for history/debugging)
  previousEaseFactor  Float
  previousInterval    Int
  previousRepetitions Int

  // SM-2 state after review
  newEaseFactor  Float
  newInterval    Int
  newRepetitions Int

  // Timestamp
  reviewedAt DateTime @default(now())

  // Indexes
  @@index([flashcardId])
  @@index([flashcardId, reviewedAt])
  @@index([reviewedAt])
}

// =============================================================================
// GAMIFICATION - Stats, Achievements, Leaderboards
// =============================================================================

/// UserStats - Aggregated statistics and gamification data for a user
/// One record per user, updated as they use the platform
model UserStats {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // XP and Level
  totalXP Int @default(0) // Total experience points earned
  level   Int @default(1) // Current level (calculated from XP)

  // Streak tracking
  currentStreak    Int       @default(0) // Current consecutive days
  longestStreak    Int       @default(0) // Longest streak ever achieved
  lastActivityDate DateTime? // Last date user was active (for streak calculation)

  // Reading statistics
  booksCompleted   Int  @default(0) // Total books finished
  totalReadingTime Int  @default(0) // Total reading time in seconds
  totalWordsRead   Int  @default(0) // Estimated total words read
  averageWpm       Int? // Average reading speed

  // Flashcard statistics
  totalCardsReviewed Int    @default(0) // Total flashcard reviews
  totalCardsCreated  Int    @default(0) // Total flashcards created
  averageRetention   Float? // Average retention rate (0-1)

  // Assessment statistics
  assessmentsCompleted Int    @default(0) // Total assessments taken
  averageScore         Float? // Average assessment score (0-100)

  // Social statistics
  followersCount Int @default(0) // Number of followers
  followingCount Int @default(0) // Number of users being followed

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for leaderboard queries
  @@index([totalXP]) // XP leaderboard
  @@index([booksCompleted]) // Books completed leaderboard
  @@index([currentStreak]) // Streak leaderboard
  @@index([longestStreak]) // All-time streak leaderboard
  @@index([totalReadingTime]) // Reading time leaderboard
}

/// Achievement - Definition of an achievement that can be earned
/// System-defined achievements with unique codes
model Achievement {
  id   String @id @default(cuid())
  code String @unique // Unique identifier (e.g., "FIRST_BOOK", "STREAK_7")

  // Achievement metadata
  name        String // Display name
  description String              @db.Text // Description of how to earn it
  category    AchievementCategory

  // Requirements (stored as JSON for flexibility)
  criteria Json @default("{}") // e.g., { "booksCompleted": 1 } or { "currentStreak": 7 }

  // Rewards
  xpReward   Int     @default(0) // XP awarded when earned
  badgeIcon  String? // Icon identifier or URL
  badgeColor String? @db.VarChar(7) // Hex color for badge

  // Rarity/ordering
  tier      AchievementTier @default(COMMON)
  sortOrder Int             @default(0)

  // Status
  isActive Boolean @default(true) // Can be disabled without deletion

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userAchievements UserAchievement[]

  // Indexes
  @@index([category])
  @@index([tier])
  @@index([isActive])
  @@index([sortOrder])
}

/// UserAchievement - Junction table tracking which achievements a user has earned
/// Records the timestamp of earning for display and history
model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  // Earning metadata
  earnedAt    DateTime  @default(now())
  notified    Boolean   @default(false) // Has user been notified?
  displayedAt DateTime? // When user first viewed the achievement

  // Unique constraint: each user can only earn each achievement once
  @@unique([userId, achievementId])
  // Indexes
  @@index([userId])
  @@index([achievementId])
  @@index([earnedAt])
  @@index([userId, earnedAt]) // For user's achievement history
}

/// AchievementCategory - Categories for organizing achievements
enum AchievementCategory {
  READING // Reading-related achievements
  LEARNING // Flashcards and learning achievements
  SOCIAL // Social features achievements
  STREAK // Streak-related achievements
  MILESTONE // Major milestones
  SPECIAL // Special/seasonal achievements
}

/// AchievementTier - Rarity tiers for achievements
enum AchievementTier {
  COMMON // Easy to earn
  UNCOMMON // Moderate effort required
  RARE // Significant effort required
  EPIC // Major accomplishment
  LEGENDARY // Exceptional achievement
}

// =============================================================================
// READING CHALLENGES - Gamification and goal-based reading
// =============================================================================

/// Challenge - Reading challenges for users to join and complete
/// Challenges can be time-based or goal-based
model Challenge {
  id String @id @default(cuid())

  // Challenge metadata
  title       String  @db.VarChar(200) // Challenge name
  description String  @db.Text // Challenge description
  icon        String? @db.VarChar(50) // Icon identifier
  badgeColor  String? @db.VarChar(7) // Hex color for badge

  // Challenge type and goals
  type      ChallengeType
  goalType  ChallengeGoalType
  goalValue Int // e.g., 5 books, 10000 minutes, 100000 words
  goalUnit  String            @db.VarChar(50) // e.g., "books", "minutes", "words"

  // Time constraints
  startDate DateTime? // When challenge starts (null = always available)
  endDate   DateTime? // When challenge ends (null = ongoing)
  duration  Int? // Duration in days (for personal challenges)

  // Rewards
  xpReward  Int     @default(0) // XP awarded on completion
  badgeIcon String? // Badge icon for completion

  // Challenge properties
  isOfficial  Boolean         @default(false) // Official Read Master challenge
  isRecurring Boolean         @default(false) // Monthly/yearly recurring challenge
  tier        AchievementTier @default(COMMON)
  visibility  Visibility      @default(PUBLIC)

  // Status
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants ChallengeParticipant[]

  // Indexes
  @@index([type])
  @@index([isOfficial])
  @@index([isActive])
  @@index([startDate, endDate])
}

/// ChallengeParticipant - Users participating in challenges
/// Tracks progress and completion status
model ChallengeParticipant {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  // Progress tracking
  progress    Int       @default(0) // Current progress value
  goalValue   Int // Goal value at time of joining (for personal challenges)
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  startedAt   DateTime  @default(now())

  // Participation metadata
  isPublic Boolean @default(true) // Show on leaderboard
  rank     Int? // Current rank in challenge leaderboard

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: user can only join a challenge once
  @@unique([userId, challengeId])
  // Indexes
  @@index([userId])
  @@index([challengeId])
  @@index([challengeId, isCompleted])
  @@index([challengeId, progress]) // For leaderboard queries
  @@index([userId, isCompleted])
}

/// ChallengeType - Types of challenges
enum ChallengeType {
  OFFICIAL // Official Read Master challenges
  COMMUNITY // Community-created challenges
  PERSONAL // Personal user goals
  SEASONAL // Seasonal/event challenges
}

/// ChallengeGoalType - What metric the challenge tracks
enum ChallengeGoalType {
  BOOKS_READ // Complete X books
  PAGES_READ // Read X pages
  TIME_READING // Read for X minutes
  WORDS_READ // Read X words
  STREAK_DAYS // Maintain X day streak
  BOOKS_IN_GENRE // Read X books in specific genre
  FLASHCARDS_CREATED // Create X flashcards
  ASSESSMENTS_COMPLETED // Complete X assessments
}

// =============================================================================
// CURRICULUM - User-created reading plans and learning paths
// =============================================================================

/// Visibility - Controls who can see content
enum Visibility {
  PRIVATE // Only owner can see
  UNLISTED // Anyone with link can see
  PUBLIC // Visible in browse/search
}

/// Curriculum - A curated reading plan/learning path
/// Can be created by Pro/Scholar users and shared with others
model Curriculum {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Curriculum metadata
  title       String  @db.VarChar(200) // Title of the curriculum
  description String  @db.Text // Description of the learning path
  coverImage  String? // Optional cover image URL

  // Categorization
  category   String?  @db.VarChar(100) // e.g., "Philosophy", "Science", "History"
  tags       String[] @default([])
  difficulty String?  @db.VarChar(50) // e.g., "Beginner", "Intermediate", "Advanced"

  // Visibility settings
  visibility Visibility @default(PRIVATE)
  isOfficial Boolean    @default(false) // Official Read Master templates

  // Statistics (denormalized for performance)
  totalItems     Int @default(0) // Number of items in curriculum
  followersCount Int @default(0) // Number of users following this curriculum

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  items     CurriculumItem[]
  followers CurriculumFollow[]

  // Indexes
  @@index([userId])
  @@index([userId, visibility])
  @@index([visibility]) // For browsing public curriculums
  @@index([category])
  @@index([deletedAt])
  @@index([followersCount]) // For popularity sorting
  @@index([tags])
}

/// CurriculumItem - An item within a curriculum (book, external resource, etc.)
/// Maintains order within the curriculum
model CurriculumItem {
  id           String     @id @default(cuid())
  curriculumId String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  // Item ordering
  orderIndex Int // Order within the curriculum (0-indexed)

  // Item content - can reference a book or be an external resource
  bookId String? // Optional reference to a book in the system
  book   Book?   @relation(fields: [bookId], references: [id], onDelete: SetNull)

  // For external resources not in the system
  externalTitle  String? @db.VarChar(500) // Title of external resource
  externalAuthor String? @db.VarChar(200) // Author of external resource
  externalUrl    String? // URL to external resource
  externalIsbn   String? @db.VarChar(20) // ISBN for books not in system

  // Item-specific notes from curator
  notes String? @db.Text // Curator's notes/instructions for this item

  // Estimated time to complete
  estimatedTime Int? // Estimated time in minutes

  // Status
  isOptional Boolean @default(false) // Optional items in the curriculum

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([curriculumId])
  @@index([curriculumId, orderIndex])
  @@index([bookId])
}

/// CurriculumFollow - Tracks users following a curriculum
/// Junction table with progress tracking
model CurriculumFollow {
  id           String     @id @default(cuid())
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  curriculumId String
  curriculum   Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  // Progress tracking
  currentItemIndex Int       @default(0) // Current item index in curriculum
  completedItems   Int       @default(0) // Number of items completed
  lastProgressAt   DateTime? // Last time progress was updated
  startedAt        DateTime  @default(now()) // When user started following
  completedAt      DateTime? // When user completed the curriculum

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: each user can only follow a curriculum once
  @@unique([userId, curriculumId])
  // Indexes
  @@index([userId])
  @@index([curriculumId])
  @@index([userId, completedAt]) // For finding completed/in-progress curriculums
}

// =============================================================================
// SOCIAL FEATURES - Following, Reading Groups, Discussions
// =============================================================================

// =============================================================================
// AI SOCIAL RECOMMENDATIONS
// =============================================================================

/// UserSimilarity - Stores similarity scores between users
/// Calculated based on reading history, genres, preferences
model UserSimilarity {
  id      String @id @default(cuid())
  userId1 String
  userId2 String

  // Similarity score (0.0 to 1.0)
  score Float

  // Breakdown of similarity factors (stored as JSON)
  // { readingHistory: 0.4, genres: 0.3, readingSpeed: 0.2, annotations: 0.1 }
  factors Json @default("{}")

  // Last calculation timestamp
  lastCalculated DateTime @default(now())

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: one similarity record per user pair
  @@unique([userId1, userId2])
  // Indexes for efficient queries
  @@index([userId1])
  @@index([userId2])
  @@index([score])
  @@index([userId1, score])
  @@index([userId2, score])
  @@index([lastCalculated])
}

/// BookRecommendation - AI-generated book recommendations for users
/// Based on social connections, reading history, and AI analysis
model BookRecommendation {
  id     String @id @default(cuid())
  userId String

  // Book information (can be from database or external)
  bookId        String? // Reference to Book if in our system
  externalBookId String? // ISBN or external API ID
  bookTitle     String  @db.VarChar(500)
  bookAuthor    String? @db.VarChar(200)
  bookCoverUrl  String?

  // Recommendation details
  reason        String @db.Text // AI-generated explanation for the recommendation
  score         Float  // Recommendation confidence score (0.0 to 1.0)
  source        RecommendationSource // How the recommendation was generated
  sourceUserId  String? // If from social, which user inspired it

  // User interaction
  dismissed    Boolean   @default(false) // User dismissed this recommendation
  dismissedAt  DateTime?
  viewed       Boolean   @default(false) // User has seen this recommendation
  viewedAt     DateTime?
  clicked      Boolean   @default(false) // User clicked for more info
  clickedAt    DateTime?
  addedToLibrary Boolean @default(false) // User added to their library
  addedAt      DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime? // When the recommendation should expire

  // Indexes
  @@index([userId])
  @@index([userId, dismissed])
  @@index([userId, source])
  @@index([score])
  @@index([createdAt])
  @@index([expiresAt])
  @@index([sourceUserId])
  @@index([bookId])
}

/// RecommendationSource - How the recommendation was generated
enum RecommendationSource {
  SOCIAL // Based on similar users' reading
  AI // AI analysis of user's preferences
  TRENDING // Popular in user's network
  FOLLOWING // From users the person follows
  GROUP // From reading groups
  CURRICULUM // From followed curriculums
}

/// Follow - User following relationship
/// Allows users to follow other users' public activity
model Follow {
  id          String @id @default(cuid())
  followerId  String // The user who is following
  follower    User   @relation("Following", fields: [followerId], references: [id], onDelete: Cascade)
  followingId String // The user being followed
  following   User   @relation("Followers", fields: [followingId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  // Unique constraint: prevent duplicate follows
  @@unique([followerId, followingId])
  // Indexes for efficient queries
  @@index([followerId])
  @@index([followingId])
  @@index([followerId, followingId]) // Compound index for efficient relationship lookups
  @@index([createdAt])
}

/// GroupRole - Role of a member within a reading group
enum GroupRole {
  OWNER // Creator of the group, full permissions
  ADMIN // Can manage members and discussions
  MEMBER // Regular member
}

/// ReadingGroup - Book clubs and reading groups
/// Allows users to form groups around shared reading interests
model ReadingGroup {
  id     String @id @default(cuid())
  userId String // Creator/owner of the group
  user   User   @relation("OwnedGroups", fields: [userId], references: [id], onDelete: Cascade)

  // Group metadata
  name        String  @db.VarChar(200) // Group name
  description String? @db.Text // Group description
  coverImage  String? // Optional cover image URL

  // Visibility and settings
  isPublic   Boolean @default(true) // Can anyone join, or invite-only
  maxMembers Int?    @default(50) // Maximum number of members (null = unlimited)
  inviteCode String? @unique // Unique invite code for private groups

  // Current book being read (optional)
  currentBookId String?
  currentBook   Book?   @relation("CurrentGroupBook", fields: [currentBookId], references: [id], onDelete: SetNull)

  // Statistics (denormalized)
  membersCount     Int @default(1) // Includes owner
  discussionsCount Int @default(0)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  members     ReadingGroupMember[]
  discussions GroupDiscussion[]
  groupBooks  GroupBook[] // Books scheduled for the group to read

  // Indexes
  @@index([userId])
  @@index([isPublic])
  @@index([deletedAt])
  @@index([membersCount])
  @@index([createdAt])
}

/// GroupBook - Books scheduled for a reading group
/// Tracks the reading schedule for each book in the group
model GroupBook {
  id      String       @id @default(cuid())
  groupId String
  group   ReadingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  bookId  String
  book    Book         @relation("GroupBooks", fields: [bookId], references: [id], onDelete: Cascade)

  // Schedule
  startDate  DateTime? // When the group starts reading this book
  endDate    DateTime? // Target completion date
  targetPage Int? // Current target page for the group
  status     GroupBookStatus @default(UPCOMING) // Reading status

  // Order in the reading list
  orderIndex Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: each book can only be in a group's list once
  @@unique([groupId, bookId])
  // Indexes
  @@index([groupId])
  @@index([bookId])
  @@index([groupId, status])
  @@index([groupId, orderIndex])
  @@index([startDate])
  @@index([endDate])
}

/// GroupBookStatus - Status of a book in a reading group
enum GroupBookStatus {
  UPCOMING // Scheduled to read in the future
  CURRENT // Currently being read by the group
  COMPLETED // Finished reading
  SKIPPED // Decided not to read
}

/// ReadingGroupMember - Membership in a reading group
/// Junction table with role information
model ReadingGroupMember {
  id      String       @id @default(cuid())
  groupId String
  group   ReadingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId  String
  user    User         @relation("GroupMemberships", fields: [userId], references: [id], onDelete: Cascade)

  // Membership details
  role     GroupRole @default(MEMBER)
  joinedAt DateTime  @default(now())

  // Member settings
  notificationsEnabled Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: each user can only be in a group once
  @@unique([groupId, userId])
  // Indexes
  @@index([groupId])
  @@index([userId])
  @@index([groupId, role])
}

/// GroupDiscussion - Discussion thread within a reading group
/// Supports book-specific or general discussions
model GroupDiscussion {
  id      String       @id @default(cuid())
  groupId String
  group   ReadingGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId  String // Author of the discussion
  user    User         @relation("GroupDiscussions", fields: [userId], references: [id], onDelete: Cascade)

  // Discussion content
  title   String @db.VarChar(300) // Discussion title
  content String @db.Text // Initial post content

  // Optional book reference
  bookId String?
  book   Book?   @relation("GroupBookDiscussions", fields: [bookId], references: [id], onDelete: SetNull)

  // Discussion metadata
  isPinned Boolean @default(false) // Pinned at top of group
  isLocked Boolean @default(false) // Prevent new replies

  // Scheduled discussion support
  scheduledAt DateTime? // When the discussion is scheduled to take place (null = immediate)
  isScheduled Boolean   @default(false) // Whether this is a scheduled discussion

  // Statistics (denormalized)
  repliesCount Int       @default(0)
  lastReplyAt  DateTime?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  replies DiscussionReply[]

  // Indexes
  @@index([groupId])
  @@index([userId])
  @@index([bookId])
  @@index([groupId, isPinned])
  @@index([groupId, lastReplyAt])
  @@index([groupId, scheduledAt]) // For calendar view of scheduled discussions
  @@index([scheduledAt]) // For finding upcoming discussions across all groups
  @@index([deletedAt])
}

/// DiscussionReply - Reply to a group discussion
/// Supports nested replies for threaded discussions
model DiscussionReply {
  id           String          @id @default(cuid())
  discussionId String
  discussion   GroupDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  userId       String // Author of the reply
  user         User            @relation("DiscussionReplies", fields: [userId], references: [id], onDelete: Cascade)

  // Reply content
  content String @db.Text

  // Nested reply support
  parentReplyId String? // For nested replies (null = top-level reply)
  parentReply   DiscussionReply?  @relation("NestedReplies", fields: [parentReplyId], references: [id], onDelete: Cascade)
  childReplies  DiscussionReply[] @relation("NestedReplies")

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Indexes
  @@index([discussionId])
  @@index([userId])
  @@index([parentReplyId])
  @@index([discussionId, createdAt])
  @@index([deletedAt])
}

// =============================================================================
// FORUM - Community Discussion Forum
// =============================================================================

/// ForumCategory - Categories for organizing forum posts
/// Provides structure for community discussions
model ForumCategory {
  id   String @id @default(cuid())
  slug String @unique // URL-friendly identifier (e.g., "general-discussion")

  // Category metadata
  name        String  @db.VarChar(100) // Display name
  description String? @db.Text // Category description
  icon        String? // Icon identifier or URL
  color       String? @db.VarChar(7) // Hex color for category badge

  // Category settings
  sortOrder     Int      @default(0) // Order in category list
  isActive      Boolean  @default(true) // Can posts be created here?
  isLocked      Boolean  @default(false) // Prevent new posts
  minTierToPost UserTier @default(FREE) // Minimum tier to post in this category

  // Statistics (denormalized)
  postsCount       Int       @default(0)
  lastPostAt       DateTime?
  lastPostId       String?
  lastPostAuthorId String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  posts ForumPost[]

  // Indexes
  @@index([slug])
  @@index([sortOrder])
  @@index([isActive])
  @@index([lastPostAt])
}

/// ForumPost - A post/topic in the forum
/// Supports voting, view tracking, and soft delete
model ForumPost {
  id         String        @id @default(cuid())
  categoryId String
  category   ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  userId     String
  user       User          @relation("ForumPosts", fields: [userId], references: [id], onDelete: Cascade)

  // Post content
  title   String @db.VarChar(200) // Post title (3-200 chars enforced at app level)
  content String @db.Text // Post content (10-50000 chars enforced at app level)

  // Image attachments (stored as JSON array of URLs)
  imageUrls Json @default("[]") // Array of R2 image URLs

  // Optional book reference (for book-specific discussions)
  bookId String?
  book   Book?   @relation("ForumBookPosts", fields: [bookId], references: [id], onDelete: SetNull)

  // Post metadata
  isPinned   Boolean @default(false) // Pinned at top of category
  isLocked   Boolean @default(false) // Prevent new replies
  isFeatured Boolean @default(false) // Featured post
  isAnswered Boolean @default(false) // Has accepted answer (for Q&A posts)

  // Voting fields
  upvotes   Int @default(0)
  downvotes Int @default(0)
  voteScore Int @default(0) // upvotes - downvotes (denormalized for sorting)

  // Statistics
  viewCount    Int       @default(0)
  repliesCount Int       @default(0)
  lastReplyAt  DateTime?
  lastReplyId  String? // ID of last reply for quick access

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  replies ForumReply[]
  votes   ForumVote[]  @relation("PostVotes")

  // Indexes
  @@index([categoryId])
  @@index([userId])
  @@index([bookId])
  @@index([categoryId, isPinned])
  @@index([categoryId, voteScore])
  @@index([categoryId, createdAt])
  @@index([categoryId, lastReplyAt])
  @@index([voteScore])
  @@index([viewCount])
  @@index([deletedAt])
  @@index([createdAt])
}

/// ForumReply - A reply to a forum post
/// Supports nested replies and voting
model ForumReply {
  id     String    @id @default(cuid())
  postId String
  post   ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId String
  user   User      @relation("ForumReplies", fields: [userId], references: [id], onDelete: Cascade)

  // Reply content
  content String @db.Text // Reply content

  // Image attachments (stored as JSON array of URLs)
  imageUrls Json @default("[]") // Array of R2 image URLs

  // Nested reply support
  parentReplyId String? // For nested replies (null = top-level reply)
  parentReply   ForumReply?  @relation("NestedForumReplies", fields: [parentReplyId], references: [id], onDelete: Cascade)
  childReplies  ForumReply[] @relation("NestedForumReplies")

  // Reply metadata
  isBestAnswer Boolean @default(false) // Marked as best answer by OP
  isEdited     Boolean @default(false) // Has been edited

  // Voting fields
  upvotes   Int @default(0)
  downvotes Int @default(0)
  voteScore Int @default(0) // upvotes - downvotes

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  votes ForumVote[] @relation("ReplyVotes")

  // Indexes
  @@index([postId])
  @@index([userId])
  @@index([parentReplyId])
  @@index([postId, createdAt])
  @@index([postId, voteScore])
  @@index([voteScore])
  @@index([isBestAnswer])
  @@index([deletedAt])
}

/// ForumVote - Vote on a post or reply
/// Supports upvote (+1) and downvote (-1)
model ForumVote {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("ForumVotes", fields: [userId], references: [id], onDelete: Cascade)

  // Vote target (one of these must be set)
  postId  String?
  post    ForumPost?  @relation("PostVotes", fields: [postId], references: [id], onDelete: Cascade)
  replyId String?
  reply   ForumReply? @relation("ReplyVotes", fields: [replyId], references: [id], onDelete: Cascade)

  // Vote value: 1 for upvote, -1 for downvote
  value Int // 1 or -1

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraints: one vote per user per post/reply
  @@unique([userId, postId])
  @@unique([userId, replyId])
  // Indexes
  @@index([userId])
  @@index([postId])
  @@index([replyId])
  @@index([value])
}

// =============================================================================
// SYSTEM MODELS - AI Usage & Audit Logging
// =============================================================================

/// AIUsageLog - Tracks all AI API operations for cost monitoring and quota enforcement
/// Essential for billing, analytics, and rate limiting
model AIUsageLog {
  id     String  @id @default(cuid())
  userId String? // Optional: some operations may be system-level

  // Operation details
  operation String // e.g., "pre_reading_guide", "explain", "assessment", "flashcards", "grade_answer"
  model     String // e.g., "claude-3-5-sonnet-20241022", "gpt-4o"
  provider  String // e.g., "anthropic", "openai"

  // Token usage
  promptTokens     Int // Tokens in the prompt
  completionTokens Int // Tokens in the response
  totalTokens      Int // Total tokens (prompt + completion)

  // Cost tracking (using Decimal for precision)
  cost Decimal @db.Decimal(10, 6) // Cost in USD (e.g., 0.001234)

  // Performance metrics
  durationMs Int // Time taken for the API call in milliseconds
  success    Boolean @default(true) // Whether the operation succeeded

  // Request context
  bookId    String? // Optional: related book if applicable
  requestId String? // Optional: for correlating with logs

  // Error tracking (if failed)
  errorCode    String? // Error code if failed
  errorMessage String? @db.Text // Error message if failed

  // Metadata (for additional context)
  metadata Json @default("{}") // Additional operation-specific data

  // Timestamp
  createdAt DateTime @default(now())

  // Indexes for analytics and billing queries
  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([operation])
  @@index([provider])
  @@index([success])
  @@index([bookId])
}

/// DailyAnalytics - Time-series data for platform analytics
/// Stores aggregated daily metrics for admin dashboard and reporting
model DailyAnalytics {
  id   String   @id @default(cuid())
  date DateTime @unique @db.Date // Unique date for analytics (one record per day)

  // User metrics
  totalUsers   Int @default(0) // Total registered users (cumulative)
  activeUsers  Int @default(0) // Users active on this day
  newUsers     Int @default(0) // New registrations on this day
  churned      Int @default(0) // Users who churned on this day
  freeUsers    Int @default(0) // Total free tier users
  proUsers     Int @default(0) // Total pro tier users
  scholarUsers Int @default(0) // Total scholar tier users

  // Revenue metrics (in cents to avoid floating point issues)
  totalRevenueCents     Int @default(0) // Total revenue on this day in cents
  newSubscriptionsCents Int @default(0) // Revenue from new subscriptions
  renewalsCents         Int @default(0) // Revenue from renewals
  upgradesCents         Int @default(0) // Revenue from upgrades
  refundsCents          Int @default(0) // Refunds issued

  // Engagement metrics
  booksAdded          Int @default(0) // Books added on this day
  booksCompleted      Int @default(0) // Books marked completed
  totalReadingTimeMin Int @default(0) // Total reading time in minutes across all users
  assessmentsTaken    Int @default(0) // Assessments completed
  flashcardsCreated   Int @default(0) // New flashcards created
  flashcardsReviewed  Int @default(0) // Flashcard reviews on this day
  annotationsCreated  Int @default(0) // New annotations created
  forumPostsCreated   Int @default(0) // New forum posts
  forumRepliesCreated Int @default(0) // New forum replies
  groupsCreated       Int @default(0) // New reading groups created
  curriculumsCreated  Int @default(0) // New curriculums created

  // AI usage metrics
  aiRequestsCount     Int @default(0) // Total AI API requests
  aiTokensUsed        Int @default(0) // Total tokens used
  aiCostCents         Int @default(0) // Total AI cost in cents
  preReadingGuidesGen Int @default(0) // Pre-reading guides generated
  explanationsGen     Int @default(0) // Explanations generated
  assessmentsGen      Int @default(0) // AI assessments generated
  flashcardsGen       Int @default(0) // AI flashcards generated

  // Performance metrics
  avgPageLoadMs    Int? // Average page load time in milliseconds
  avgApiResponseMs Int? // Average API response time
  errorCount       Int  @default(0) // Number of errors logged
  p99ResponseMs    Int? // 99th percentile response time

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes for efficient date range queries
  @@index([date])
  @@index([createdAt])
}

/// AuditLog - Tracks important user and system actions for security and compliance
/// Used for change history, security auditing, and debugging
model AuditLog {
  id     String  @id @default(cuid())
  userId String? // Optional: system actions may not have a user

  // Action details
  action     String // e.g., "CREATE", "UPDATE", "DELETE", "LOGIN", "EXPORT"
  entityType String // e.g., "Book", "User", "Flashcard", "Assessment"
  entityId   String? // ID of the affected entity

  // Change details
  previousValue Json? // Previous state (for updates/deletes)
  newValue      Json? // New state (for creates/updates)

  // Request context
  ipAddress String? // Client IP address
  userAgent String? @db.Text // Browser/client info
  requestId String? // For correlating with logs
  sessionId String? // Clerk session ID if applicable

  // Metadata
  metadata Json @default("{}") // Additional context (e.g., bulk operation details)

  // Timestamp
  createdAt DateTime @default(now())

  // Indexes for security auditing and queries
  @@index([userId])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([entityType])
  @@index([entityType, entityId])
  @@index([action])
  @@index([entityType, action])
}

// =============================================================================
// READING LISTS - Personal Collections
// =============================================================================

/// ReadingList - Personal, ordered, shareable collections of books
/// Users can create custom lists like "Summer Reading", "Classics", etc.
model ReadingList {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // List metadata
  name        String  @db.VarChar(200)
  description String? @db.Text
  coverImage  String? // Optional cover image URL

  // Visibility and sharing
  isPublic  Boolean @default(false) // Can others view this list
  shareCode String? @unique // Unique code for sharing (e.g., "abc123")

  // Statistics (denormalized)
  itemsCount Int @default(0)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  items ReadingListItem[]

  // Indexes
  @@index([userId])
  @@index([isPublic])
  @@index([deletedAt])
  @@index([createdAt])
}

/// ReadingListItem - Books in a reading list with ordering
/// Junction table with additional metadata
model ReadingListItem {
  id     String      @id @default(cuid())
  listId String
  list   ReadingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  bookId String
  book   Book        @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Ordering within the list
  orderIndex Int // 0-indexed position in the list

  // Optional notes for this book in this list
  notes String? @db.Text

  // Timestamp
  addedAt DateTime @default(now())

  // Unique constraint: one book per list
  @@unique([listId, bookId])
  // Indexes
  @@index([listId])
  @@index([bookId])
  @@index([listId, orderIndex])
}

/// TTSDownload model - Tracks text-to-speech audio download jobs
/// Enables Pro/Scholar users to download full book audio for offline listening
model TTSDownload {
  id String @id @default(cuid())

  // User and Book reference
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookId String
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Book metadata (denormalized for convenience)
  bookTitle String @db.VarChar(500)

  // Download status
  status DownloadStatus @default(PENDING)

  // TTS configuration
  provider TTSProvider
  voice    String      @db.VarChar(100)
  format   AudioFormat @default(MP3)

  // Processing details
  totalChunks     Int @default(0)
  processedChunks Int @default(0)
  totalCharacters Int @default(0)

  // Cost tracking
  estimatedCost Float @default(0)
  actualCost    Float @default(0)

  // File details (populated when completed)
  fileKey  String? @db.VarChar(500) // R2 storage key
  fileSize Int? // File size in bytes

  // Download URL (signed, temporary)
  downloadUrl String? @db.Text

  // Error handling
  errorMessage String? @db.Text

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime? // When processing finished
  expiresAt   DateTime // Download link expiration (30 days from creation)

  // Soft delete
  deletedAt DateTime?

  // Indexes for efficient queries
  @@index([userId])
  @@index([bookId])
  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([status])
  @@index([expiresAt])
  @@index([deletedAt])
}

/// Enum for TTSDownload status
enum DownloadStatus {
  PENDING // Queued for processing
  PROCESSING // Currently generating audio
  COMPLETED // Successfully completed
  FAILED // Processing failed
  CANCELLED // User cancelled
}

/// Enum for TTS providers
enum TTSProvider {
  WEB_SPEECH // Free tier (client-side, not downloadable)
  OPENAI // Pro tier (OpenAI TTS)
  ELEVENLABS // Scholar tier (ElevenLabs)
}

/// Enum for audio formats
enum AudioFormat {
  MP3
  OPUS
  AAC
  FLAC
  WAV
  PCM
}

// =============================================================================
// EMAIL MODELS - Email Marketing & Transactional Emails
// =============================================================================

/// EmailTemplate model - Store reusable email templates
model EmailTemplate {
  id String @id @default(cuid())

  // Template identification
  name        String  @unique @db.VarChar(100) // e.g., "welcome", "streak_7_days"
  subject     String  @db.VarChar(200) // Email subject line (can include {{variables}})
  description String? @db.Text // Internal description

  // Template content
  htmlBody String @db.Text // HTML version with {{handlebars}} syntax
  textBody String @db.Text // Plain text version

  // SendGrid integration
  sendgridTemplateId String? @unique @db.VarChar(100) // SendGrid dynamic template ID (if using their templates)

  // Template metadata
  category EmailCategory // welcome, engagement, conversion, etc.
  isActive Boolean       @default(true) // Can be disabled without deletion

  // Usage tracking
  sentCount Int @default(0) // How many times this template has been used

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  // Relations
  emails Email[]

  // Indexes
  @@index([name])
  @@index([category])
  @@index([isActive])
  @@index([deletedAt])
}

/// Email model - Track all sent emails for analytics and debugging
model Email {
  id String @id @default(cuid())

  // Recipient information
  userId  String
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  toEmail String  @db.VarChar(255) // Recipient email (denormalized for convenience)
  toName  String? @db.VarChar(200) // Recipient name

  // Email content
  templateId String?
  template   EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  subject    String         @db.VarChar(200)
  htmlBody   String         @db.Text
  textBody   String         @db.Text

  // Categorization
  category EmailCategory
  tags     String[] // Additional tags for filtering: ["onboarding", "day_1"]

  // SendGrid tracking
  sendgridMessageId String? @unique @db.VarChar(255) // SendGrid message ID for webhook matching
  sendgridStatus    String? @db.VarChar(50) // processed, delivered, opened, clicked, etc.

  // Email events (tracked via webhooks)
  sentAt      DateTime? // When sent to SendGrid
  deliveredAt DateTime? // When delivered to recipient
  openedAt    DateTime? // First open
  clickedAt   DateTime? // First click
  bouncedAt   DateTime? // If bounced
  failedAt    DateTime? // If failed to send

  // Open/click tracking
  openCount        Int @default(0) // Number of times opened
  clickCount       Int @default(0) // Number of links clicked
  uniqueClickCount Int @default(0) // Number of unique links clicked

  // Error handling
  errorMessage String? @db.Text
  bounceReason String? @db.Text // Bounce/failure reason

  // Unsubscribe tracking
  unsubscribedAt DateTime?

  // Metadata (JSON for flexibility)
  metadata Json @default("{}") // Store template variables, campaign info, etc.

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete
  deletedAt DateTime?

  // Indexes for efficient queries
  @@index([userId])
  @@index([toEmail])
  @@index([templateId])
  @@index([category])
  @@index([sendgridMessageId])
  @@index([sendgridStatus])
  @@index([sentAt])
  @@index([deliveredAt])
  @@index([openedAt])
  @@index([userId, category])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([deletedAt])
}

/// Enum for email categories
enum EmailCategory {
  TRANSACTIONAL // Immediate, user-triggered (password reset, verification)
  WELCOME // Welcome series
  ONBOARDING // Onboarding sequence
  ENGAGEMENT // Re-engagement, streaks, achievements
  CONVERSION // Upgrade prompts, feature discovery
  DIGEST // Weekly/monthly summaries
  ANNOUNCEMENT // Product updates, newsletters
  SYSTEM // Admin alerts, errors
}

/// User model extension for email tracking
model UserEmailPreferences {
  id String @id @default(cuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Global opt-out
  emailEnabled Boolean @default(true)

  // Category preferences
  marketingEmails      Boolean @default(true) // General marketing
  productUpdates       Boolean @default(true) // Product announcements
  weeklyDigest         Boolean @default(true) // Weekly progress summary
  achievementEmails    Boolean @default(true) // Streaks, milestones
  recommendationEmails Boolean @default(true) // Book recommendations
  socialEmails         Boolean @default(true) // Comments, likes, follows

  // Frequency preferences
  digestFrequency String @default("weekly") // weekly, biweekly, monthly, never

  // Unsubscribe tracking
  unsubscribedAt   DateTime?
  unsubscribeToken String?   @unique @db.VarChar(100) // For one-click unsubscribe

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Indexes
  @@index([userId])
  @@index([emailEnabled])
  @@index([unsubscribeToken])
}

// =============================================================================
// LIVE READING SESSIONS - Real-time collaborative reading
// =============================================================================

/// ReadingSession - Live reading session for collaborative reading
/// Allows users to read together in real-time with synchronized page turns
model ReadingSession {
  id String @id @default(cuid())

  // Host user who started the session
  hostId String
  host   User   @relation("HostedSessions", fields: [hostId], references: [id], onDelete: Cascade)

  // Book being read
  bookId String
  book   Book   @relation("SessionBook", fields: [bookId], references: [id], onDelete: Cascade)

  // Session details
  title       String  @db.VarChar(200) // Session title
  description String? @db.Text // Optional description

  // Session state
  status       SessionStatus @default(SCHEDULED) // scheduled, active, paused, ended
  currentPage  Int           @default(0) // Current page the group is on
  currentSpeed Float? // Reading speed for pacing

  // Timing
  scheduledAt DateTime? // When the session is scheduled to start
  startedAt   DateTime? // When the session actually started
  endedAt     DateTime? // When the session ended

  // Limits and settings
  maxParticipants Int     @default(50) // Maximum participants allowed
  isPublic        Boolean @default(true) // Can anyone join, or invite-only
  inviteCode      String? @unique // Unique invite code for private sessions
  allowChat       Boolean @default(true) // Whether chat is enabled
  syncEnabled     Boolean @default(true) // Whether page sync is enabled

  // Statistics (denormalized)
  participantCount   Int    @default(0)
  peakParticipants   Int    @default(0) // Highest participant count during session
  totalMessages      Int    @default(0)
  totalPageTurns     Int    @default(0)
  avgEngagementScore Float? // Calculated engagement metric

  // Recording
  isRecorded  Boolean @default(false) // Whether to record for replay
  recordingId String? // Reference to recording if recorded

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Relations
  participants SessionParticipant[]
  messages     SessionMessage[]
  pageEvents   SessionPageEvent[]

  // Indexes
  @@index([hostId])
  @@index([bookId])
  @@index([status])
  @@index([scheduledAt])
  @@index([startedAt])
  @@index([isPublic])
  @@index([deletedAt])
  @@index([inviteCode])
}

/// SessionStatus - Status of a reading session
enum SessionStatus {
  SCHEDULED // Session is scheduled for the future
  ACTIVE // Session is currently active
  PAUSED // Session is temporarily paused
  ENDED // Session has ended
  CANCELLED // Session was cancelled before starting
}

/// SessionParticipant - Users participating in a reading session
/// Tracks join/leave times and activity
model SessionParticipant {
  id        String         @id @default(cuid())
  sessionId String
  session   ReadingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User           @relation("SessionParticipations", fields: [userId], references: [id], onDelete: Cascade)

  // Participation status
  isActive    Boolean @default(true) // Currently in the session
  isHost      Boolean @default(false) // Is this the host
  isModerator Boolean @default(false) // Can moderate chat
  isMuted     Boolean @default(false) // Chat muted by moderator

  // Activity tracking
  currentPage Int      @default(0) // Participant's current page (if not synced)
  isSynced    Boolean  @default(true) // Following host's page
  lastActive  DateTime @default(now()) // Last activity timestamp

  // Join/leave tracking
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  // Statistics
  messagesCount  Int @default(0) // Messages sent during session
  pageViewsCount Int @default(0) // Pages viewed

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique constraint: one participation record per user per session
  @@unique([sessionId, userId])
  // Indexes
  @@index([sessionId])
  @@index([userId])
  @@index([sessionId, isActive])
  @@index([joinedAt])
}

/// SessionMessage - Chat messages in a reading session
/// Real-time chat during collaborative reading
model SessionMessage {
  id        String         @id @default(cuid())
  sessionId String
  session   ReadingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String
  user      User           @relation("SessionMessages", fields: [userId], references: [id], onDelete: Cascade)

  // Message content
  content String             @db.VarChar(2000) // Message content (max 2000 chars)
  type    SessionMessageType @default(CHAT) // chat, system, highlight, question

  // Optional reference to a specific page/position
  pageNumber Int? // Page the message references
  textOffset Int? // Character offset if highlighting

  // Reactions (stored as JSON for flexibility)
  reactions Json @default("{}") // { "": ["userId1", "userId2"], "": ["userId3"] }

  // Moderation
  isHidden Boolean   @default(false) // Hidden by moderator
  hiddenBy String? // User ID of moderator who hid it
  hiddenAt DateTime?

  // Timestamps
  createdAt DateTime  @default(now())
  deletedAt DateTime? // Soft delete

  // Indexes
  @@index([sessionId])
  @@index([userId])
  @@index([sessionId, createdAt])
  @@index([type])
  @@index([deletedAt])
}

/// SessionMessageType - Types of messages in a session
enum SessionMessageType {
  CHAT // Regular chat message
  SYSTEM // System notification (joined, left, page turned)
  HIGHLIGHT // Shared highlight
  QUESTION // Question for discussion
  ANNOTATION // Shared annotation
}

/// SessionPageEvent - Page turn and navigation events
/// For recording and analytics
model SessionPageEvent {
  id        String         @id @default(cuid())
  sessionId String
  session   ReadingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId    String? // Null for system-triggered events

  // Event details
  eventType   PageEventType
  fromPage    Int?
  toPage      Int
  triggeredBy String? // "host", "system", or userId

  // Timestamp
  createdAt DateTime @default(now())

  // Indexes
  @@index([sessionId])
  @@index([sessionId, createdAt])
  @@index([eventType])
}

/// PageEventType - Types of page events
enum PageEventType {
  TURN // Normal page turn
  JUMP // Jump to specific page
  SYNC // Sync to host's page
  START // Session started at page
  END // Session ended at page
}
